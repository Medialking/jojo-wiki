<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сообщения | JojoLand</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray: #64748b;
            --card-bg: rgba(255,255,255,0.03);
            --card-border: rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: var(--light);
            font-family: 'Inter', sans-serif;
        }

        /* Layout */
        .messages-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            height: 100vh;
        }

        /* LEFT PANEL: dialogs */
        .dialogs-panel {
            border-right: 1px solid var(--card-border);
            background: rgba(255,255,255,0.02);
            overflow-y: auto;
        }

        .dialogs-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            font-size: 22px;
            font-weight: 600;
        }

        .dialog-item {
            padding: 18px;
            border-bottom: 1px solid var(--card-border);
            cursor: pointer;
            transition: 0.2s;
        }

        .dialog-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .dialog-item.active {
            background: rgba(255,255,255,0.08);
        }

        .dialog-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .dialog-lastmsg {
            font-size: 14px;
            color: var(--gray);
        }

        /* RIGHT PANEL: chat */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            font-size: 20px;
            font-weight: 600;
        }

        .messages-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .msg {
            margin-bottom: 14px;
            padding: 12px 14px;
            border-radius: 12px;
            max-width: 60%;
            line-height: 1.5;
        }

        .msg.me {
            background: var(--primary);
            margin-left: auto;
        }

        .msg.other {
            background: rgba(255,255,255,0.08);
            margin-right: auto;
        }

        .chat-input-box {
            padding: 20px;
            border-top: 1px solid var(--card-border);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px;
            font-size: 16px;
            border-radius: 10px;
            border: 1px solid var(--card-border);
            background: rgba(255,255,255,0.05);
            color: var(--light);
        }

        .send-btn {
            padding: 14px 22px;
            background: var(--primary);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            color: white;
        }

        .send-btn:hover {
            background: var(--secondary);
        }
    </style>
</head>
<body>

<div class="messages-layout">

    <!-- LEFT: DIALOGS -->
    <div class="dialogs-panel">
        <div class="dialogs-header">Диалоги</div>
        <div id="dialogs-list"></div>
    </div>

    <!-- RIGHT: CHAT -->
    <div class="chat-panel">
        <div class="chat-header" id="chat-header">Выберите диалог</div>

        <div class="messages-box" id="messages-box"></div>

        <div class="chat-input-box">
            <input type="text" id="message-input" class="chat-input" placeholder="Введите сообщение...">
            <button class="send-btn" onclick="sendMessage()">Отправить</button>
        </div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/* CONFIG */
const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();

/* GLOBAL */
let currentUserId = localStorage.getItem("jojoland_userId");
let currentUserNickname = localStorage.getItem("jojoland_nickname");
let activeDialog = null;

/* CHECK AUTH */
if (!currentUserId) {
    alert("Вы не авторизованы!");
}

/* LOAD DIALOGS */
function loadDialogs() {
    const container = document.getElementById("dialogs-list");
    container.innerHTML = `<div style="padding:20px; color:var(--gray)">Загрузка...</div>`;

    db.ref(`messages/${currentUserId}`).on("value", async snap => {
        container.innerHTML = "";

        if (!snap.exists()) {
            container.innerHTML = `<div style="padding:20px; color:var(--gray)">Диалогов пока нет</div>`;
            return;
        }

        const dialogs = snap.val();
        const items = [];

        for (const partnerId in dialogs) {
            const dialog = dialogs[partnerId];
            const unameSnap = await db.ref(`users/${partnerId}/nickname`).once("value");
            const partnerName = unameSnap.val() || "Игрок";

            items.push({
                id: partnerId,
                name: partnerName,
                last: dialog.lastMessage?.text || ""
            });
        }

        items.sort((a,b) => b.timestamp - a.timestamp);

        items.forEach(item => {
            const el = document.createElement("div");
            el.className = "dialog-item";
            el.onclick = () => openDialog(item.id, item.name);

            el.innerHTML = `
                <div class="dialog-name">${item.name}</div>
                <div class="dialog-lastmsg">${item.last || "Нет сообщений"}</div>
            `;

            container.appendChild(el);
        });
    });
}

/* OPEN DIALOG */
async function openDialog(partnerId, partnerName) {
    activeDialog = partnerId;

    document.querySelectorAll(".dialog-item").forEach(el => el.classList.remove("active"));
    event.currentTarget.classList.add("active");

    document.getElementById("chat-header").innerText = partnerName;

    createDialogIfMissing(partnerId);

    loadMessages(partnerId);
}

/* AUTO-CREATE DIALOG */
function createDialogIfMissing(partnerId) {
    const ref1 = db.ref(`messages/${currentUserId}/${partnerId}`);
    const ref2 = db.ref(`messages/${partnerId}/${currentUserId}`);

    ref1.once("value", snap => {
        if (!snap.exists()) {
            ref1.set({
                lastMessage: { text: "", timestamp: Date.now() }
            });
        }
    });

    ref2.once("value", snap => {
        if (!snap.exists()) {
            ref2.set({
                lastMessage: { text: "", timestamp: Date.now() }
            });
        }
    });
}

/* LOAD MESSAGES */
function loadMessages(partnerId) {
    const box = document.getElementById("messages-box");
    box.innerHTML = `<div style="padding:20px; color:var(--gray)">Загрузка сообщений...</div>`;

    db.ref(`messages/${currentUserId}/${partnerId}/history`)
    .on("value", snap => {
        box.innerHTML = "";

        if (!snap.exists()) return;

        const msgs = snap.val();
        for (const key in msgs) {
            const msg = msgs[key];
            const div = document.createElement("div");
            div.className = "msg " + (msg.from === currentUserId ? "me" : "other");
            div.innerText = msg.text;
            box.appendChild(div);
        }

        box.scrollTop = box.scrollHeight;
    });
}

/* SEND MESSAGE */
function sendMessage() {
    if (!activeDialog) {
        alert("Выберите диалог");
        return;
    }

    const input = document.getElementById("message-input");
    const text = input.value.trim();
    if (text === "") return;

    const messageObj = {
        text,
        timestamp: Date.now(),
        from: currentUserId
    };

    const refMy = db.ref(`messages/${currentUserId}/${activeDialog}`);
    const refHis = db.ref(`messages/${activeDialog}/${currentUserId}`);

    refMy.child("history").push(messageObj);
    refHis.child("history").push(messageObj);

    refMy.child("lastMessage").set(messageObj);
    refHis.child("lastMessage").set(messageObj);

    input.value = "";
}

loadDialogs();
</script>
</body>
</html>
