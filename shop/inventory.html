<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å | JojoLand</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="inventory.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è...</p>
</div>

<div class="background-effects" id="particles"></div>

<div id="content">
    <header>
        <div class="header-top">
            <a href="../index.html" class="profile-btn">
                <span class="profile-icon">üè†</span>
                <span class="profile-text">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </a>
            <img src="../images/logo.png" class="logo" alt="JojoLand Logo">
        </div>
        
        <h1 id="page-title">üéí –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h1>
        <p class="subtitle" id="page-subtitle">–í–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</p>
    </header>

    <div class="inventory-container">
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="inventory-filters">
            <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
            <button class="filter-btn" data-filter="theme">–¢–µ–º—ã –ø—Ä–æ—Ñ–∏–ª—è</button>
            <button class="filter-btn" data-filter="avatar">–ê–≤–∞—Ç–∞—Ä—ã</button>
            <button class="filter-btn" data-filter="badge">–ë–µ–π–¥–∂–∏</button>
            <button class="filter-btn" data-filter="effect">–≠—Ñ—Ñ–µ–∫—Ç—ã</button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="inventory-stats">
            <div class="stat-item">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="total-items">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üé®</div>
                <div class="stat-value" id="active-themes">0</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ–º</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value" id="rare-items">0</div>
                <div class="stat-label">–†–µ–¥–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
            </div>
        </div>

        <!-- –ì—Ä–∏–¥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
        <div class="inventory-grid" id="inventory-items">
            <!-- –ü—Ä–µ–¥–º–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç -->
        <div class="empty-inventory" id="empty-inventory" style="display: none;">
            <div class="empty-icon">üì≠</div>
            <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</h3>
            <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–∞ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏ –∏–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è.</p>
            <a href="points.html" class="action-btn">üéÑ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã</a>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="inventory-actions">
            <a href="profile.html" class="action-btn">üë§ –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
            <a href="points.html" class="action-btn">üéÑ –ú–∞–≥–∞–∑–∏–Ω –æ—á–∫–æ–≤</a>
            <button class="action-btn" id="equip-selected-btn" style="display: none;">üîÑ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-item-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="item-preview" id="modal-item-preview">
                    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–µ–¥–º–µ—Ç–∞ -->
                </div>
                <div class="item-info">
                    <div class="item-rarity" id="modal-item-rarity">–û–±—ã—á–Ω—ã–π</div>
                    <div class="item-description" id="modal-item-description">
                        –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å...
                    </div>
                    <div class="item-stats" id="modal-item-stats">
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
                    </div>
                    <div class="item-actions">
                        <button class="action-btn equip-btn" id="equip-btn">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        <button class="action-btn unequip-btn" id="unequip-btn" style="display: none;">‚ùå –°–Ω—è—Ç—å</button>
                        <button class="action-btn close-btn" id="close-modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// –°–û–ó–î–ê–ù–ò–ï –§–û–ù–û–í–´–• –ß–ê–°–¢–ò–¶
function createParticles() {
    const particlesContainer = document.getElementById('particles');
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        
        const size = Math.random() * 2 + 1;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        particle.style.opacity = Math.random() * 0.5 + 0.2;
        
        const duration = Math.random() * 20 + 15;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${Math.random() * 10}s`;
        
        particlesContainer.appendChild(particle);
    }
}

// ==================== –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ====================
function checkAuth() {
    const isLoggedIn = localStorage.getItem('jojoland_loggedIn') === 'true';
    const nickname = localStorage.getItem('jojoland_nickname');
    const userId = localStorage.getItem('jojoland_userId');
    
    console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', { isLoggedIn, nickname, userId });
    
    if (!isLoggedIn || !nickname || !userId) {
        console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
        showError('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 2000);
        return false;
    }
    
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    return true;
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –ò–ù–í–ï–ù–¢–ê–†–Ø ====================
async function loadInventory() {
    const userId = localStorage.getItem('jojoland_userId');
    const nickname = localStorage.getItem('jojoland_nickname');
    
    if (!checkAuth()) return;
    
    console.log('üì¶ –ó–∞–≥—Ä—É–∂–∞—é –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –¥–ª—è:', userId);
    
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const snapshot = await database.ref('user_inventory/' + userId).once('value');
        
        if (snapshot.exists()) {
            const inventory = snapshot.val();
            console.log('‚úÖ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∑–∞–≥—Ä—É–∂–µ–Ω:', inventory);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
            displayInventoryItems(inventory);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateInventoryStats(inventory);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
            await loadActiveItems(userId);
            
        } else {
            console.log('üì≠ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç');
            document.getElementById('empty-inventory').style.display = 'block';
            document.getElementById('inventory-items').innerHTML = '';
            updateInventoryStats([]);
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å');
    }
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –ê–ö–¢–ò–í–ù–´–• –ü–†–ï–î–ú–ï–¢–û–í ====================
async function loadActiveItems(userId) {
    try {
        const snapshot = await database.ref('user_active_items/' + userId).once('value');
        
        if (snapshot.exists()) {
            const activeItems = snapshot.val();
            console.log('‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:', activeItems);
            
            // –ü–æ–º–µ—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            markActiveItems(activeItems);
            
            return activeItems;
        } else {
            console.log('üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤');
            return {};
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', error);
        return {};
    }
}

// ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–†–ï–î–ú–ï–¢–û–í ====================
function displayInventoryItems(inventory) {
    const container = document.getElementById('inventory-items');
    const emptyMsg = document.getElementById('empty-inventory');
    
    if (!inventory || inventory.length === 0) {
        container.innerHTML = '';
        emptyMsg.style.display = 'block';
        return;
    }
    
    emptyMsg.style.display = 'none';
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ, –ø–æ—Ç–æ–º –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
    const sortedItems = [...inventory].sort((a, b) => {
        if (a.isActive && !b.isActive) return -1;
        if (!a.isActive && b.isActive) return 1;
        
        const rarityOrder = { 'legendary': 0, 'epic': 1, 'rare': 2, 'common': 3 };
        return rarityOrder[a.rarity] - rarityOrder[b.rarity];
    });
    
    container.innerHTML = sortedItems.map(item => `
        <div class="inventory-item ${item.rarity} ${item.isActive ? 'active' : ''}" 
             data-id="${item.id}" 
             data-type="${item.type}"
             onclick="openItemModal('${item.id}')">
            
            <div class="item-icon">${item.icon || 'üéÅ'}</div>
            <div class="item-name">${item.name}</div>
            
            ${item.isActive ? '<div class="active-badge">‚úÖ</div>' : ''}
            
            <div class="item-rarity-badge ${item.rarity}">
                ${getRarityText(item.rarity)}
            </div>
            
            <div class="item-type">${getTypeIcon(item.type)} ${getTypeText(item.type)}</div>
        </div>
    `).join('');
}

// ==================== –ü–û–ú–ï–¢–ö–ê –ê–ö–¢–ò–í–ù–´–• –ü–†–ï–î–ú–ï–¢–û–í ====================
function markActiveItems(activeItems) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    document.querySelectorAll('.inventory-item').forEach(itemEl => {
        const itemId = itemEl.dataset.id;
        const isActive = activeItems[itemId] === true;
        
        if (isActive) {
            itemEl.classList.add('active');
            // –î–æ–±–∞–≤–ª—è–µ–º –±–µ–π–¥–∂ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            if (!itemEl.querySelector('.active-badge')) {
                const badge = document.createElement('div');
                badge.className = 'active-badge';
                badge.textContent = '‚úÖ';
                itemEl.appendChild(badge);
            }
        } else {
            itemEl.classList.remove('active');
            const badge = itemEl.querySelector('.active-badge');
            if (badge) badge.remove();
        }
    });
}

// ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò ====================
function updateInventoryStats(inventory) {
    if (!inventory || inventory.length === 0) {
        document.getElementById('total-items').textContent = '0';
        document.getElementById('active-themes').textContent = '0';
        document.getElementById('rare-items').textContent = '0';
        return;
    }
    
    const total = inventory.length;
    const activeThemes = inventory.filter(item => 
        item.type === 'theme' && item.isActive
    ).length;
    
    const rareItems = inventory.filter(item => 
        item.rarity === 'rare' || item.rarity === 'epic' || item.rarity === 'legendary'
    ).length;
    
    document.getElementById('total-items').textContent = total;
    document.getElementById('active-themes').textContent = activeThemes;
    document.getElementById('rare-items').textContent = rareItems;
}

// ==================== –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ü–†–ï–î–ú–ï–¢–ê ====================
function openItemModal(itemId) {
    const userId = localStorage.getItem('jojoland_userId');
    
    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
    database.ref('user_inventory/' + userId).once('value').then(snapshot => {
        if (snapshot.exists()) {
            const inventory = snapshot.val();
            const item = inventory.find(i => i.id === itemId);
            
            if (item) {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
                document.getElementById('modal-item-name').textContent = item.name;
                document.getElementById('modal-item-rarity').textContent = getRarityText(item.rarity);
                document.getElementById('modal-item-rarity').className = `item-rarity ${item.rarity}`;
                document.getElementById('modal-item-description').textContent = item.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                const preview = document.getElementById('modal-item-preview');
                preview.innerHTML = `
                    <div class="preview-icon">${item.icon || 'üéÅ'}</div>
                    <div class="preview-type">${getTypeIcon(item.type)} ${getTypeText(item.type)}</div>
                `;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
                const statsEl = document.getElementById('modal-item-stats');
                if (item.stats) {
                    statsEl.innerHTML = Object.entries(item.stats).map(([key, value]) => `
                        <div class="stat-row">
                            <span class="stat-key">${key}:</span>
                            <span class="stat-value">${value}</span>
                        </div>
                    `).join('');
                } else {
                    statsEl.innerHTML = '<div class="no-stats">–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
                }
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                const equipBtn = document.getElementById('equip-btn');
                const unequipBtn = document.getElementById('unequip-btn');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–µ–¥–º–µ—Ç
                database.ref('user_active_items/' + userId + '/' + itemId).once('value').then(activeSnapshot => {
                    const isActive = activeSnapshot.exists() && activeSnapshot.val() === true;
                    
                    if (isActive) {
                        equipBtn.style.display = 'none';
                        unequipBtn.style.display = 'block';
                        
                        // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–Ω—è—Ç—å"
                        unequipBtn.onclick = () => unequipItem(itemId, item.type);
                    } else {
                        equipBtn.style.display = 'block';
                        unequipBtn.style.display = 'none';
                        
                        // –ù–∞–∑–Ω–∞—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
                        equipBtn.onclick = () => equipItem(itemId, item.type);
                    }
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('item-modal').style.display = 'block';
            }
        }
    });
}

// ==================== –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ü–†–ï–î–ú–ï–¢–ê ====================
async function equipItem(itemId, itemType) {
    const userId = localStorage.getItem('jojoland_userId');
    
    try {
        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª—è, —Å–Ω–∏–º–∞–µ–º –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
        if (itemType === 'theme') {
            await database.ref('user_active_items/' + userId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const updates = {};
                    Object.keys(snapshot.val()).forEach(key => {
                        updates[key] = null; // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ–º—ã
                    });
                    database.ref('user_active_items/' + userId).update(updates);
                }
            });
        }
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç
        await database.ref('user_active_items/' + userId + '/' + itemId).set(true);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        markItemAsActive(itemId, true);
        
        showSuccess('–ü—Ä–µ–¥–º–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—ë–Ω!');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            closeItemModal();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç');
    }
}

// ==================== –°–ù–Ø–¢–ò–ï –ü–†–ï–î–ú–ï–¢–ê ====================
async function unequipItem(itemId, itemType) {
    const userId = localStorage.getItem('jojoland_userId');
    
    try {
        await database.ref('user_active_items/' + userId + '/' + itemId).remove();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        markItemAsActive(itemId, false);
        
        showSuccess('–ü—Ä–µ–¥–º–µ—Ç —Å–Ω—è—Ç');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
            closeItemModal();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç');
    }
}

// ==================== –ü–û–ú–ï–¢–ö–ê –ü–†–ï–î–ú–ï–¢–ê –ö–ê–ö –ê–ö–¢–ò–í–ù–û–ì–û/–ù–ï–ê–ö–¢–ò–í–ù–û–ì–û ====================
function markItemAsActive(itemId, isActive) {
    const itemEl = document.querySelector(`.inventory-item[data-id="${itemId}"]`);
    if (itemEl) {
        if (isActive) {
            itemEl.classList.add('active');
            if (!itemEl.querySelector('.active-badge')) {
                const badge = document.createElement('div');
                badge.className = 'active-badge';
                badge.textContent = '‚úÖ';
                itemEl.appendChild(badge);
            }
        } else {
            itemEl.classList.remove('active');
            const badge = itemEl.querySelector('.active-badge');
            if (badge) badge.remove();
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateInventoryStatsFromUI();
}

// ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ò–ó UI ====================
function updateInventoryStatsFromUI() {
    const items = document.querySelectorAll('.inventory-item');
    const total = items.length;
    const activeThemes = Array.from(items).filter(item => 
        item.dataset.type === 'theme' && item.classList.contains('active')
    ).length;
    
    const rareItems = Array.from(items).filter(item => 
        item.classList.contains('rare') || 
        item.classList.contains('epic') || 
        item.classList.contains('legendary')
    ).length;
    
    document.getElementById('total-items').textContent = total;
    document.getElementById('active-themes').textContent = activeThemes;
    document.getElementById('rare-items').textContent = rareItems;
}

// ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
function getRarityText(rarity) {
    const rarityMap = {
        'common': '–û–±—ã—á–Ω—ã–π',
        'rare': '–†–µ–¥–∫–∏–π',
        'epic': '–≠–ø–∏—á–µ—Å–∫–∏–π',
        'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π'
    };
    return rarityMap[rarity] || '–û–±—ã—á–Ω—ã–π';
}

function getTypeIcon(type) {
    const typeIcons = {
        'theme': 'üé®',
        'avatar': 'üë§',
        'badge': 'üèÖ',
        'effect': '‚ú®',
        'background': 'üñºÔ∏è'
    };
    return typeIcons[type] || 'üéÅ';
}

function getTypeText(type) {
    const typeMap = {
        'theme': '–¢–µ–º–∞',
        'avatar': '–ê–≤–∞—Ç–∞—Ä',
        'badge': '–ë–µ–π–¥–∂',
        'effect': '–≠—Ñ—Ñ–µ–∫—Ç',
        'background': '–§–æ–Ω'
    };
    return typeMap[type] || '–ü—Ä–µ–¥–º–µ—Ç';
}

// ==================== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–†–ï–î–ú–ï–¢–û–í ====================
function setupFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            filterItems(filter);
        });
    });
}

function filterItems(filterType) {
    const items = document.querySelectorAll('.inventory-item');
    
    items.forEach(item => {
        if (filterType === 'all') {
            item.style.display = 'block';
        } else if (item.dataset.type === filterType) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// ==================== –ó–ê–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ====================
function closeItemModal() {
    document.getElementById('item-modal').style.display = 'none';
}

// ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ====================
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.style.cssText = `
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid #ff4444;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        text-align: center;
        color: #ffaaaa;
        font-size: 14px;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 300px;
    `;
    errorDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
        <div>${message}</div>
    `;
    
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        errorDiv.style.opacity = '0';
        errorDiv.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 500);
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.style.cssText = `
        background: rgba(68, 255, 68, 0.1);
        border: 1px solid #44ff44;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        text-align: center;
        color: #aaffaa;
        font-size: 14px;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 300px;
    `;
    successDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">‚úÖ –£—Å–ø–µ—Ö</div>
        <div>${message}</div>
    `;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.style.opacity = '0';
        successDiv.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 500);
    }, 3000);
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ====================
window.onload = async function() {
    createParticles();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById("loader").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("content").style.opacity = "1";
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        loadInventory();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        setupFilters();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.querySelector('.modal-close').addEventListener('click', closeItemModal);
        document.getElementById('close-modal').addEventListener('click', closeItemModal);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('item-modal');
            if (event.target === modal) {
                closeItemModal();
            }
        });
        
    }, 400);
};
</script>

</body>
</html>
