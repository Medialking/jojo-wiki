<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ JojoLand</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a2a, #1a1a4a, #0a0a2a);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .admin-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,0,255,0.3);
        }
        
        .admin-nav a {
            padding: 10px 20px;
            background: rgba(0,100,255,0.2);
            color: #6ab7ff;
            text-decoration: none;
            border-radius: 25px;
            border: 1px solid rgba(0,100,255,0.4);
            transition: 0.3s;
            font-weight: bold;
        }
        
        .admin-nav a:hover {
            background: rgba(0,100,255,0.4);
            transform: translateY(-2px);
        }
        
        /* –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
        .admin-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
        }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            background: rgba(0,0,0,0.6);
            border-radius: 25px;
            padding: 25px;
            border: 2px solid #0066ff;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .admin-info {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .admin-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #0066ff;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #0066ff, #00ccff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #aaa;
        }
        
        /* –§–∏–ª—å—Ç—Ä—ã */
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h4 {
            color: #6ab7ff;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .filter-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 10px;
            color: white;
            text-align: left;
            cursor: pointer;
            transition: 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: rgba(0,100,255,0.3);
            border-left: 4px solid #0066ff;
        }
        
        .filter-count {
            margin-left: auto;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        .main-panel {
            background: rgba(0,0,0,0.6);
            border-radius: 25px;
            padding: 25px;
            border: 2px solid #0066ff;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            flex: 1;
            max-width: 400px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
        }
        
        .search-box button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(90deg, #0066ff, #0099ff);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤ */
        .tickets-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .ticket-item {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: 0.3s;
            border: 2px solid transparent;
        }
        
        .ticket-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
            border-color: rgba(0,100,255,0.5);
        }
        
        .ticket-item.selected {
            background: rgba(0,100,255,0.2);
            border-color: #0066ff;
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .ticket-id {
            font-weight: bold;
            font-size: 18px;
            color: #6ab7ff;
        }
        
        .ticket-type {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .type-complaint { background: rgba(255,153,0,0.2); color: #ff9900; }
        .type-appeal { background: rgba(0,153,255,0.2); color: #0099ff; }
        .type-support { background: rgba(0,204,153,0.2); color: #00cc99; }
        
        .ticket-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-new { background: rgba(255,255,0,0.2); color: #ffff00; }
        .status-read { background: rgba(0,255,0,0.2); color: #00ff00; }
        .status-answered { background: rgba(0,150,255,0.2); color: #0096ff; }
        .status-closed { background: rgba(255,0,0,0.2); color: #ff0000; }
        
        .ticket-user {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .ticket-preview {
            color: #ccccff;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .ticket-time {
            font-size: 12px;
            color: #888;
            text-align: right;
        }
        
        /* –î–µ—Ç–∞–ª–∏ —Ç–∏–∫–µ—Ç–∞ */
        .ticket-details {
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .ticket-details.active {
            display: block;
        }
        
        .ticket-content {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            color: white;
            word-break: break-word;
        }
        
        .message-box {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #0066ff;
        }
        
        .message-box h4 {
            color: #6ab7ff;
            margin-bottom: 10px;
        }
        
        .message-text {
            color: white;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ */
        .response-form {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }
        
        .response-form h3 {
            color: #00ff00;
            margin-bottom: 15px;
        }
        
        .response-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: none;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-send {
            background: linear-gradient(90deg, #00cc00, #00ff00);
            color: #003300;
        }
        
        .btn-close {
            background: linear-gradient(90deg, #ff6600, #ff9900);
            color: white;
        }
        
        .btn-delete {
            background: linear-gradient(90deg, #ff0000, #ff3333);
            color: white;
        }
        
        .btn-skip {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π */
        .action-log {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
        }
        
        .log-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
        }
        
        .log-time {
            color: #aaa;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .log-action {
            color: white;
        }
        
        .log-admin {
            color: #6ab7ff;
            font-weight: bold;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* –ü–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        .tickets-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .tickets-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .tickets-list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #0066ff, #0099ff);
            border-radius: 10px;
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 1024px) {
            .admin-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .panel-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="admin-nav">
            <a href="index.html">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="admin_support.html" style="background: rgba(0,100,255,0.4);">üõ°Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
            <a href="admin_users.html">üë• –ò–≥—Ä–æ–∫–∏</a>
            <a href="admin_stats.html">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="admin_logs.html">üìã –õ–æ–≥–∏</a>
            <button onclick="logout()" style="margin-left: auto; padding: 10px 20px; background: rgba(255,0,0,0.2); color: #ff6666; border: 1px solid #ff6666; border-radius: 25px; cursor: pointer;">
                üö™ –í—ã–π—Ç–∏
            </button>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        <div class="admin-container">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="sidebar">
                <div class="admin-info">
                    <div class="admin-avatar">üëë</div>
                    <h3 id="adminName">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
                    <p style="color: #aaa; font-size: 14px;" id="adminRole">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="newTickets">0</div>
                        <div class="stat-label">–ù–æ–≤—ã—Ö</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTickets">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayTickets">0</div>
                        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="responseTime">0—á</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                    </div>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø—É -->
                <div class="filter-section">
                    <h4>üìÅ –¢–∏–ø –æ–±—Ä–∞—â–µ–Ω–∏—è</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterTickets('all')">
                            üìã –í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
                            <span class="filter-count" id="countAll">0</span>
                        </button>
                        <button class="filter-btn" onclick="filterTickets('complaint')">
                            ‚ö†Ô∏è –ñ–∞–ª–æ–±—ã
                            <span class="filter-count" id="countComplaints">0</span>
                        </button>
                        <button class="filter-btn" onclick="filterTickets('appeal')">
                            ‚öñÔ∏è –ê–ø–µ–ª–ª—è—Ü–∏–∏
                            <span class="filter-count" id="countAppeals">0</span>
                        </button>
                        <button class="filter-btn" onclick="filterTickets('support')">
                            üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞
                            <span class="filter-count" id="countSupport">0</span>
                        </button>
                    </div>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
                <div class="filter-section">
                    <h4>üìä –°—Ç–∞—Ç—É—Å</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn" onclick="filterByStatus('new')">
                            üÜï –ù–æ–≤—ã–µ
                            <span class="filter-count" id="countNew">0</span>
                        </button>
                        <button class="filter-btn" onclick="filterByStatus('read')">
                            üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ
                            <span class="filter-count" id="countRead">0</span>
                        </button>
                        <button class="filter-btn" onclick="filterByStatus('answered')">
                            üì® –° –æ—Ç–≤–µ—Ç–æ–º
                            <span class="filter-count" id="countAnswered">0</span>
                        </button>
                        <button class="filter-btn" onclick="filterByStatus('closed')">
                            ‚úÖ –ó–∞–∫—Ä—ã—Ç—ã–µ
                            <span class="filter-count" id="countClosed">0</span>
                        </button>
                    </div>
                </div>
                
                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="filter-section">
                    <h4>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
                    <div class="filter-buttons">
                        <button class="filter-btn" onclick="markAllAsRead()">
                            ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                        </button>
                        <button class="filter-btn" onclick="exportAllTickets()">
                            üì• –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
                        </button>
                        <button class="filter-btn" onclick="showStats()">
                            üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="main-panel">
                <div class="panel-header">
                    <h2>üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID, –Ω–∏–∫—É –∏–ª–∏ —Ç–µ–∫—Å—Ç—É...">
                        <button onclick="searchTickets()">üîç</button>
                    </div>
                </div>
                
                <!-- –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤ -->
                <div class="tickets-list" id="ticketsList">
                    <div style="text-align: center; padding: 50px; color: #aaa;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π...
                    </div>
                </div>
                
                <!-- –î–µ—Ç–∞–ª–∏ —Ç–∏–∫–µ—Ç–∞ -->
                <div class="ticket-details" id="ticketDetails">
                    <div class="ticket-content">
                        <div class="ticket-header">
                            <h3 id="detailTicketId">TICKET-ID</h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <span id="detailType" class="ticket-type">–¢–∏–ø</span>
                                <span id="detailStatus" class="ticket-status">–°—Ç–∞—Ç—É—Å</span>
                            </div>
                        </div>
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–∫–µ—Ç–µ -->
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">üë§ –ò–≥—Ä–æ–∫</div>
                                <div class="info-value" id="detailUser">-</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">üÜî User ID</div>
                                <div class="info-value" id="detailUserId">-</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
                                <div class="info-value" id="detailDate">-</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">‚è±Ô∏è –í—Ä–µ–º—è –≤ —Ä–∞–±–æ—Ç–µ</div>
                                <div class="info-value" id="detailTimeOpen">-</div>
                            </div>
                        </div>
                        
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div id="extraInfo"></div>
                        
                        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ -->
                        <div class="message-box">
                            <h4>üìù –°–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞:</h4>
                            <div class="message-text" id="detailMessage">-</div>
                        </div>
                        
                        <!-- –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ -->
                        <div class="message-box" id="proofSection" style="display: none;">
                            <h4>üìé –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:</h4>
                            <div class="message-text" id="detailProof">-</div>
                        </div>
                        
                        <!-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–æ–≤ -->
                        <div class="message-box" id="answersSection" style="display: none;">
                            <h4>üì® –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–æ–≤:</h4>
                            <div id="answersList"></div>
                        </div>
                        
                        <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
                        <div class="response-form">
                            <h3>üì§ –û—Ç–≤–µ—Ç–∏—Ç—å –∏–≥—Ä–æ–∫—É</h3>
                            <textarea class="response-textarea" id="responseText" 
                                      placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
                            
                            <div class="action-buttons">
                                <button class="action-btn btn-send" onclick="sendResponse()">
                                    üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                                </button>
                                <button class="action-btn btn-close" onclick="closeTicket()">
                                    ‚úÖ –ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteTicket()">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–∏–∫–µ—Ç
                                </button>
                                <button class="action-btn btn-skip" onclick="skipTicket()">
                                    ‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                                </button>
                            </div>
                        </div>
                        
                        <!-- –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="action-log" id="actionLog">
                            <h4>üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π:</h4>
                            <div id="logList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE –ö–û–ù–§–ò–ì ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
            authDomain: "jojoland-chat.firebaseapp.com",
            databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
            projectId: "jojoland-chat",
            storageBucket: "jojoland-chat.firebasestorage.app",
            messagingSenderId: "602788305122",
            appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentAdmin = null;
        let currentFilter = 'all';
        let currentStatusFilter = null;
        let allTickets = [];
        let filteredTickets = [];
        let selectedTicketId = null;
        let selectedTicketData = null;
        
        // ID —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–≤ (–∑–¥–µ—Å—å —Ç–≤–æ–π ID)
        const SUPER_ADMINS = [
            'w51qspQCTJReZUvbOyUmII0wSvG3',  // ‚Üê –í–°–¢–ê–í–¨ –°–í–û–ô USER ID
            'admin_user_id_2'      // ‚Üê –î—Ä—É–≥–∏–µ –∞–¥–º–∏–Ω—ã
        ];
        
        // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
        function checkAdminAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentAdmin = user;
                    alert("w51qspQCTJReZUvbOyUmII0wSvG3" + user.uid);
                    document.getElementById('adminName').textContent = user.displayName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
                    if (SUPER_ADMINS.includes(user.uid)) {
                        document.getElementById('adminRole').textContent = 'üëë –°—É–ø–µ—Ä–∞–¥–º–∏–Ω';
                        initAdminPanel();
                    } else {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                        database.ref('moderators/' + user.uid).once('value')
                            .then(snapshot => {
                                if (snapshot.exists()) {
                                    document.getElementById('adminRole').textContent = 'üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä';
                                    initAdminPanel();
                                } else {
                                    alert('–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏!');
                                    window.location.href = 'index.html';
                                }
                            });
                    }
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                    showLoginForm();
                }
            });
        }
        
        function showLoginForm() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('–ê–¥–º–∏–Ω –≤–æ—à–µ–ª:', result.user);
                })
                .catch((error) => {
                    console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å');
                    window.location.href = 'index.html';
                });
        }
        
        function logout() {
            auth.signOut();
            window.location.href = 'index.html';
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function initAdminPanel() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
            loadAllTickets();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(updateStats, 30000);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            setTimeout(() => {
                if (allTickets.length === 0) {
                    alert('üí° –°–æ–≤–µ—Ç: –î–ª—è —Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–π—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∞–π—Ç–∞, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                }
            }, 2000);
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====================
        async function loadAllTickets() {
            try {
                const snapshot = await database.ref('support_tickets')
                    .orderByChild('timestamp')
                    .once('value');
                
                allTickets = [];
                
                if (!snapshot.exists()) {
                    updateTicketsList();
                    updateStats();
                    return;
                }
                
                snapshot.forEach(childSnapshot => {
                    const ticket = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    allTickets.unshift(ticket); // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
                });
                
                updateTicketsList();
                updateStats();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –Ω–æ–≤—ã–π —Ç–∏–∫–µ—Ç
                const newTicket = allTickets.find(t => t.status === 'new');
                if (newTicket) {
                    selectTicket(newTicket.id);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è');
            }
        }
        
        // ==================== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø ====================
        function filterTickets(type) {
            currentFilter = type;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateTicketsList();
        }
        
        function filterByStatus(status) {
            currentStatusFilter = status;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-section:nth-child(3) .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateTicketsList();
        }
        
        function updateTicketsList() {
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–∏–∫–µ—Ç—ã
            filteredTickets = allTickets.filter(ticket => {
                // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
                if (currentFilter !== 'all' && ticket.type !== currentFilter) {
                    return false;
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
                if (currentStatusFilter && ticket.status !== currentStatusFilter) {
                    return false;
                }
                
                return true;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            updateFilterCounts();
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            const ticketsList = document.getElementById('ticketsList');
            
            if (filteredTickets.length === 0) {
                ticketsList.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #aaa;">
                        üì≠ –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredTickets.forEach(ticket => {
                const date = new Date(ticket.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + 
                               date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const typeText = ticket.type === 'complaint' ? '–ñ–∞–ª–æ–±–∞' : 
                                ticket.type === 'appeal' ? '–ê–ø–µ–ª–ª—è—Ü–∏—è' : '–ü–æ–¥–¥–µ—Ä–∂–∫–∞';
                
                const typeClass = ticket.type === 'complaint' ? 'type-complaint' : 
                                 ticket.type === 'appeal' ? 'type-appeal' : 'type-support';
                
                const statusText = ticket.status === 'new' ? '–ù–æ–≤–æ–µ' : 
                                  ticket.status === 'read' ? '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ' : 
                                  ticket.status === 'answered' ? '–° –æ—Ç–≤–µ—Ç–æ–º' : '–ó–∞–∫—Ä—ã—Ç–æ';
                
                const statusClass = ticket.status === 'new' ? 'status-new' : 
                                   ticket.status === 'read' ? 'status-read' : 
                                   ticket.status === 'answered' ? 'status-answered' : 'status-closed';
                
                const isSelected = ticket.id === selectedTicketId ? 'selected' : '';
                
                html += `
                    <div class="ticket-item ${isSelected}" onclick="selectTicket('${ticket.id}')">
                        <div class="ticket-header">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span class="ticket-id">${ticket.ticketId || ticket.id}</span>
                                <span class="ticket-type ${typeClass}">${typeText}</span>
                            </div>
                            <span class="ticket-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="ticket-user">
                            üë§ ${ticket.userNickname || ticket.username || '–ò–≥—Ä–æ–∫'}
                        </div>
                        <div class="ticket-preview">
                            ${truncateText(ticket.description || ticket.reason || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è', 120)}
                        </div>
                        <div class="ticket-time">${dateStr}</div>
                    </div>
                `;
            });
            
            ticketsList.innerHTML = html;
        }
        
        function updateFilterCounts() {
            // –°—á–∏—Ç–∞–µ–º –ø–æ —Ç–∏–ø–∞–º
            const counts = {
                all: allTickets.length,
                complaint: allTickets.filter(t => t.type === 'complaint').length,
                appeal: allTickets.filter(t => t.type === 'appeal').length,
                support: allTickets.filter(t => t.type === 'support').length,
                new: allTickets.filter(t => t.status === 'new').length,
                read: allTickets.filter(t => t.status === 'read').length,
                answered: allTickets.filter(t => t.status === 'answered').length,
                closed: allTickets.filter(t => t.status === 'closed').length
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countComplaints').textContent = counts.complaint;
            document.getElementById('countAppeals').textContent = counts.appeal;
            document.getElementById('countSupport').textContent = counts.support;
            document.getElementById('countNew').textContent = counts.new;
            document.getElementById('countRead').textContent = counts.read;
            document.getElementById('countAnswered').textContent = counts.answered;
            document.getElementById('countClosed').textContent = counts.closed;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–≤–µ—Ä—Ö—É
            document.getElementById('newTickets').textContent = counts.new;
            document.getElementById('totalTickets').textContent = counts.all;
            
            // –°—á–∏—Ç–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ
            const today = new Date().setHours(0,0,0,0);
            const todayCount = allTickets.filter(t => new Date(t.timestamp) >= today).length;
            document.getElementById('todayTickets').textContent = todayCount;
        }
        
        // ==================== –í–´–ë–û–† –¢–ò–ö–ï–¢–ê ====================
        async function selectTicket(ticketId) {
            selectedTicketId = ticketId;
            selectedTicketData = allTickets.find(t => t.id === ticketId);
            
            if (!selectedTicketData) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ (–ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π)
            updateTicketsList();
            
            // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π
            if (selectedTicketData.status === 'new') {
                await database.ref(`support_tickets/${ticketId}/status`).set('read');
                selectedTicketData.status = 'read';
                updateStats();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
            showTicketDetails();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç–æ–≤
            loadTicketAnswers(ticketId);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∂—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π
            loadActionLog(ticketId);
        }
        
        function showTicketDetails() {
            const details = document.getElementById('ticketDetails');
            details.classList.add('active');
            
            const ticket = selectedTicketData;
            const date = new Date(ticket.timestamp);
            const dateStr = date.toLocaleDateString() + ' ' + 
                           date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            document.getElementById('detailTicketId').textContent = ticket.ticketId || ticket.id;
            document.getElementById('detailUser').textContent = ticket.userNickname || ticket.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            document.getElementById('detailUserId').textContent = ticket.userId || '–ù–µ—Ç ID';
            document.getElementById('detailDate').textContent = dateStr;
            
            // –í—Ä–µ–º—è –≤ —Ä–∞–±–æ—Ç–µ
            const timeOpen = Date.now() - ticket.timestamp;
            const hours = Math.floor(timeOpen / (1000 * 60 * 60));
            const minutes = Math.floor((timeOpen % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('detailTimeOpen').textContent = 
                `${hours}—á ${minutes}–º`;
            
            // –¢–∏–ø –∏ —Å—Ç–∞—Ç—É—Å
            const typeText = ticket.type === 'complaint' ? '‚ö†Ô∏è –ñ–∞–ª–æ–±–∞' : 
                            ticket.type === 'appeal' ? '‚öñÔ∏è –ê–ø–µ–ª–ª—è—Ü–∏—è' : 'üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞';
            const typeClass = ticket.type === 'complaint' ? 'type-complaint' : 
                             ticket.type === 'appeal' ? 'type-appeal' : 'type-support';
            
            document.getElementById('detailType').textContent = typeText;
            document.getElementById('detailType').className = `ticket-type ${typeClass}`;
            
            const statusText = ticket.status === 'new' ? 'üÜï –ù–æ–≤–æ–µ' : 
                              ticket.status === 'read' ? 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ' : 
                              ticket.status === 'answered' ? 'üì® –° –æ—Ç–≤–µ—Ç–æ–º' : '‚úÖ –ó–∞–∫—Ä—ã—Ç–æ';
            const statusClass = ticket.status === 'new' ? 'status-new' : 
                               ticket.status === 'read' ? 'status-read' : 
                               ticket.status === 'answered' ? 'status-answered' : 'status-closed';
            
            document.getElementById('detailStatus').textContent = statusText;
            document.getElementById('detailStatus').className = `ticket-status ${statusClass}`;
            
            // –°–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('detailMessage').textContent = 
                ticket.description || ticket.reason || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            const extraInfo = document.getElementById('extraInfo');
            extraInfo.innerHTML = '';
            
            if (ticket.type === 'complaint') {
                extraInfo.innerHTML = `
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">üö´ –ù–∞—Ä—É—à–∏—Ç–µ–ª—å</div>
                            <div class="info-value">${ticket.violatorNickname || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">üïê –í—Ä–µ–º—è –Ω–∞—Ä—É—à–µ–Ω–∏—è</div>
                            <div class="info-value">${ticket.violationTime || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        </div>
                    </div>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
                if (ticket.proof) {
                    document.getElementById('proofSection').style.display = 'block';
                    document.getElementById('detailProof').innerHTML = 
                        formatLinks(ticket.proof);
                }
                
            } else if (ticket.type === 'appeal') {
                extraInfo.innerHTML = `
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">‚öñÔ∏è –¢–∏–ø –Ω–∞–∫–∞–∑–∞–Ω–∏—è</div>
                            <div class="info-value">${ticket.punishmentType || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">üìÖ –î–∞—Ç–∞ –Ω–∞–∫–∞–∑–∞–Ω–∏—è</div>
                            <div class="info-value">${ticket.punishmentDate || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                        </div>
                    </div>
                `;
                
                if (ticket.proof) {
                    document.getElementById('proofSection').style.display = 'block';
                    document.getElementById('detailProof').innerHTML = 
                        formatLinks(ticket.proof);
                }
                
            } else if (ticket.type === 'support') {
                extraInfo.innerHTML = `
                    <div class="info-item">
                        <div class="info-label">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                        <div class="info-value">${ticket.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    </div>
                `;
                
                if (ticket.additionalInfo) {
                    document.getElementById('proofSection').style.display = 'block';
                    document.getElementById('detailProof').textContent = ticket.additionalInfo;
                }
            }
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –æ—Ç–≤–µ—Ç–∞
            setTimeout(() => {
                document.getElementById('responseText').focus();
            }, 100);
        }
        
        // ==================== –û–¢–í–ï–¢ –ù–ê –¢–ò–ö–ï–¢ ====================
        async function sendResponse() {
            const responseText = document.getElementById('responseText').value.trim();
            
            if (!responseText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞!');
                return;
            }
            
            if (!selectedTicketData) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ!');
                return;
            }
            
            try {
                const adminName = currentAdmin.displayName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                const adminId = currentAdmin.uid;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
                await database.ref(`support_tickets/${selectedTicketId}/adminAnswer`).set(responseText);
                await database.ref(`support_tickets/${selectedTicketId}/adminName`).set(adminName);
                await database.ref(`support_tickets/${selectedTicketId}/adminId`).set(adminId);
                await database.ref(`support_tickets/${selectedTicketId}/answerTime`).set(Date.now());
                await database.ref(`support_tickets/${selectedTicketId}/status`).set('answered');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç–æ–≤
                const answerRef = database.ref(`ticket_answers/${selectedTicketId}`).push();
                await answerRef.set({
                    text: responseText,
                    adminName: adminName,
                    adminId: adminId,
                    timestamp: Date.now()
                });
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                await logAction('answer', `–û—Ç–≤–µ—Ç–∏–ª –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ ${selectedTicketData.ticketId}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                selectedTicketData.adminAnswer = responseText;
                selectedTicketData.adminName = adminName;
                selectedTicketData.status = 'answered';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                alert('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–≥—Ä–æ–∫—É!');
                document.getElementById('responseText').value = '';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏
                loadTicketAnswers(selectedTicketId);
                updateTicketsList();
                updateStats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
            }
        }
        
        async function closeTicket() {
            if (!selectedTicketData) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ!');
                return;
            }
            
            if (confirm('–ó–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ?')) {
                try {
                    await database.ref(`support_tickets/${selectedTicketId}/status`).set('closed');
                    await database.ref(`support_tickets/${selectedTicketId}/closedBy`).set(currentAdmin.displayName);
                    await database.ref(`support_tickets/${selectedTicketId}/closedTime`).set(Date.now());
                    
                    await logAction('close', `–ó–∞–∫—Ä—ã–ª –æ–±—Ä–∞—â–µ–Ω–∏–µ ${selectedTicketData.ticketId}`);
                    
                    selectedTicketData.status = 'closed';
                    
                    alert('‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ!');
                    updateTicketsList();
                    updateStats();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è');
                }
            }
        }
        
        async function deleteTicket() {
            if (!selectedTicketData) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ!');
                return;
            }
            
            if (confirm('–í–ù–ò–ú–ê–ù–ò–ï! –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                try {
                    await database.ref(`support_tickets/${selectedTicketId}`).remove();
                    await logAction('delete', `–£–¥–∞–ª–∏–ª –æ–±—Ä–∞—â–µ–Ω–∏–µ ${selectedTicketData.ticketId}`);
                    
                    // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
                    allTickets = allTickets.filter(t => t.id !== selectedTicketId);
                    
                    alert('‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!');
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–∫–µ—Ç
                    selectedTicketId = null;
                    selectedTicketData = null;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    document.getElementById('ticketDetails').classList.remove('active');
                    updateTicketsList();
                    updateStats();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è');
                }
            }
        }
        
        function skipTicket() {
            // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ç–∏–∫–µ—Ç
            const currentIndex = filteredTickets.findIndex(t => t.id === selectedTicketId);
            if (currentIndex < filteredTickets.length - 1) {
                selectTicket(filteredTickets[currentIndex + 1].id);
            } else if (filteredTickets.length > 0) {
                selectTicket(filteredTickets[0].id);
            }
        }
        
        // ==================== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        async function loadTicketAnswers(ticketId) {
            try {
                const snapshot = await database.ref(`ticket_answers/${ticketId}`).once('value');
                const answersList = document.getElementById('answersList');
                
                if (!snapshot.exists()) {
                    document.getElementById('answersSection').style.display = 'none';
                    return;
                }
                
                document.getElementById('answersSection').style.display = 'block';
                
                let html = '';
                const answers = [];
                
                snapshot.forEach(childSnapshot => {
                    answers.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É)
                answers.sort((a, b) => a.timestamp - b.timestamp);
                
                answers.forEach(answer => {
                    const date = new Date(answer.timestamp);
                    const dateStr = date.toLocaleDateString() + ' ' + 
                                   date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,100,255,0.1); border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <strong style="color: #6ab7ff;">${answer.adminName}</strong>
                                <small style="color: #aaa;">${dateStr}</small>
                            </div>
                            <div style="color: white; line-height: 1.5;">
                                ${answer.text}
                            </div>
                        </div>
                    `;
                });
                
                answersList.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤:', error);
            }
        }
        
        async function loadActionLog(ticketId) {
            try {
                const snapshot = await database.ref(`ticket_logs/${ticketId}`)
                    .orderByChild('timestamp')
                    .limitToLast(20)
                    .once('value');
                
                const logList = document.getElementById('logList');
                
                if (!snapshot.exists()) {
                    logList.innerHTML = '<div class="log-item">–î–µ–π—Å—Ç–≤–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }
                
                let html = '';
                const logs = [];
                
                snapshot.forEach(childSnapshot => {
                    logs.push(childSnapshot.val());
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                logs.sort((a, b) => b.timestamp - a.timestamp);
                
                logs.forEach(log => {
                    const date = new Date(log.timestamp);
                    const dateStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    html += `
                        <div class="log-item">
                            <span class="log-time">${dateStr}</span>
                            <span class="log-admin">${log.adminName}:</span>
                            <span class="log-action"> ${log.action}</span>
                        </div>
                    `;
                });
                
                logList.innerHTML = html;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
            }
        }
        
        async function logAction(action, description) {
            try {
                await database.ref(`ticket_logs/${selectedTicketId}`).push({
                    action: description,
                    adminName: currentAdmin.displayName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    adminId: currentAdmin.uid,
                    timestamp: Date.now()
                });
                
                // –¢–∞–∫–∂–µ –ª–æ–≥–∏—Ä—É–µ–º –≤ –æ–±—â–∏–π –∂—É—Ä–Ω–∞–ª
                await database.ref('admin_log').push({
                    ticketId: selectedTicketData.ticketId,
                    action: action,
                    adminName: currentAdmin.displayName,
                    adminId: currentAdmin.uid,
                    timestamp: Date.now(),
                    description: description
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            }
        }
        
        // ==================== –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø ====================
        async function markAllAsRead() {
            if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ?')) return;
            
            try {
                const updates = {};
                allTickets.forEach(ticket => {
                    if (ticket.status === 'new') {
                        updates[`support_tickets/${ticket.id}/status`] = 'read';
                        ticket.status = 'read';
                    }
                });
                
                await database.ref().update(updates);
                await logAction('mark_all_read', '–û—Ç–º–µ—Ç–∏–ª –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ');
                
                alert('‚úÖ –í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ!');
                updateTicketsList();
                updateStats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤');
            }
        }
        
        function exportAllTickets() {
            const dataStr = JSON.stringify(allTickets, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `jojoland_tickets_export_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('üì• –í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON —Ñ–∞–π–ª!');
        }
        
        function showStats() {
            const stats = calculateStats();
            
            const message = `
                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:
                
                –í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π: ${stats.total}
                –ù–æ–≤—ã—Ö: ${stats.new}
                –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö: ${stats.read}
                –° –æ—Ç–≤–µ—Ç–æ–º: ${stats.answered}
                –ó–∞–∫—Ä—ã—Ç—ã—Ö: ${stats.closed}
                
                –ñ–∞–ª–æ–±: ${stats.complaints}
                –ê–ø–µ–ª–ª—è—Ü–∏–π: ${stats.appeals}
                –û–±—Ä–∞—â–µ–Ω–∏–π –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: ${stats.support}
                
                –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${stats.avgResponseTime}
                –û–±—Ä–∞—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è: ${stats.today}
            `;
            
            alert(message);
        }
        
        function calculateStats() {
            const now = Date.now();
            const today = new Date().setHours(0,0,0,0);
            
            let totalResponseTime = 0;
            let answeredCount = 0;
            
            allTickets.forEach(ticket => {
                if (ticket.answerTime && ticket.timestamp) {
                    totalResponseTime += (ticket.answerTime - ticket.timestamp);
                    answeredCount++;
                }
            });
            
            const avgResponseTime = answeredCount > 0 
                ? Math.floor(totalResponseTime / answeredCount / (1000 * 60 * 60)) + '—á'
                : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            
            const todayCount = allTickets.filter(t => new Date(t.timestamp) >= today).length;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            document.getElementById('responseTime').textContent = avgResponseTime;
            
            return {
                total: allTickets.length,
                new: allTickets.filter(t => t.status === 'new').length,
                read: allTickets.filter(t => t.status === 'read').length,
                answered: allTickets.filter(t => t.status === 'answered').length,
                closed: allTickets.filter(t => t.status === 'closed').length,
                complaints: allTickets.filter(t => t.type === 'complaint').length,
                appeals: allTickets.filter(t => t.type === 'appeal').length,
                support: allTickets.filter(t => t.type === 'support').length,
                avgResponseTime: avgResponseTime,
                today: todayCount
            };
        }
        
        function updateStats() {
            calculateStats();
        }
        
        function searchTickets() {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchText) {
                currentStatusFilter = null;
                updateTicketsList();
                return;
            }
            
            filteredTickets = allTickets.filter(ticket => {
                return (
                    (ticket.ticketId && ticket.ticketId.toLowerCase().includes(searchText)) ||
                    (ticket.userNickname && ticket.userNickname.toLowerCase().includes(searchText)) ||
                    (ticket.username && ticket.username.toLowerCase().includes(searchText)) ||
                    (ticket.description && ticket.description.toLowerCase().includes(searchText)) ||
                    (ticket.reason && ticket.reason.toLowerCase().includes(searchText))
                );
            });
            
            const ticketsList = document.getElementById('ticketsList');
            
            if (filteredTickets.length === 0) {
                ticketsList.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #aaa;">
                        üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${searchText}"
                    </div>
                `;
                return;
            }
            
            updateTicketsList();
        }
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function truncateText(text, maxLength) {
            if (!text) return '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '...';
        }
        
        function formatLinks(text) {
            if (!text) return '–ù–µ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤';
            
            // –ò—â–µ–º —Å—Å—ã–ª–∫–∏ –∏ –¥–µ–ª–∞–µ–º –∏—Ö –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => {
                return `<a href="${url}" target="_blank" style="color: #6ab7ff;">${url}</a>`;
            }).replace(/\n/g, '<br>');
        }
        
        function showError(message) {
            alert(`‚ùå ${message}`);
        }
        
        // ==================== –ó–ê–ü–£–°–ö ====================
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            
            // –ü–æ–∏—Å–∫ –ø–æ Enter
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchTickets();
                }
            });
        });
    </script>
</body>
</html>
