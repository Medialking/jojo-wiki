<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–î—Ä—É–∑—å—è | JojoLand</title>
    <link rel="stylesheet" href="style.css">

    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- –í–ï–†–¨ –°–í–û–ò –°–¢–ò–õ–ò (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞) --- */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray: #64748b;
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--light);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* –õ–û–ê–î–ï–† */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.4s ease;
        }
        .spinner { width: 60px; height: 60px; border: 4px solid var(--card-border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† */
        .friends-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; min-height: 100vh; }

        /* –•–ï–î–ï–† */
        .page-header { text-align: center; margin-bottom: 50px; }
        .page-title { font-size: 42px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; letter-spacing: -0.5px; }
        .page-subtitle { font-size: 18px; color: var(--gray); font-weight: 400; max-width: 600px; margin: 0 auto; line-height: 1.6; }

        /* –í–ö–õ–ê–î–ö–ò */
        .tabs-container { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid var(--card-border); padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; background: transparent; border: none; color: var(--gray); font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 500; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; position: relative; }
        .tab-btn:hover { color: var(--light); background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -11px; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 3px 3px 0 0; }

        .tab-indicator { position: absolute; top: -5px; right: -5px; background: var(--primary); color: white; font-size: 12px; min-width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .invitations .tab-indicator { background: var(--warning); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }

        /* –ö–ê–†–¢–û–ß–ö–ò –î–†–£–ó–ï–ô */
        .friends-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .friend-card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--card-border); border-radius: 16px; padding: 20px; transition: all 0.3s; display: flex; align-items: center; gap: 15px; }
        .friend-card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .friend-avatar { width: 60px; height: 60px; border-radius: 50%; flex-shrink: 0; position: relative; }
        .friend-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; border:2px solid var(--card-border); }
        .avatar-fallback { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; font-size:20px; font-weight:600; border-radius:50%; }
        .online-indicator { position:absolute; bottom:4px; right:4px; width:12px; height:12px; border-radius:50%; border:2px solid var(--dark); background:var(--success); }
        .online-indicator.offline { background: var(--gray); }

        .friend-info { flex:1; min-width:0; }
        .friend-name { font-size:16px; font-weight:600; color:var(--light); margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .friend-status { font-size:13px; color:var(--gray); display:flex; align-items:center; gap:6px; margin-bottom:8px; }
        .friend-actions { display:flex; gap:8px; flex-wrap:wrap; }

        .action-btn { padding:6px 12px; background: rgba(255,255,255,0.05); border:1px solid var(--card-border); border-radius:8px; color:var(--gray); font-family:'Inter',sans-serif; font-size:12px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; gap:5px; }
        .action-btn:hover { background: rgba(255,255,255,0.1); color:var(--light); }
        .action-btn.message { border-color: var(--primary); color: var(--primary); }
        .action-btn.message:hover { background: rgba(99,102,241,0.1); }
        .action-btn.remove { border-color: var(--danger); color: var(--danger); }
        .action-btn.remove:hover { background: rgba(239,68,68,0.1); }
        .action-btn.accept { border-color: var(--success); color: var(--success); }
        .action-btn.accept:hover { background: rgba(16,185,129,0.1); }

        /* –ü–†–ò–ì–õ–ê–®–ï–ù–ò–Ø */
        .invitation-card { background: var(--card-bg); backdrop-filter: blur(10px); border:1px solid rgba(245,158,11,0.3); border-radius:16px; padding:20px; margin-bottom:15px; transition:all 0.3s; }
        .invitation-card:hover { transform: translateY(-2px); border-color: var(--warning); box-shadow: 0 10px 25px rgba(245,158,11,0.1); }
        .invitation-header { display:flex; align-items:center; gap:15px; margin-bottom:15px; }
        .invitation-info { flex:1; }
        .invitation-from { font-size:16px; font-weight:600; color:var(--light); margin-bottom:5px; }
        .invitation-date { font-size:12px; color:var(--gray); }
        .invitation-actions { display:flex; gap:10px; }

        /* –ü–£–°–¢–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø */
        .empty-state { text-align:center; padding:60px 20px; background: var(--card-bg); border:1px solid var(--card-border); border-radius:16px; }
        .empty-icon { font-size:48px; margin-bottom:20px; opacity:0.5; }
        .empty-title { font-size:20px; font-weight:600; color:var(--light); margin-bottom:10px; }
        .empty-text { color:var(--gray); font-size:16px; max-width:400px; margin:0 auto 20px; line-height:1.5; }
        .empty-action { display:inline-block; padding:10px 20px; background: rgba(99,102,241,0.1); border:1px solid rgba(99,102,241,0.2); border-radius:10px; color:var(--primary); text-decoration:none; font-weight:500; transition:all 0.3s; }
        .empty-action:hover { background: rgba(99,102,241,0.2); transform: translateY(-2px); }

        /* –•–ï–î–ï–† */
        .site-header { background: rgba(15,23,42,0.8); backdrop-filter: blur(10px); border-bottom:1px solid var(--card-border); padding:20px 0; position: sticky; top: 0; z-index: 50; }
        .header-content { max-width:1400px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between; }
        .logo { font-size:24px; font-weight:700; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-decoration:none; }
        .nav-links { display:flex; gap:24px; }
        .nav-link { color:var(--gray); text-decoration:none; font-weight:500; transition:all 0.3s; padding:8px 0; position:relative; }
        .nav-link:hover { color:var(--light); }
        .nav-link.active { color:var(--primary); }
        .nav-link.active::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:var(--primary); border-radius:2px; }

        @media (max-width:768px) {
            .friends-container { padding:30px 16px; }
            .page-title { font-size:32px; }
            .page-subtitle { font-size:16px; }
            .tabs-container { justify-content:center; }
            .tab-btn { padding:10px 16px; font-size:14px; }
            .friends-grid { grid-template-columns: 1fr; }
            .friend-card { flex-direction:column; text-align:center; }
            .friend-actions { justify-content:center; }
            .header-content { flex-direction:column; gap:16px; }
            .nav-links { width:100%; justify-content:center; flex-wrap:wrap; gap:16px; }
            .nav-link { font-size:14px; }
        }

        @media (max-width:480px) {
            .friends-container { padding:24px 12px; }
            .page-title { font-size:28px; }
            .invitation-header { flex-direction:column; text-align:center; }
            .invitation-actions { justify-content:center; }
        }

        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

<!-- –õ–û–ê–î–ï–† -->
<div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π...</p>
</div>

<!-- –•–ï–î–ï–† -->
<header class="site-header">
    <div class="header-content">
        <a href="index.html" class="logo">JojoLand</a>
        <nav class="nav-links">
            <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="profile.html" class="nav-link">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="players.html" class="nav-link">üë• –ò–≥—Ä–æ–∫–∏</a>
            <a href="friends.html" class="nav-link active">ü§ù –î—Ä—É–∑—å—è</a>
            <a href="messages.html" class="nav-link">‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏—è</a>
            <a href="points.html" class="nav-link">üéÑ –û—á–∫–∏</a>
        </nav>
    </div>
</header>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
<div id="content">
    <div class="friends-container">
        <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
        <div class="page-header">
            <h1 class="page-title">–°–∏—Å—Ç–µ–º–∞ –¥—Ä—É–∑–µ–π</h1>
            <p class="page-subtitle">–î–æ–±–∞–≤–ª—è–π—Ç–µ –¥—Ä—É–∑–µ–π, –æ–±—â–∞–π—Ç–µ—Å—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ò -->
        <div class="tabs-container">
            <button class="tab-btn active" data-tab="friends">
                <span>üë•</span> –ú–æ–∏ –¥—Ä—É–∑—å—è
                <span class="tab-indicator" id="friends-count">0</span>
            </button>
            <button class="tab-btn" data-tab="online">
                <span>üü¢</span> –û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å
                <span class="tab-indicator" id="online-count">0</span>
            </button>
            <button class="tab-btn invitations" data-tab="invitations">
                <span>üì©</span> –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
                <span class="tab-indicator" id="invitations-count">0</span>
            </button>
            <button class="tab-btn" data-tab="requests">
                <span>üì§</span> –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ
                <span class="tab-indicator" id="requests-count">0</span>
            </button>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê "–ú–û–ò –î–†–£–ó–¨–ò" -->
        <div class="tab-content active" id="friends-tab">
            <div class="friends-grid" id="friends-list">
                <!-- –î—Ä—É–∑—å—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <div class="empty-state" id="friends-empty" style="display: none;">
                <div class="empty-icon">üë•</div>
                <h3 class="empty-title">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</h3>
                <p class="empty-text">–î–æ–±–∞–≤–ª—è–π—Ç–µ –¥—Ä—É–∑–µ–π –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Ö —Å—Ç–∞—Ç—É—Å –∏ –æ–±—â–∞—Ç—å—Å—è</p>
                <a href="players.html" class="empty-action">–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</a>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê "–û–ù–õ–ê–ô–ù –°–ï–ô–ß–ê–°" -->
        <div class="tab-content" id="online-tab">
            <div class="friends-grid" id="online-list">
                <!-- –û–Ω–ª–∞–π–Ω –¥—Ä—É–∑—å—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <div class="empty-state" id="online-empty" style="display: none;">
                <div class="empty-icon">üü¢</div>
                <h3 class="empty-title">–ù–µ—Ç –¥—Ä—É–∑–µ–π –æ–Ω–ª–∞–π–Ω</h3>
                <p class="empty-text">–í–∞—à–∏ –¥—Ä—É–∑—å—è —Å–µ–π—á–∞—Å –Ω–µ –≤ —Å–µ—Ç–∏. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ–∑–∂–µ!</p>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê "–ü–†–ò–ì–õ–ê–®–ï–ù–ò–Ø" -->
        <div class="tab-content" id="invitations-tab">
            <div id="invitations-list">
                <!-- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <div class="empty-state" id="invitations-empty" style="display: none;">
                <div class="empty-icon">üì©</div>
                <h3 class="empty-title">–ù–µ—Ç –Ω–æ–≤—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</h3>
                <p class="empty-text">–ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –¥–æ–±–∞–≤–∏—Ç –≤–∞—Å –≤ –¥—Ä—É–∑—å—è, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
                <a href="players.html" class="empty-action">–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</a>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê "–û–¢–ü–†–ê–í–õ–ï–ù–ù–´–ï" -->
        <div class="tab-content" id="requests-tab">
            <div id="requests-list">
                <!-- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <div class="empty-state" id="requests-empty" style="display: none;">
                <div class="empty-icon">üì§</div>
                <h3 class="empty-title">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</h3>
                <p class="empty-text">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º</p>
                <a href="players.html" class="empty-action">–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π</a>
            </div>
        </div>
    </div>
</div>

<!-- –ö–ù–û–ü–ö–ê –ù–ê–í–ï–†–• -->
<button class="back-to-top" id="back-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö">‚Üë</button>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/*
  friends.html ‚Äî –ª–æ–≥–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã –¥—Ä—É–∑–µ–π.
  –¢—Ä–µ–±—É–µ—Ç:
    localStorage.jojoland_userId
    localStorage.jojoland_nickname
    (–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –Ω–æ –∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –≤—Ö–æ–¥)
*/

const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let currentUserId = localStorage.getItem('jojoland_userId');
let currentUserNickname = localStorage.getItem('jojoland_nickname');

// –£—Ç–∏–ª–∏—Ç—ã
function getOnlineStatus(userData) {
    if (!userData || !userData.lastVisit) return 'offline';
    const lastVisit = new Date(userData.lastVisit);
    const now = new Date();
    const diffMinutes = (now - lastVisit) / (1000 * 60);
    if (diffMinutes < 5) return 'online';
    if (diffMinutes < 15) return 'ingame';
    return 'offline';
}

function createFriendCardHTML(user) {
    const nickname = user.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    const userId = user.userId || user.id;
    const firstLetter = (nickname.charAt(0) || '?').toUpperCase();
    const online = getOnlineStatus(user);
    const onlineClass = online === 'online' ? '' : online === 'ingame' ? 'ingame' : 'offline';
    const avatar = user.avatar && user.avatar.startsWith('data:image') ? `<img src="${user.avatar}" alt="${nickname}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">` : '';
    const fallbackStyle = avatar ? 'style="display:none"' : '';

    // –ö–Ω–æ–ø–∫–∏: –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ updateFriendButton –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ players (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
    // –ó–¥–µ—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ–π –Ω–∞–±–æ—Ä: —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —É–¥–∞–ª–∏—Ç—å (–µ—Å–ª–∏ –¥—Ä—É–≥)
    return `
      <div class="friend-card" data-user-id="${userId}">
          <div class="friend-avatar">
              ${avatar}
              <div class="avatar-fallback" ${fallbackStyle}>${firstLetter}</div>
              <div class="online-indicator ${onlineClass}"></div>
          </div>
          <div class="friend-info">
              <div class="friend-name">${nickname}</div>
              <div class="friend-status">${online === 'online' ? '–û–Ω–ª–∞–π–Ω' : online === 'ingame' ? '–í –∏–≥—Ä–µ' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
          </div>
          <div class="friend-actions">
              <button class="action-btn message" onclick="openChatWith('${userId}','${escapeQuotes(nickname)}')">‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ</button>
              <button class="action-btn remove" onclick="removeFriend('${userId}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
      </div>
    `;
}

function createInvitationCardHTML(inv) {
    const nickname = inv.fromNickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    const fromUserId = inv.fromUserId;
    const date = inv.timestamp ? new Date(inv.timestamp).toLocaleString() : '';
    return `
      <div class="invitation-card" data-from-id="${fromUserId}">
        <div class="invitation-header">
            <div class="friend-avatar">
                <div class="avatar-fallback">${(nickname.charAt(0)||'?').toUpperCase()}</div>
            </div>
            <div class="invitation-info">
                <div class="invitation-from">${nickname}</div>
                <div class="invitation-date">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${date}</div>
            </div>
            <div class="invitation-actions">
                <button class="action-btn accept" onclick="acceptFriendRequest('${fromUserId}')">‚úì –ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="action-btn remove" onclick="rejectFriendRequest('${fromUserId}')">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
      </div>
    `;
}

function createSentRequestCardHTML(req) {
    const nickname = req.toNickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    const toUserId = req.toUserId;
    const date = req.timestamp ? new Date(req.timestamp).toLocaleString() : '';
    return `
      <div class="invitation-card" data-to-id="${toUserId}">
        <div class="invitation-header">
            <div class="friend-avatar">
                <div class="avatar-fallback">${(nickname.charAt(0)||'?').toUpperCase()}</div>
            </div>
            <div class="invitation-info">
                <div class="invitation-from">${nickname}</div>
                <div class="invitation-date">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${date}</div>
            </div>
            <div class="invitation-actions">
                <button class="action-btn remove" onclick="cancelSentRequest('${toUserId}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>
      </div>
    `;
}

function escapeQuotes(s) {
    return String(s||'').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// –ö–ª–∞—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π –¥—Ä—É–∑–µ–π
class FriendsSystem {
    constructor() {
        this.friends = [];
        this.onlineFriends = [];
        this.invitations = [];
        this.sentRequests = [];
    }

    async loadFriends() {
        if (!currentUserId) return;
        try {
            const friendsRef = database.ref(`friends/${currentUserId}`);
            const snapshot = await friendsRef.once('value');
            if (!snapshot.exists()) {
                this.friends = [];
                this.onlineFriends = [];
                this.updateUI();
                return;
            }
            const friendsData = snapshot.val();
            this.friends = [];
            this.onlineFriends = [];
            for (const friendId in friendsData) {
                const entry = friendsData[friendId];
                // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ 'accepted' –∏–ª–∏ –æ–±—ä–µ–∫—Ç
                const status = typeof entry === 'string' ? entry : (entry.status || (entry === 'accepted' ? 'accepted' : 'unknown'));
                if (status === 'accepted') {
                    // –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const friendSnapshot = await database.ref(`users/${friendId}`).once('value');
                    if (friendSnapshot.exists()) {
                        const friendData = friendSnapshot.val();
                        friendData.userId = friendId;
                        this.friends.push(friendData);
                        if (getOnlineStatus(friendData) === 'online') this.onlineFriends.push(friendData);
                    } else {
                        // –µ—Å–ª–∏ –Ω–µ—Ç users/ –∑–∞–ø–∏—Å–∏, –¥–æ–±–∞–≤–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —é–∑–µ—Ä
                        this.friends.push({ userId: friendId, nickname: (entry && entry.nickname) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' });
                    }
                }
            }
            this.updateUI();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', err);
        }
    }

    async loadInvitations() {
        if (!currentUserId) return;
        try {
            const invitationsRef = database.ref(`friend_requests/${currentUserId}`);
            const snapshot = await invitationsRef.once('value');
            this.invitations = [];
            if (!snapshot.exists()) {
                this.updateUI();
                return;
            }
            const data = snapshot.val();
            for (const fromId in data) {
                const inv = data[fromId];
                inv.fromUserId = fromId;
                // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
                if (!inv.status || inv.status === 'pending') {
                    this.invitations.push(inv);
                }
            }
            this.updateUI();
        } catch (err) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:', err); }
    }

    async loadSentRequests() {
        if (!currentUserId) return;
        try {
            const sentRef = database.ref(`sent_requests/${currentUserId}`);
            const snapshot = await sentRef.once('value');
            this.sentRequests = [];
            if (!snapshot.exists()) {
                this.updateUI();
                return;
            }
            const data = snapshot.val();
            for (const toId in data) {
                const r = data[toId];
                r.toUserId = toId;
                if (!r.status || r.status === 'pending') this.sentRequests.push(r);
            }
            this.updateUI();
        } catch (err) { console.error('–û—à–∏–±–∫–∞ loadSentRequests:', err); }
    }

    updateUI() {
        // —Å—á—ë—Ç—á–∏–∫–∏
        const friendsCountEl = document.getElementById('friends-count');
        const onlineCountEl = document.getElementById('online-count');
        const invitationsCountEl = document.getElementById('invitations-count');
        const requestsCountEl = document.getElementById('requests-count');
        if (friendsCountEl) friendsCountEl.textContent = this.friends.length;
        if (onlineCountEl) onlineCountEl.textContent = this.onlineFriends.length;
        if (invitationsCountEl) invitationsCountEl.textContent = this.invitations.length;
        if (requestsCountEl) requestsCountEl.textContent = this.sentRequests.length;

        // friends list
        const friendsList = document.getElementById('friends-list');
        const friendsEmpty = document.getElementById('friends-empty');
        if (friendsList) {
            if (this.friends.length > 0) {
                friendsList.innerHTML = this.friends.map(u => createFriendCardHTML(u)).join('');
                if (friendsEmpty) friendsEmpty.style.display = 'none';
            } else {
                friendsList.innerHTML = '';
                if (friendsEmpty) friendsEmpty.style.display = 'block';
            }
        }

        // online list
        const onlineList = document.getElementById('online-list');
        const onlineEmpty = document.getElementById('online-empty');
        if (onlineList) {
            if (this.onlineFriends.length > 0) {
                onlineList.innerHTML = this.onlineFriends.map(u => createFriendCardHTML(u)).join('');
                if (onlineEmpty) onlineEmpty.style.display = 'none';
            } else {
                onlineList.innerHTML = '';
                if (onlineEmpty) onlineEmpty.style.display = 'block';
            }
        }

        // invitations list
        const invitationsList = document.getElementById('invitations-list');
        const invitationsEmpty = document.getElementById('invitations-empty');
        if (invitationsList) {
            if (this.invitations.length > 0) {
                invitationsList.innerHTML = this.invitations.map(inv => createInvitationCardHTML(inv)).join('');
                if (invitationsEmpty) invitationsEmpty.style.display = 'none';
            } else {
                invitationsList.innerHTML = '';
                if (invitationsEmpty) invitationsEmpty.style.display = 'block';
            }
        }

        // requests list
        const requestsList = document.getElementById('requests-list');
        const requestsEmpty = document.getElementById('requests-empty');
        if (requestsList) {
            if (this.sentRequests.length > 0) {
                requestsList.innerHTML = this.sentRequests.map(r => createSentRequestCardHTML(r)).join('');
                if (requestsEmpty) requestsEmpty.style.display = 'none';
            } else {
                requestsList.innerHTML = '';
                if (requestsEmpty) requestsEmpty.style.display = 'block';
            }
        }
    }
}

const friendsSystem = new FriendsSystem();

// === –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∑–∞—è–≤–∫–∞–º–∏ –∏ –¥—Ä—É–∑—å—è–º–∏ ===

async function addFriend(userId, nickname) {
    if (!currentUserId) { alert('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –¥—Ä—É–∑—å—è –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return; }
    if (currentUserId === userId) { alert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è'); return; }
    if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å "${nickname}" –≤ –¥—Ä—É–∑—å—è?`)) return;

    try {
        const ts = Date.now();

        // —Å–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        await database.ref(`friend_requests/${userId}/${currentUserId}`).set({
            fromNickname: currentUserNickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            timestamp: ts,
            status: 'pending'
        });

        // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ sent_requests —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        await database.ref(`sent_requests/${currentUserId}/${userId}`).set({
            toNickname: nickname,
            timestamp: ts,
            status: 'pending'
        });

        alert('–ó–∞—è–≤–∫–∞ –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        await friendsSystem.loadSentRequests();
    } catch (err) {
        console.error('addFriend error', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏');
    }
}

async function acceptFriendRequest(fromUserId) {
    if (!currentUserId) return;
    try {
        const timestamp = Date.now();

        // –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        const fromUserSnapshot = await database.ref(`users/${fromUserId}`).once('value');
        const fromUserData = fromUserSnapshot.exists() ? fromUserSnapshot.val() : { nickname: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };

        // —Å–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º —É–∑–ª—ã friends –æ–±–µ–∏–º —Å—Ç–æ—Ä–æ–Ω–∞–º
        await database.ref(`friends/${currentUserId}/${fromUserId}`).set({
            nickname: fromUserData.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            status: 'accepted',
            since: timestamp
        });
        await database.ref(`friends/${fromUserId}/${currentUserId}`).set({
            nickname: currentUserNickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            status: 'accepted',
            since: timestamp
        });

        // —É–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫–∏
        await database.ref(`friend_requests/${currentUserId}/${fromUserId}`).remove();
        await database.ref(`sent_requests/${fromUserId}/${currentUserId}`).remove();

        alert('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è');
        await friendsSystem.loadFriends();
        await friendsSystem.loadInvitations();
        await friendsSystem.loadSentRequests();
    } catch (err) {
        console.error('acceptFriendRequest error', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞—è–≤–∫–∏');
    }
}

async function rejectFriendRequest(fromUserId) {
    if (!currentUserId) return;
    if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
    try {
        await database.ref(`friend_requests/${currentUserId}/${fromUserId}`).remove();
        await database.ref(`sent_requests/${fromUserId}/${currentUserId}`).remove();
        alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
        await friendsSystem.loadInvitations();
        await friendsSystem.loadSentRequests();
    } catch (err) {
        console.error('rejectFriendRequest error', err);
    }
}

async function cancelSentRequest(toUserId) {
    if (!currentUserId) return;
    if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –∑–∞—è–≤–∫—É?')) return;
    try {
        await database.ref(`sent_requests/${currentUserId}/${toUserId}`).remove();
        await database.ref(`friend_requests/${toUserId}/${currentUserId}`).remove();
        alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
        await friendsSystem.loadSentRequests();
        await friendsSystem.loadInvitations();
    } catch (err) {
        console.error('cancelSentRequest error', err);
    }
}

async function removeFriend(friendId) {
    if (!currentUserId) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥—Ä—É–∑–µ–π?')) return;
    try {
        await database.ref(`friends/${currentUserId}/${friendId}`).remove();
        await database.ref(`friends/${friendId}/${currentUserId}`).remove();
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω –∏–∑ –¥—Ä—É–∑–µ–π');
        await friendsSystem.loadFriends();
    } catch (err) {
        console.error('removeFriend error', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –¥—Ä—É–∑–µ–π');
    }
}

// –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ messages.html —Å query string)
function openChatWith(userId, nickname) {
    const url = `messages.html?open=${encodeURIComponent(userId)}&nick=${encodeURIComponent(nickname)}`;
    window.location.href = url;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ: —Ç–∞–±—ã, back-to-top, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function setupTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const tab = btn.dataset.tab;
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            const target = document.getElementById(tab + '-tab');
            if (target) target.classList.add('active');
        });
    });
}

function setupBackToTop() {
    const btn = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) btn.classList.add('visible'); else btn.classList.remove('visible');
    });
    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
}

// –£—Ö–æ–¥–∏–º –æ—Ç –ª–æ–∞–¥–µ—Ä–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.addEventListener('load', async () => {
    try {
        // –£–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä
        const loader = document.getElementById('loader');
        if (loader) { loader.style.opacity = '0'; setTimeout(()=>loader.style.display='none', 350); }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–±–æ–≤
        setupTabs();
        setupBackToTop();

        // –û–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω—É—é –∏–Ω—Ñ—É –æ currentUser
        currentUserId = localStorage.getItem('jojoland_userId');
        currentUserNickname = localStorage.getItem('jojoland_nickname');

        // –ó–∞–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
        await friendsSystem.loadFriends();
        await friendsSystem.loadInvitations();
        await friendsSystem.loadSentRequests();

        // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ "–ù–∞–π—Ç–∏ –¥—Ä—É–∑–µ–π" (–∏–∑ empty-state) –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ players.html ‚Äî —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ —Ä–∞–∑–º–µ—Ç–∫–µ
    } catch (err) {
        console.error('init error', err);
    }
});
</script>

</body>
</html>
