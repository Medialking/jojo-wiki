<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JojoLand ‚Äî –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- –ò–≥—Ä–æ–≤–æ–π —à—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* –ü–†–û–°–¢–´–ï –≠–§–§–ï–ö–¢–´ –§–û–ù–ê */
        .background-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }
        
        /* –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—ã */
        .form-container {
            display: none;
        }
        
        .form-container.active {
            display: block;
        }
    </style>
</head>
<body>

<!-- –ê–ù–ò–ú–ê–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
<div id="auth-modal" class="modal-overlay">
    <div class="modal-content">
        <!-- –í–ö–õ–ê–î–ö–ò –í–•–û–î/–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">–í—Ö–æ–¥</button>
            <button class="auth-tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
        <div id="login-form" class="form-container active">
            <div class="modal-header">
                <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <label for="login-nickname">–ù–∏–∫–Ω–µ–π–º:</label>
                    <input 
                        type="text" 
                        id="login-nickname" 
                        placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º"
                        autocomplete="username"
                    >
                </div>
                
                <div class="input-group">
                    <label for="login-password">–ü–∞—Ä–æ–ª—å:</label>
                    <input 
                        type="password" 
                        id="login-password" 
                        placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å"
                        autocomplete="current-password"
                    >
                    <div class="password-toggle" id="toggle-login-password">üëÅÔ∏è</div>
                </div>
                
                <div class="error-message" id="login-error"></div>
            </div>
            
            <div class="modal-footer">
                <button id="login-btn" class="submit-btn">
                    –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
                </button>
                <p class="modal-note">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="switch-to-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </p>
            </div>
        </div>
        
        <!-- –§–û–†–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
        <div id="register-form" class="form-container">
            <div class="modal-header">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <label for="reg-nickname">–ù–∏–∫–Ω–µ–π–º:</label>
                    <input 
                        type="text" 
                        id="reg-nickname" 
                        placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫ (3-16 —Å–∏–º–≤–æ–ª–æ–≤)"
                        maxlength="16"
                        autocomplete="username"
                    >
                    <div class="input-hint">
                        <span id="reg-char-count">0/16</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="reg-password">–ü–∞—Ä–æ–ª—å:</label>
                    <input 
                        type="password" 
                        id="reg-password" 
                        placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)"
                        autocomplete="new-password"
                    >
                    <div class="password-toggle" id="toggle-reg-password">üëÅÔ∏è</div>
                </div>
                
                <div class="input-group">
                    <label for="reg-confirm-password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input 
                        type="password" 
                        id="reg-confirm-password" 
                        placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        autocomplete="new-password"
                    >
                    <div class="password-toggle" id="toggle-reg-confirm">üëÅÔ∏è</div>
                </div>
                
                <div class="requirements">
                    <h4>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</h4>
                    <ul>
                        <li id="req-nick-length" class="invalid">‚úì –ù–∏–∫: 3-16 —Å–∏–º–≤–æ–ª–æ–≤</li>
                        <li id="req-nick-format" class="invalid">‚úì –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _</li>
                        <li id="req-nick-unique" class="valid">‚úì –ù–∏–∫ —Å–≤–æ–±–æ–¥–µ–Ω</li>
                        <li id="req-password-length" class="invalid">‚úì –ü–∞—Ä–æ–ª—å: –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</li>
                        <li id="req-password-match" class="invalid">‚úì –ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç</li>
                    </ul>
                </div>
                
                <div class="error-message" id="reg-error"></div>
            </div>
            
            <div class="modal-footer">
                <button id="register-btn" class="submit-btn" disabled>
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                <p class="modal-note">
                    –ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="switch-to-login">–í–æ–π—Ç–∏</a>
                </p>
            </div>
        </div>
        
        <div class="server-info-small">
            <span>IP —Å–µ—Ä–≤–µ—Ä–∞: <strong>play.jojoland.ru</strong></span>
        </div>
    </div>
</div>

<!-- –§–û–ù–û–í–´–ï –≠–§–§–ï–ö–¢–´ -->
<div class="background-effects" id="particles"></div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
<div id="content">

<header>
    <div class="header-top">
        <a href="profle/profile.html" class="profile-btn" id="profile-link" style="display: none;">
            <span class="profile-icon">üë§</span>
            <span class="profile-text">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
        <button class="profile-btn" id="logout-btn-header" style="display: none;">
            <span class="profile-icon">üö™</span>
            <span class="profile-text">–í—ã–π—Ç–∏</span>
        </button>
        <img src="images/logo.png" class="logo" alt="JojoLand Logo">
    </div>
    
    <h1>JojoLand</h1>
    <p class="subtitle">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç —Å–µ—Ä–≤–µ—Ä–∞</p>

    <nav>
        <a href="rules.html" class="nav-btn">üìú –ü—Ä–∞–≤–∏–ª–∞</a>
        <a href="tgk.html" class="nav-btn">üìò TGK</a>
        <a href="obzhalovanie.html" class="nav-btn">üîê –û–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ</a>
    </nav>
</header>

<main class="main-content">
    <!-- –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ô –ë–õ–û–ö -->
    <div class="info-block">
        <h2>–ì–ª–∞–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞</h2>
        <p>–í—Å–µ –≤–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∏–≥—Ä—ã –Ω–∞ –Ω–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ</p>
    </div>

    <!-- –ì–õ–ê–í–ù–´–ï –ö–ù–û–ü–ö–ò -->
<div class="button-grid">
    <a href="https://t.me/+18-ycRRnOTgxZTgy" class="main-btn tgk-btn">
        <div class="btn-icon">üìå</div>
        <div class="btn-content">
            <h3>TGK —á–∞—Ç</h3>
            <p>–û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤</p>
        </div>
    </a>
    
    <a href="https://t.me/Jojolandpe" class="main-btn tg-btn">
        <div class="btn-icon">üí¨</div>
        <div class="btn-content">
            <h3>Telegram –≥—Ä—É–ø–ø–∞</h3>
            <p>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram-–∫–∞–Ω–∞–ª</p>
        </div>
    </a>
    
    <a href="http://pay.jojoland.ru/" class="main-btn donate-btn">
        <div class="btn-icon">üíé</div>
        <div class="btn-content">
            <h3>–î–æ–Ω–∞—Ç —Å–∞–π—Ç</h3>
            <p>–ü–æ–∫—É–ø–∫–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π</p>
        </div>
    </a>
    
    <a href="points.html" class="main-btn points-btn">
        <div class="btn-icon">üéÅ</div>
        <div class="btn-content">
            <h3>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏</h3>
            <p>–°–æ–±–µ—Ä–∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –æ—á–∫–∏</p>
        </div>
    </a>

    <a href="casino.html" class="main-btn casino-btn">
        <div class="btn-icon">üé∞</div>
        <div class="btn-content">
            <h3>–ö–∞–∑–∏–Ω–æ</h3>
            <p>–ò—Å–ø—ã—Ç–∞–π—Ç–µ —É–¥–∞—á—É –≤ –∏–≥—Ä–∞—Ö</p>
        </div>
    </a>
    
    <!-- –ï–°–õ–ò –ï–°–¢–¨ –ö–ù–û–ü–ö–ê –ò–ì–†–û–ö–û–í, –¢–û–ñ–ï –î–û–ë–ê–í–ò–¢–¨ –°–Æ–î–ê -->
    <a href="players.html" class="main-btn players-btn">
        <div class="btn-icon">üë•</div>
        <div class="btn-content">
            <h3>–ò–≥—Ä–æ–∫–∏</h3>
            <p>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞</p>
        </div>
    </a>
</div> <!-- –ó–∞–∫—Ä—ã–≤–∞–µ–º button-grid -->

    <!-- –ë–´–°–¢–†–´–ï –°–°–´–õ–ö–ò -->
    <div class="quick-links">
        <h3>–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</h3>
        <div class="faq-items">
            <div class="faq-item">
                <h4>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—é?</h4>
                <p>–ö—É–ø–∏—Ç–µ –µ—ë –Ω–∞ –Ω–∞—à–µ–º <a href="http://pay.jojoland.ru/">–¥–æ–Ω–∞—Ç —Å–∞–π—Ç–µ</a></p>
            </div>
            <div class="faq-item">
                <h4>–ö–∞–∫ –≤—Å—Ç—É–ø–∏—Ç—å –≤ TGK?</h4>
                <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "TGK —á–∞—Ç" –≤—ã—à–µ</p>
            </div>
            <div class="faq-item">
                <h4>–ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏?</h4>
                <p>–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –≤–∞–ª—é—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>
            </div>
        </div>
    </div>

    <!-- –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ô –ë–õ–û–ö -->
    <div class="server-info">
        <h3>–û —Å–µ—Ä–≤–µ—Ä–µ JojoLand</h3>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç —Å–µ—Ä–≤–µ—Ä–∞ <strong>JojoLand</strong>! –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥—ë—Ç–µ –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∏–≥—Ä—ã.</p>
        <p>–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Minecraft —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –∏ –ø–ª–∞–≥–∏–Ω–æ–≤.</p>
        
        <div class="holiday-info">
            <h4>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ 2025</h4>
            <p>–°–æ–±–∏—Ä–∞–π—Ç–µ <strong>–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏</strong>, —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã!</p>
            <a href="points.html" class="holiday-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–∞—Ö ‚Üí</a>
        </div>
    </div>
</main>

<!-- –ö–ù–û–ü–ö–ê –ë–´–°–¢–†–û–ô –ü–û–ú–û–©–ò -->
<a class="help-btn" href="chat.html" target="_blank">
    <div class="help-icon">üí¨</div>
    <span>–ü–æ–º–æ—â—å</span>
</a>

<footer>
    <div class="footer-content">
        <p>¬© 2025 JojoLand ‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
        <p class="footer-ip">IP: play.jojoland.ru</p>
    </div>
</footer>

</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// –°–û–ó–î–ê–ù–ò–ï –§–û–ù–û–í–´–• –ß–ê–°–¢–ò–¶
function createParticles() {
    const particlesContainer = document.getElementById('particles');
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        
        const size = Math.random() * 2 + 1;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        particle.style.opacity = Math.random() * 0.5 + 0.2;
        
        const duration = Math.random() * 20 + 15;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${Math.random() * 10}s`;
        
        particlesContainer.appendChild(particle);
    }
}

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ê–ö–ö–ê–£–ù–¢–ê–ú–ò ====================

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ω–∏–∫–∞
function generateUserId(nickname) {
    return nickname.toLowerCase()
        .replace(/[^a-z–∞-—è—ë0-9_]/g, '_')
        .replace(/[–∞-—è—ë]/g, function(match) {
            const map = {
                '–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d',
                '–µ':'e','—ë':'yo','–∂':'zh','–∑':'z','–∏':'i',
                '–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n',
                '–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t',
                '—É':'u','—Ñ':'f','—Ö':'h','—Ü':'ts','—á':'ch',
                '—à':'sh','—â':'shch','—ä':'','—ã':'y','—å':'',
                '—ç':'e','—é':'yu','—è':'ya'
            };
            return map[match] || match;
        });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞
function isValidNickname(nickname) {
    if (nickname.length < 3 || nickname.length > 16) {
        return false;
    }
    const regex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]+$/;
    return regex.test(nickname);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
function isValidPassword(password) {
    return password.length >= 6;
}

// –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
function hashPassword(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString(16);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞
async function isNicknameUnique(nickname) {
    try {
        const userId = generateUserId(nickname);
        const snapshot = await database.ref('users/' + userId).once('value');
        return !snapshot.exists();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∏–∫–∞:', error);
        return false;
    }
}

// –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–≤—Ö–æ–¥)
async function loginUser(nickname, password) {
    try {
        const userId = generateUserId(nickname);
        const snapshot = await database.ref('users/' + userId).once('value');
        
        if (!snapshot.exists()) {
            return { success: false, error: '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' };
        }
        
        const userData = snapshot.val();
        const passwordHash = hashPassword(password);
        
        if (userData.passwordHash !== passwordHash) {
            return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å' };
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
        localStorage.setItem('jojoland_nickname', nickname);
        localStorage.setItem('jojoland_userId', userId);
        localStorage.setItem('jojoland_loggedIn', 'true');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç
        await updateLastVisit(userId, userData);
        
        return { success: true, userData: userData };
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        return { success: false, error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' };
    }
}

// ==================== –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê ====================

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function checkReferralOnPageLoad() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–µ—à (#ref=...)
    const hash = window.location.hash;
    let refCode = null;
    
    if (hash && hash.includes('ref=')) {
        refCode = hash.split('ref=')[1];
        // –û—á–∏—â–∞–µ–º —Ö–µ—à –∏–∑ URL
        window.location.hash = '';
        console.log('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ —Ö–µ—à–∞:', refCode);
    }
    
    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (?ref=...) –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    const urlParams = new URLSearchParams(window.location.search);
    const refParam = urlParams.get('ref');
    if (refParam) {
        refCode = refParam;
        // –û—á–∏—â–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        console.log('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:', refCode);
    }
    
    if (refCode) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        localStorage.setItem('jojoland_referral_code', refCode);
        console.log('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage');
    }
    
    return refCode;
}

// –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –†–ï–§–ï–†–ê–õ–¨–ù–û–ì–û –ö–û–î–ê –ü–†–ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
async function processReferralCode(refCode, newUserId, nickname) {
    try {
        console.log('=== –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–§–ï–†–ê–õ–¨–ù–û–ì–û –ö–û–î–ê ===');
        console.log('–ö–æ–¥:', refCode);
        console.log('–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:', newUserId);
        console.log('–ù–∏–∫–Ω–µ–π–º:', nickname);
        
        // –ò—â–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –ø–æ –∫–æ–¥—É
        const referralsSnapshot = await database.ref('referrals').once('value');
        
        if (!referralsSnapshot.exists()) {
            console.log('‚ùå –ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –≤ –±–∞–∑–µ');
            return null;
        }
        
        let referrerId = null;
        let referrerData = null;
        
        referralsSnapshot.forEach((childSnapshot) => {
            const data = childSnapshot.val();
            if (data.referral_code === refCode) {
                referrerId = childSnapshot.key;
                referrerData = data;
            }
        });
        
        if (!referrerId || !referrerData) {
            console.log('‚ùå –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return null;
        }
        
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π:', referrerId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
        if (referrerData.referrals_count >= referrerData.max_referrals) {
            console.log('‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π');
            return null;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const usersSnapshot = await database.ref('users').once('value');
        let isNewUser = true;
        
        usersSnapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            if (userData.nickname && 
                userData.nickname.toLowerCase() === nickname.toLowerCase() && 
                childSnapshot.key !== newUserId) {
                isNewUser = false;
            }
        });
        
        if (!isNewUser) {
            console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            return null;
        }
        
        // –ù–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã
        const inviterReward = Math.floor(Math.random() * 5) + 1; // 1-5 –æ—á–∫–æ–≤
        const invitedReward = Math.floor(Math.random() * 3) + 1; // 1-3 –æ—á–∫–æ–≤
        
        console.log('üéØ –ù–∞–≥—Ä–∞–¥—ã:');
        console.log('   ‚Ä¢ –ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π:', inviterReward, '–æ—á–∫–æ–≤');
        console.log('   ‚Ä¢ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', invitedReward, '–æ—á–∫–æ–≤');
        
        // ========== 1. –û–ë–ù–û–í–õ–Ø–ï–ú –û–ß–ö–ò –ü–†–ò–ì–õ–ê–°–ò–í–®–ï–ì–û –í holiday_points ==========
        console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ...');
        const inviterPointsSnapshot = await database.ref('holiday_points/' + referrerId).once('value');
        let inviterPointsData;
        
        if (inviterPointsSnapshot.exists()) {
            inviterPointsData = inviterPointsSnapshot.val();
            console.log('   –¢–µ–∫—É—â–∏–µ –æ—á–∫–∏ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ:', inviterPointsData.total_points || 0);
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—á–∫–∏
            inviterPointsData.total_points = (inviterPointsData.total_points || 0) + inviterReward;
            inviterPointsData.available_points = (inviterPointsData.available_points || 0) + inviterReward;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞–≥—Ä–∞–¥ (–µ—Å–ª–∏ –Ω–µ—Ç –º–∞—Å—Å–∏–≤–∞ - —Å–æ–∑–¥–∞–µ–º)
            if (!inviterPointsData.rewards_history) {
                inviterPointsData.rewards_history = [];
            }
            
            const inviterRewardRecord = {
                date: new Date().toISOString(),
                points: inviterReward,
                type: 'referral_reward',
                description: `–ë–æ–Ω—É—Å –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞: ${nickname}`
            };
            
            inviterPointsData.rewards_history.unshift(inviterRewardRecord);
            
        } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å holiday_points –¥–ª—è –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
            inviterPointsData = {
                total_points: inviterReward,
                available_points: inviterReward,
                spent_points: 0,
                daily_gifts: {},
                rewards_history: [{
                    date: new Date().toISOString(),
                    points: inviterReward,
                    type: 'referral_reward',
                    description: `–ë–æ–Ω—É—Å –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞: ${nickname}`
                }],
                current_streak: 0,
                max_streak: 0,
                last_claim: null
            };
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ—á–∫–∏ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
        await database.ref('holiday_points/' + referrerId).set(inviterPointsData);
        console.log('   ‚úÖ –û—á–∫–∏ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', inviterPointsData.total_points, '–æ—á–∫–æ–≤');
        
        // ========== 2. –û–ë–ù–û–í–õ–Ø–ï–ú –û–ß–ö–ò –ù–û–í–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
        console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        const newUserPointsSnapshot = await database.ref('holiday_points/' + newUserId).once('value');
        let newUserPointsData;
        
        if (newUserPointsSnapshot.exists()) {
            newUserPointsData = newUserPointsSnapshot.val();
            newUserPointsData.total_points = (newUserPointsData.total_points || 0) + invitedReward;
            newUserPointsData.available_points = (newUserPointsData.available_points || 0) + invitedReward;
            
            if (!newUserPointsData.rewards_history) {
                newUserPointsData.rewards_history = [];
            }
        } else {
            newUserPointsData = {
                total_points: invitedReward,
                available_points: invitedReward,
                spent_points: 0,
                daily_gifts: {},
                rewards_history: [],
                current_streak: 0,
                max_streak: 0,
                last_claim: null
            };
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const newUserRewardRecord = {
            date: new Date().toISOString(),
            points: invitedReward,
            type: 'referral_bonus',
            description: `–ë–æ–Ω—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ`
        };
        
        newUserPointsData.rewards_history.unshift(newUserRewardRecord);
        
        await database.ref('holiday_points/' + newUserId).set(newUserPointsData);
        console.log('   ‚úÖ –û—á–∫–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', newUserPointsData.total_points, '–æ—á–∫–æ–≤');
        
        // ========== 3. –û–ë–ù–û–í–õ–Ø–ï–ú STATS –í REFERRALS ==========
        console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ referrals...');
        const updatedReferrerData = {
            ...referrerData,
            referrals_count: (referrerData.referrals_count || 0) + 1,
            total_points: (referrerData.total_points || 0) + inviterReward,
            referrals_list: [
                ...(referrerData.referrals_list || []),
                {
                    nickname: nickname,
                    date: new Date().toISOString(),
                    points_rewarded: inviterReward,
                    user_id: newUserId,
                    inviter_points: inviterReward,
                    invited_points: invitedReward
                }
            ]
        };
        
        await database.ref('referrals/' + referrerId).set(updatedReferrerData);
        console.log('   ‚úÖ –î–∞–Ω–Ω—ã–µ referrals –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        
        // ========== 4. –°–û–•–†–ê–ù–Ø–ï–ú –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –†–ï–§–ï–†–ê–õ–ï ==========
        console.log('üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ—Ñ–µ—Ä–∞–ª–µ...');
        await database.ref('users/' + newUserId).update({
            referred_by: referrerId,
            referral_bonus_received: invitedReward,
            referral_code_used: refCode
        });
        
        console.log('   ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Ñ–µ—Ä–∞–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        
        console.log('üéâ –†–ï–§–ï–†–ê–õ–¨–ù–´–ô –ë–û–ù–£–° –£–°–ü–ï–®–ù–û –ù–ê–ß–ò–°–õ–ï–ù!');
        console.log('==========================================');
        console.log('   –ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π ' + referrerId + ' –ø–æ–ª—É—á–∏–ª: ' + inviterReward + ' –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤');
        console.log('   –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + nickname + ' –ø–æ–ª—É—á–∏–ª: ' + invitedReward + ' –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤');
        console.log('==========================================');
        
        return {
            referrerId: referrerId,
            inviterReward: inviterReward,
            invitedReward: invitedReward
        };
        
    } catch (error) {
        console.error('‚ùå –û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–°–´–õ–ö–ò:', error);
        console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message);
        return null;
    }
}

// –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –° –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–û–ô
async function registerUser(nickname, password) {
    try {
        const newUserId = generateUserId(nickname);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const snapshot = await database.ref('users/' + newUserId).once('value');
        if (snapshot.exists()) {
            return { success: false, error: '–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç' };
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
        const refCode = localStorage.getItem('jojoland_referral_code');
        let referralResult = null;
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const now = new Date();
        const userData = {
            nickname: nickname,
            passwordHash: hashPassword(password),
            rank: 'player',
            createdAt: now.toISOString(),
            lastVisit: now.toISOString(),
            visitsCount: 1,
            registeredAt: Date.now(),
            stats: {
                totalVisits: 1,
                achievements: ['first_visit']
            }
        };
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        if (refCode) {
            referralResult = await processReferralCode(refCode, newUserId, nickname);
            // –û—á–∏—â–∞–µ–º –∫–æ–¥ –∏–∑ localStorage
            localStorage.removeItem('jojoland_referral_code');
            
            if (referralResult) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ñ–µ—Ä–∞–ª–µ
                userData.referred_by = referralResult.referrerId;
                userData.referral_bonus_received = referralResult.invitedReward;
                userData.referral_code_used = refCode;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        await database.ref('users/' + newUserId).set(userData);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('jojoland_nickname', nickname);
        localStorage.setItem('jojoland_userId', newUserId);
        localStorage.setItem('jojoland_loggedIn', 'true');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –±–æ–Ω—É—Å–æ–º –µ—Å–ª–∏ –µ—Å—Ç—å
        if (referralResult && referralResult.invitedReward) {
            showWelcomeNotification(nickname, true, referralResult.invitedReward);
        } else {
            showWelcomeNotification(nickname, true);
        }
        
        return { 
            success: true, 
            userData: userData, 
            referralBonus: referralResult?.invitedReward 
        };
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        return { success: false, error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' };
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç
async function updateLastVisit(userId, userData) {
    try {
        await database.ref('users/' + userId).update({
            lastVisit: new Date().toISOString(),
            visitsCount: (userData.visitsCount || 1) + 1
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞:', error);
    }
}

// ==================== –í–ê–õ–ò–î–ê–¶–ò–Ø –§–û–†–ú –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò ====================

let checkTimeout;

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
async function validateRegistrationForm() {
    const nickname = document.getElementById('reg-nickname').value.trim();
    const password = document.getElementById('reg-password').value;
    const confirmPassword = document.getElementById('reg-confirm-password').value;
    const registerBtn = document.getElementById('register-btn');
    const errorMsg = document.getElementById('reg-error');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
    const reqNickLength = document.getElementById('req-nick-length');
    const reqNickFormat = document.getElementById('req-nick-format');
    const reqNickUnique = document.getElementById('req-nick-unique');
    const reqPasswordLength = document.getElementById('req-password-length');
    const reqPasswordMatch = document.getElementById('req-password-match');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    errorMsg.textContent = '';
    registerBtn.disabled = true;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –Ω–∏–∫–∞
    if (nickname.length >= 3 && nickname.length <= 16) {
        reqNickLength.className = 'valid';
    } else {
        reqNickLength.className = 'invalid';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∏–∫–∞
    if (isValidNickname(nickname)) {
        reqNickFormat.className = 'valid';
    } else {
        reqNickFormat.className = 'invalid';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è
    if (isValidPassword(password)) {
        reqPasswordLength.className = 'valid';
    } else {
        reqPasswordLength.className = 'invalid';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
    if (password === confirmPassword && password.length > 0) {
        reqPasswordMatch.className = 'valid';
    } else {
        reqPasswordMatch.className = 'invalid';
    }
    
    // –ï—Å–ª–∏ –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∏–∫–∞
    if (nickname.length >= 3 && nickname.length <= 16 && 
        isValidNickname(nickname) && 
        isValidPassword(password) && 
        password === confirmPassword) {
        
        reqNickUnique.textContent = '‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        
        clearTimeout(checkTimeout);
        checkTimeout = setTimeout(async () => {
            const isUnique = await isNicknameUnique(nickname);
            
            if (isUnique) {
                reqNickUnique.className = 'valid';
                reqNickUnique.textContent = '‚úì –ù–∏–∫ —Å–≤–æ–±–æ–¥–µ–Ω';
                registerBtn.disabled = false;
            } else {
                reqNickUnique.className = 'invalid';
                reqNickUnique.textContent = '‚úó –ù–∏–∫ –∑–∞–Ω—è—Ç';
                errorMsg.textContent = '–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
            }
        }, 500);
    } else {
        reqNickUnique.textContent = '‚úó –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è';
        reqNickUnique.className = 'invalid';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
        if (nickname.length > 0) {
            if (nickname.length < 3) {
                errorMsg.textContent = '–ù–∏–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
            } else if (nickname.length > 16) {
                errorMsg.textContent = '–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 16 —Å–∏–º–≤–æ–ª–æ–≤';
            } else if (!isValidNickname(nickname)) {
                errorMsg.textContent = '–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª _';
            } else if (!isValidPassword(password)) {
                errorMsg.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
            } else if (password !== confirmPassword) {
                errorMsg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
            }
        }
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –Ω–∏–∫–∞
function updateCharCount() {
    const input = document.getElementById('reg-nickname');
    const charCount = document.getElementById('reg-char-count');
    const length = input.value.length;
    charCount.textContent = `${length}/16`;
    
    if (length < 3) {
        charCount.style.color = '#ff4444';
    } else if (length > 16) {
        charCount.style.color = '#ff4444';
    } else {
        charCount.style.color = '#00cc66';
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
function setupPasswordToggles() {
    const toggles = document.querySelectorAll('.password-toggle');
    toggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const inputId = this.id.replace('toggle-', '');
            const input = document.getElementById(inputId);
            
            if (input.type === 'password') {
                input.type = 'text';
                this.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
            } else {
                input.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
function setupAuthTabs() {
    const tabs = document.querySelectorAll('.auth-tab');
    const forms = document.querySelectorAll('.form-container');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ–æ—Ä–º—É
            forms.forEach(form => {
                form.classList.remove('active');
                if (form.id === `${tabName}-form`) {
                    form.classList.add('active');
                }
            });
            
            // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏
            document.getElementById('login-error').textContent = '';
            document.getElementById('reg-error').textContent = '';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            if (tabName === 'login') {
                document.getElementById('login-nickname').focus();
            } else {
                document.getElementById('reg-nickname').focus();
            }
        });
    });
    
    // –°—Å—ã–ª–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    document.getElementById('switch-to-register').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelector('[data-tab="register"]').click();
    });
    
    document.getElementById('switch-to-login').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelector('[data-tab="login"]').click();
    });
}

// ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞
function setupLoginHandler() {
    const loginBtn = document.getElementById('login-btn');
    const nicknameInput = document.getElementById('login-nickname');
    const passwordInput = document.getElementById('login-password');
    
    loginBtn.addEventListener('click', async function() {
        const nickname = nicknameInput.value.trim();
        const password = passwordInput.value;
        const errorMsg = document.getElementById('login-error');
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!nickname) {
            errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º';
            nicknameInput.focus();
            return;
        }
        
        if (!password) {
            errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
            passwordInput.focus();
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loginBtn.disabled = true;
        loginBtn.textContent = '–í—Ö–æ–¥...';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏
        const result = await loginUser(nickname, password);
        
        if (result.success) {
            loginBtn.textContent = '‚úì –£—Å–ø–µ—à–Ω–æ!';
            loginBtn.style.background = 'linear-gradient(90deg, #00cc66, #00ff88)';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                document.getElementById('auth-modal').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-modal').style.display = 'none';
                    updateHeaderForLoggedInUser(nickname);
                    showWelcomeNotification(nickname, false);
                }, 300);
            }, 1000);
        } else {
            loginBtn.textContent = '–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç';
            loginBtn.disabled = false;
            errorMsg.textContent = result.error;
            loginBtn.style.background = 'linear-gradient(90deg, #6200ff, #ff00ff)';
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ñ–æ—Ä–º–µ –≤—Ö–æ–¥–∞
    nicknameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') passwordInput.focus();
    });
    
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loginBtn.click();
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
function setupRegisterHandler() {
    const registerBtn = document.getElementById('register-btn');
    const nicknameInput = document.getElementById('reg-nickname');
    const passwordInput = document.getElementById('reg-password');
    const confirmInput = document.getElementById('reg-confirm-password');
    
    registerBtn.addEventListener('click', async function() {
        const nickname = nicknameInput.value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmInput.value;
        const errorMsg = document.getElementById('reg-error');
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (!isValidNickname(nickname)) {
            errorMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–∏–∫–∞';
            return;
        }
        
        if (!isValidPassword(password)) {
            errorMsg.textContent = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π';
            return;
        }
        
        if (password !== confirmPassword) {
            errorMsg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        registerBtn.disabled = true;
        registerBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
        const result = await registerUser(nickname, password);
        
        if (result.success) {
            registerBtn.textContent = '‚úì –£—Å–ø–µ—à–Ω–æ!';
            registerBtn.style.background = 'linear-gradient(90deg, #00cc66, #00ff88)';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                document.getElementById('auth-modal').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-modal').style.display = 'none';
                    updateHeaderForLoggedInUser(nickname);
                }, 300);
            }, 1000);
        } else {
            registerBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            registerBtn.disabled = false;
            errorMsg.textContent = result.error;
            registerBtn.style.background = 'linear-gradient(90deg, #6200ff, #ff00ff)';
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–µ–¥–µ—Ä–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function updateHeaderForLoggedInUser(nickname) {
    const profileLink = document.getElementById('profile-link');
    const logoutBtn = document.getElementById('logout-btn-header');
    
    if (profileLink) {
        profileLink.style.display = 'flex';
    }
    
    if (logoutBtn) {
        logoutBtn.style.display = 'flex';
        logoutBtn.addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                localStorage.removeItem('jojoland_nickname');
                localStorage.removeItem('jojoland_userId');
                localStorage.removeItem('jojoland_loggedIn');
                window.location.reload();
            }
        });
    }
}

// –ü–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showWelcomeNotification(nickname, isNew = false, referralBonus = null) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(90deg, ${isNew ? '#00cc66' : '#6200ff'}, ${isNew ? '#00ff88' : '#ff00ff'});
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        z-index: 1000;
        animation: slideInRight 0.5s ease;
        box-shadow: 0 5px 20px rgba(98, 0, 255, 0.5);
        max-width: 300px;
        font-family: 'Orbitron', sans-serif;
    `;
    
    let message = isNew ? `üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!` : `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!`;
    let details = isNew ? `–ê–∫–∫–∞—É–Ω—Ç ${nickname} —Å–æ–∑–¥–∞–Ω!` : `–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞, ${nickname}!`;
    
    if (referralBonus) {
        message = `üéÅ +${referralBonus} –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤!`;
        details = `–í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ!`;
    }
    
    notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">
            ${message}
        </div>
        <div style="font-size: 12px; opacity: 0.9;">
            ${details}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
function checkAuth() {
    const isLoggedIn = localStorage.getItem('jojoland_loggedIn') === 'true';
    const nickname = localStorage.getItem('jojoland_nickname');
    
    if (isLoggedIn && nickname) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        updateHeaderForLoggedInUser(nickname);
        return false; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    }
    
    return true; // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ====================

window.onload = async function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    checkReferralOnPageLoad();
    
    createParticles();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById("loader").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("content").style.opacity = "1";
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (checkAuth()) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            document.getElementById('auth-modal').style.display = 'flex';
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—Å—ë
            setupAuthTabs();
            setupPasswordToggles();
            setupLoginHandler();
            setupRegisterHandler();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            const regNicknameInput = document.getElementById('reg-nickname');
            const regPasswordInput = document.getElementById('reg-password');
            const regConfirmInput = document.getElementById('reg-confirm-password');
            
            regNicknameInput.addEventListener('input', () => {
                updateCharCount();
                validateRegistrationForm();
            });
            
            regPasswordInput.addEventListener('input', validateRegistrationForm);
            regConfirmInput.addEventListener('input', validateRegistrationForm);
            
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∏–∫–∞ –≤ —Ñ–æ—Ä–º–µ –≤—Ö–æ–¥–∞
            setTimeout(() => {
                document.getElementById('login-nickname').focus();
            }, 300);
        }
    }, 400);
};

// –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(style);
</script>

</body>
</html>
