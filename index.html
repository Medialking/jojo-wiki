<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JojoLand ‚Äî –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- –ò–≥—Ä–æ–≤–æ–π —à—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* –ü–†–û–°–¢–´–ï –≠–§–§–ï–ö–¢–´ –§–û–ù–ê */
        .background-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }
        
        /* –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—ã */
        .form-container {
            display: none;
        }
        
        .form-container.active {
            display: block;
        }
    </style>
</head>
<body>

<!-- –ê–ù–ò–ú–ê–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
<div id="auth-modal" class="modal-overlay">
    <div class="modal-content">
        <!-- –í–ö–õ–ê–î–ö–ò –í–•–û–î/–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">–í—Ö–æ–¥</button>
            <button class="auth-tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
        <div id="login-form" class="form-container active">
            <div class="modal-header">
                <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <label for="login-nickname">–ù–∏–∫–Ω–µ–π–º:</label>
                    <input 
                        type="text" 
                        id="login-nickname" 
                        placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º"
                        autocomplete="username"
                    >
                </div>
                
                <div class="input-group">
                    <label for="login-password">–ü–∞—Ä–æ–ª—å:</label>
                    <input 
                        type="password" 
                        id="login-password" 
                        placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å"
                        autocomplete="current-password"
                    >
                    <div class="password-toggle" id="toggle-login-password">üëÅÔ∏è</div>
                </div>
                
                <div class="error-message" id="login-error"></div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ email -->
                <div class="switch-login-type">
                    <button id="switch-to-email-login" class="switch-login-type-btn">
                        <span class="email-icon">üìß</span> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ email
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="login-btn" class="submit-btn">
                    –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
                </button>
                
                <p class="modal-note">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="switch-to-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </p>
            </div>
        </div>
        
        <!-- –§–û–†–ú–ê –í–•–û–î–ê –ß–ï–†–ï–ó EMAIL -->
        <div id="login-email-form" class="form-container">
            <div class="modal-header">
                <h2>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ email</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞</p>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <label for="login-email">Email –∞–¥—Ä–µ—Å:</label>
                    <input 
                        type="email" 
                        id="login-email" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π email"
                        autocomplete="email"
                    >
                </div>
                
                <div id="login-code-section" style="display: none;">
                    <div class="input-group">
                        <label for="login-code">–ö–æ–¥ –∏–∑ email:</label>
                        <input 
                            type="text" 
                            id="login-code" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥"
                            maxlength="6"
                            autocomplete="one-time-code"
                        >
                    </div>
                    
                    <div id="login-code-timer" style="color: #ff9800; font-size: 14px; margin-bottom: 10px;">
                        ‚è≥ –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: 5:00
                    </div>
                </div>
                
                <div class="error-message" id="login-email-error"></div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –æ–±—ã—á–Ω–æ–º—É –≤—Ö–æ–¥—É -->
                <div class="switch-login-type">
                    <button id="switch-to-nickname-login" class="switch-login-type-btn">
                        <span class="nickname-icon">üë§</span> –í–æ–π—Ç–∏ –ø–æ –Ω–∏–∫–Ω–µ–π–º—É
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="login-email-btn" class="submit-btn">
                    üìß –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
                </button>
                
                <p class="modal-note">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="switch-to-register2">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </p>
            </div>
        </div>
        
        <!-- –§–û–†–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
        <div id="register-form" class="form-container">
            <div class="modal-header">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <label for="reg-nickname">–ù–∏–∫–Ω–µ–π–º:</label>
                    <input 
                        type="text" 
                        id="reg-nickname" 
                        placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫ (3-16 —Å–∏–º–≤–æ–ª–æ–≤)"
                        maxlength="16"
                        autocomplete="username"
                    >
                    <div class="input-hint">
                        <span id="reg-char-count">0/16</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="reg-password">–ü–∞—Ä–æ–ª—å:</label>
                    <input 
                        type="password" 
                        id="reg-password" 
                        placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)"
                        autocomplete="new-password"
                    >
                    <div class="password-toggle" id="toggle-reg-password">üëÅÔ∏è</div>
                </div>
                
                <div class="input-group">
                    <label for="reg-confirm-password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input 
                        type="password" 
                        id="reg-confirm-password" 
                        placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        autocomplete="new-password"
                    >
                    <div class="password-toggle" id="toggle-reg-confirm">üëÅÔ∏è</div>
                </div>
                
                <div class="requirements">
                    <h4>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</h4>
                    <ul>
                        <li id="req-nick-length" class="invalid">‚úì –ù–∏–∫: 3-16 —Å–∏–º–≤–æ–ª–æ–≤</li>
                        <li id="req-nick-format" class="invalid">‚úì –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _</li>
                        <li id="req-nick-unique" class="valid">‚úì –ù–∏–∫ —Å–≤–æ–±–æ–¥–µ–Ω</li>
                        <li id="req-password-length" class="invalid">‚úì –ü–∞—Ä–æ–ª—å: –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</li>
                        <li id="req-password-match" class="invalid">‚úì –ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç</li>
                    </ul>
                </div>
                
                <div class="error-message" id="reg-error"></div>
            </div>
            
            <div class="modal-footer">
                <button id="register-btn" class="submit-btn" disabled>
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                <p class="modal-note">
                    –ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="switch-to-login">–í–æ–π—Ç–∏</a>
                </p>
            </div>
        </div>
        
        <div class="server-info-small">
            <span>IP —Å–µ—Ä–≤–µ—Ä–∞: <strong>play.jojoland.ru</strong></span>
        </div>
    </div>
</div>

<!-- –§–û–ù–û–í–´–ï –≠–§–§–ï–ö–¢–´ -->
<div class="background-effects" id="particles"></div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
<div id="content">

<header>
    <div class="header-top">
        <a href="profle/profile.html" class="profile-btn" id="profile-link" style="display: none;">
            <span class="profile-icon">üë§</span>
            <span class="profile-text">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
        <button class="profile-btn" id="logout-btn-header" style="display: none;">
            <span class="profile-icon">üö™</span>
            <span class="profile-text">–í—ã–π—Ç–∏</span>
        </button>
        <img src="images/logo.png" class="logo" alt="JojoLand Logo">
    </div>
    
    <h1>JojoLand</h1>
    <p class="subtitle">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç —Å–µ—Ä–≤–µ—Ä–∞</p>

    <nav>
        <a href="rules.html" class="nav-btn">üìú –ü—Ä–∞–≤–∏–ª–∞</a>
        <a href="tgk.html" class="nav-btn">üìò TGK</a>
        <a href="obzhalovanie.html" class="nav-btn">üîê –û–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ</a>
    </nav>
</header>

<main class="main-content">
    <!-- –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ô –ë–õ–û–ö -->
    <div class="info-block">
        <h2>–ì–ª–∞–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞</h2>
        <p>–í—Å–µ –≤–∞–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∏–≥—Ä—ã –Ω–∞ –Ω–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ</p>
    </div>

    <!-- –ì–õ–ê–í–ù–´–ï –ö–ù–û–ü–ö–ò -->
    <div class="button-grid">
        <a href="https://t.me/+18-ycRRnOTgxZTgy" class="main-btn tgk-btn">
            <div class="btn-icon">üìå</div>
            <div class="btn-content">
                <h3>TGK —á–∞—Ç</h3>
                <p>–û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤</p>
            </div>
        </a>
        
        <a href="https://t.me/Jojolandpe" class="main-btn tg-btn">
            <div class="btn-icon">üí¨</div>
            <div class="btn-content">
                <h3>Telegram –≥—Ä—É–ø–ø–∞</h3>
                <p>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram-–∫–∞–Ω–∞–ª</p>
            </div>
        </a>
        
        <a href="http://pay.jojoland.ru/" class="main-btn donate-btn">
            <div class="btn-icon">üíé</div>
            <div class="btn-content">
                <h3>–î–æ–Ω–∞—Ç —Å–∞–π—Ç</h3>
                <p>–ü–æ–∫—É–ø–∫–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π</p>
            </div>
        </a>
        
        <a href="points.html" class="main-btn points-btn">
            <div class="btn-icon">üéÅ</div>
            <div class="btn-content">
                <h3>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏</h3>
                <p>–°–æ–±–µ—Ä–∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –æ—á–∫–∏</p>
            </div>
        </a>

        <a href="casino/casino.html" class="main-btn casino-btn">
            <div class="btn-icon">üé∞</div>
            <div class="btn-content">
                <h3>–ö–∞–∑–∏–Ω–æ</h3>
                <p>–ò—Å–ø—ã—Ç–∞–π—Ç–µ —É–¥–∞—á—É –≤ –∏–≥—Ä–∞—Ö</p>
            </div>
        </a>
        
        <a href="players.html" class="main-btn players-btn">
            <div class="btn-icon">üë•</div>
            <div class="btn-content">
                <h3>–ò–≥—Ä–æ–∫–∏</h3>
                <p>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞</p>
            </div>
        </a>

        <a href="promo/promo-user.html" class="main-btn players-btn">
            <div class="btn-icon">üéüÔ∏è</div>
            <div class="btn-content">
                <h3>–ü—Ä–æ–º–æ–∫–æ–¥</h3>
                <p>–í–æ–¥ –ü—Ä–æ–º–æ–∫–æ–¥–æ–≤</p>
            </div>
        </a>
    </div>

    <!-- –ë–´–°–¢–†–´–ï –°–°–´–õ–ö–ò -->
    <div class="quick-links">
        <h3>–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</h3>
        <div class="faq-items">
            <div class="faq-item">
                <h4>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—é?</h4>
                <p>–ö—É–ø–∏—Ç–µ –µ—ë –Ω–∞ –Ω–∞—à–µ–º <a href="http://pay.jojoland.ru/">–¥–æ–Ω–∞—Ç —Å–∞–π—Ç–µ</a></p>
            </div>
            <div class="faq-item">
                <h4>–ö–∞–∫ –≤—Å—Ç—É–ø–∏—Ç—å –≤ TGK?</h4>
                <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "TGK —á–∞—Ç" –≤—ã—à–µ</p>
            </div>
            <div class="faq-item">
                <h4>–ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏?</h4>
                <p>–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –≤–∞–ª—é—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>
            </div>
        </div>
    </div>

    <!-- –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ô –ë–õ–û–ö -->
    <div class="server-info">
        <h3>–û —Å–µ—Ä–≤–µ—Ä–µ JojoLand</h3>
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç —Å–µ—Ä–≤–µ—Ä–∞ <strong>JojoLand</strong>! –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥—ë—Ç–µ –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∏–≥—Ä—ã.</p>
        <p>–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Minecraft —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –∏ –ø–ª–∞–≥–∏–Ω–æ–≤.</p>
        
        <div class="holiday-info">
            <h4>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ 2025</h4>
            <p>–°–æ–±–∏—Ä–∞–π—Ç–µ <strong>–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏</strong>, —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã!</p>
            <a href="points.html" class="holiday-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–∞—Ö ‚Üí</a>
        </div>
    </div>
</main>

<!-- –ö–ù–û–ü–ö–ê –ë–´–°–¢–†–û–ô –ü–û–ú–û–©–ò -->
<a class="help-btn" href="chat.html" target="_blank">
    <div class="help-icon">üí¨</div>
    <span>–ü–æ–º–æ—â—å</span>
</a>

<footer>
    <div class="footer-content">
        <p>¬© 2025 JojoLand ‚Ä¢ –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
        <p class="footer-ip">IP: play.jojoland.ru</p>
    </div>
</footer>

</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
// ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================

// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};

// EmailJS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const EMAILJS_CONFIG = {
    serviceId: 'jojo_server',
    userId: 'A8kpGOp5ovcEi40iA',
    
    // –í—Å–µ —à–∞–±–ª–æ–Ω—ã
    templates: {
        verification: 'template_elaqg7b',           // –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email
        login: 'template_z6q3aqf',              // –î–ª—è –∫–æ–¥–æ–≤ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ email
        // password_change: 'template_password_change', // –î–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
        // email_change: 'template_email_change',       // –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è email
        // security: 'template_security'               // –î–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    }
};

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

// –°–û–ó–î–ê–ù–ò–ï –§–û–ù–û–í–´–• –ß–ê–°–¢–ò–¶
function createParticles() {
    const particlesContainer = document.getElementById('particles');
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        
        const size = Math.random() * 2 + 1;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        particle.style.opacity = Math.random() * 0.5 + 0.2;
        
        const duration = Math.random() * 20 + 15;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${Math.random() * 10}s`;
        
        particlesContainer.appendChild(particle);
    }
}

// –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
function hashPassword(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString(16);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ 6-–∑–Ω–∞—á–Ω–æ–≥–æ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ ID
function generateRandomId() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ ID
async function isUserIdUnique(userId) {
    try {
        const snapshot = await database.ref('users/' + userId).once('value');
        return !snapshot.exists();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ ID:', error);
        return false;
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
async function generateUniqueId() {
    let attempts = 0;
    const maxAttempts = 10;
    
    while (attempts < maxAttempts) {
        const newId = generateRandomId();
        const isUnique = await isUserIdUnique(newId);
        
        if (isUnique) {
            console.log(`‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID: ${newId} (–ø–æ–ø—ã—Ç–∫–∞ ${attempts + 1})`);
            return newId;
        }
        
        attempts++;
        console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempts}: ID ${newId} —É–∂–µ –∑–∞–Ω—è—Ç, –ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...`);
    }
    
    return generateRandomId();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞
function isValidNickname(nickname) {
    if (nickname.length < 3 || nickname.length > 16) {
        return false;
    }
    const regex = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]+$/;
    return regex.test(nickname);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
function isValidPassword(password) {
    return password.length >= 6;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞
async function isNicknameUnique(nickname) {
    try {
        const snapshot = await database.ref('users').once('value');
        let isUnique = true;
        
        snapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            if (userData.nickname && 
                userData.nickname.toLowerCase() === nickname.toLowerCase()) {
                isUnique = false;
            }
        });
        
        return isUnique;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∏–∫–∞:', error);
        return false;
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è email
async function checkEmailExists(email) {
    try {
        const snapshot = await database.ref('users').once('value');
        let userData = null;
        let userId = null;
        
        snapshot.forEach((childSnapshot) => {
            const data = childSnapshot.val();
            if (data.email && 
                data.email.toLowerCase() === email.toLowerCase() &&
                data.emailVerified === true) {
                userData = data;
                userId = childSnapshot.key;
            }
        });
        
        return { exists: !!userData, userData: userData, userId: userId };
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ email:', error);
        return { exists: false };
    }
}

// ==================== EMAILJS –§–£–ù–ö–¶–ò–ò ====================

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email —á–µ—Ä–µ–∑ EmailJS
 * @param {string} email - Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è
 * @param {string} code - –ö–æ–¥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
 * @param {string} nickname - –ù–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} templateType - –¢–∏–ø —à–∞–±–ª–æ–Ω–∞ ('verification' –∏–ª–∏ 'login')
 * @returns {Promise<boolean>} - –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
async function sendEmailCode(email, code, nickname, templateType = 'verification') {
    console.log(`üìß –û—Ç–ø—Ä–∞–≤–∫–∞ email (${templateType})...`);
    console.log('–ü–æ–ª—É—á–∞—Ç–µ–ª—å:', email);
    console.log('–ö–æ–¥:', code);
    console.log('–ò–º—è:', nickname);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ EmailJS
    if (typeof emailjs === 'undefined') {
        console.log('‚ö†Ô∏è EmailJS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º');
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —à–∞–±–ª–æ–Ω–∞
    const templateId = EMAILJS_CONFIG.templates[templateType];
    if (!templateId) {
        console.error(`‚ùå –®–∞–±–ª–æ–Ω ${templateType} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏`);
        return false;
    }
    
    try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmailJS
        emailjs.init(EMAILJS_CONFIG.userId);
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —à–∞–±–ª–æ–Ω–∞
        const templateParams = {
            nickname: nickname || '–ò–≥—Ä–æ–∫',
            email: email,
            code: code,
            site_url: window.location.origin || 'https://medialking.github.io/jojo-wiki/index.html'
        };
        
        console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å —à–∞–±–ª–æ–Ω–æ–º ${templateType}:`, templateParams);
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ email
        const response = await emailjs.send(
            EMAILJS_CONFIG.serviceId,
            templateId,
            templateParams
        );
        
        console.log(`‚úÖ Email (${templateType}) —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –°—Ç–∞—Ç—É—Å:`, response.status);
        
        // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        const messages = {
            verification: 'üìß –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email',
            login: 'üìß –ö–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email'
        };
        
        showNotification(messages[templateType] || 'üìß Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
        return true;
        
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email (${templateType}):`, {
            status: error.status,
            text: error.text,
            fullError: error
        });
        
        // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏
        return sendEmailTestMode(email, code, nickname, templateType);
    }
}

/**
 * –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–≥–¥–∞ EmailJS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
 */
function sendEmailTestMode(email, code, nickname, templateType) {
    const templates = {
        verification: {
            title: '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email',
            color: '#6200ff',
            gradient: 'linear-gradient(90deg, #6200ff, #ff00ff)',
            purpose: `–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email: <strong>${email}</strong>`
        },
        login: {
            title: '–ö–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ email',
            color: '#00b4d8',
            gradient: 'linear-gradient(90deg, #00b4d8, #0096c7)',
            purpose: `–î–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç <strong>${nickname || '–ò–≥—Ä–æ–∫'}</strong>`
        }
    };
    
    const template = templates[templateType] || templates.verification;
    
    const notificationHTML = `
        <div style="text-align: center;">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; 
                color: ${template.color};">
                üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
            </div>
            <div style="margin-bottom: 15px;">
                ${template.purpose}
            </div>
            <div style="background: ${template.gradient}; 
                color: white; 
                padding: 15px; 
                border-radius: 10px; 
                margin: 15px 0;
                font-family: 'Courier New', monospace;">
                <div style="font-size: 14px; margin-bottom: 5px;">${template.title}:</div>
                <div style="font-size: 28px; font-weight: bold; letter-spacing: 3px;">
                    ${code}
                </div>
            </div>
            <div style="font-size: 12px; color: #666;">
                –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ—Ç –∫–æ–¥ –±—ã–ª –±—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email
            </div>
        </div>
    `;
    
    showNotification(notificationHTML, 'info');
    return false;
}

// ==================== –í–•–û–î –ß–ï–†–ï–ó EMAIL ====================

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ email
async function sendEmailLoginCode(email) {
    console.log('üìß –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –¥–ª—è –≤—Ö–æ–¥–∞ –Ω–∞:', email);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ email
    const emailCheck = await checkEmailExists(email);
    if (!emailCheck.exists) {
        return { success: false, error: 'Email –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É' };
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
    const loginCode = Math.floor(100000 + Math.random() * 900000).toString();
    const userId = emailCheck.userId;
    
    console.log('üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞:', loginCode);
    console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', emailCheck.userData.nickname);
    
    try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –≤ Firebase (–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç)
        await database.ref('email_login_codes/' + userId).set({
            code: loginCode,
            email: email,
            created: new Date().toISOString(),
            expires: new Date(Date.now() + 5 * 60000).toISOString(),
            used: false
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email —Å –∫–æ–¥–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω 'login')
        const emailSent = await sendEmailCode(email, loginCode, emailCheck.userData.nickname, 'login');
        
        if (emailSent) {
            console.log('‚úÖ Email —Å –∫–æ–¥–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            localStorage.setItem('pending_email_login', email);
            localStorage.setItem('pending_user_id', userId);
            
            return { 
                success: true, 
                message: '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email',
                userId: userId
            };
        } else {
            // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            localStorage.setItem('pending_email_login', email);
            localStorage.setItem('pending_user_id', userId);
            
            return { 
                success: true, 
                message: '–ö–æ–¥ –ø–æ–∫–∞–∑–∞–Ω –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)',
                userId: userId,
                testCode: loginCode
            };
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', error);
        return { success: false, error: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞' };
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ email
async function verifyEmailLoginCode(code) {
    const userId = localStorage.getItem('pending_user_id');
    const email = localStorage.getItem('pending_email_login');
    
    if (!userId || !email) {
        return { success: false, error: '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞' };
    }
    
    try {
        // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–æ–¥
        const snapshot = await database.ref('email_login_codes/' + userId).once('value');
        if (!snapshot.exists()) {
            return { success: false, error: '–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫' };
        }
        
        const codeData = snapshot.val();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è (5 –º–∏–Ω—É—Ç)
        const expires = new Date(codeData.expires);
        if (new Date() > expires) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –∫–æ–¥
            await database.ref('email_login_codes/' + userId).remove();
            return { success: false, error: '–ö–æ–¥ –∏—Å—Ç–µ–∫' };
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
        if (codeData.code !== code) {
            return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥' };
        }
        
        if (codeData.used === true) {
            return { success: false, error: '–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' };
        }
        
        // –ü–æ–º–µ—á–∞–µ–º –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
        await database.ref('email_login_codes/' + userId).update({
            used: true,
            usedAt: new Date().toISOString()
        });
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userSnapshot = await database.ref('users/' + userId).once('value');
        const userData = userSnapshot.val();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
        localStorage.setItem('jojoland_nickname', userData.nickname);
        localStorage.setItem('jojoland_userId', userId);
        localStorage.setItem('jojoland_loggedIn', 'true');
        
        // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        localStorage.removeItem('pending_email_login');
        localStorage.removeItem('pending_user_id');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç
        await updateLastVisit(userId, userData);
        
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –≤—Ö–æ–¥–æ–≤
        await database.ref('login_history/' + userId).push({
            type: 'email_login',
            timestamp: new Date().toISOString(),
            success: true,
            ip: await getClientIP()
        });
        
        return { 
            success: true, 
            userData: userData, 
            userId: userId 
        };
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞:', error);
        return { success: false, error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' };
    }
}

// ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–≤—Ö–æ–¥ –ø–æ –Ω–∏–∫—É) ====================

async function loginUser(nickname, password) {
    try {
        const snapshot = await database.ref('users').once('value');
        let foundUserId = null;
        let foundUserData = null;
        
        // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫–Ω–µ–π–º—É
        snapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            if (userData.nickname && 
                userData.nickname.toLowerCase() === nickname.toLowerCase()) {
                foundUserId = childSnapshot.key;
                foundUserData = userData;
            }
        });
        
        if (!foundUserId || !foundUserData) {
            return { success: false, error: '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' };
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
        const passwordHash = hashPassword(password);
        
        if (foundUserData.passwordHash !== passwordHash) {
            return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å' };
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
        localStorage.setItem('jojoland_nickname', nickname);
        localStorage.setItem('jojoland_userId', foundUserId);
        localStorage.setItem('jojoland_loggedIn', 'true');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç
        await updateLastVisit(foundUserId, foundUserData);
        
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –≤—Ö–æ–¥–æ–≤
        await database.ref('login_history/' + foundUserId).push({
            type: 'password_login',
            timestamp: new Date().toISOString(),
            success: true,
            ip: await getClientIP()
        });
        
        return { success: true, userData: foundUserData, userId: foundUserId };
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        return { success: false, error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' };
    }
}

// ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ====================

async function registerUser(nickname, password) {
    try {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π 6-–∑–Ω–∞—á–Ω—ã–π ID
        const newUserId = await generateUniqueId();
        
        console.log('üéØ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:');
        console.log('   –ù–∏–∫–Ω–µ–π–º:', nickname);
        console.log('   –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID:', newUserId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º
        const allUsersSnapshot = await database.ref('users').once('value');
        let nicknameExists = false;
        
        allUsersSnapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            if (userData.nickname && 
                userData.nickname.toLowerCase() === nickname.toLowerCase()) {
                nicknameExists = true;
            }
        });
        
        if (nicknameExists) {
            console.log('‚ùå –ù–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç:', nickname);
            return { success: false, error: '–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç' };
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const now = new Date();
        const userData = {
            nickname: nickname,
            passwordHash: hashPassword(password),
            rank: 'player',
            createdAt: now.toISOString(),
            lastVisit: now.toISOString(),
            visitsCount: 1,
            registeredAt: Date.now(),
            userId: newUserId, // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–∞–∫–∂–µ –≤–Ω—É—Ç—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
            stats: {
                totalVisits: 1,
                achievements: ['first_visit']
            }
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase –ø–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ID
        await database.ref('users/' + newUserId).set(userData);
        
        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ Firebase');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('jojoland_nickname', nickname);
        localStorage.setItem('jojoland_userId', newUserId);
        localStorage.setItem('jojoland_loggedIn', 'true');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        showWelcomeNotification(nickname, true);
        
        return { 
            success: true, 
            userData: userData, 
            userId: newUserId
        };
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        return { success: false, error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' };
    }
}

// ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç
async function updateLastVisit(userId, userData) {
    try {
        await database.ref('users/' + userId).update({
            lastVisit: new Date().toISOString(),
            visitsCount: (userData.visitsCount || 1) + 1
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞:', error);
    }
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    
    const colors = {
        success: { bg: '#00cc66', border: '#00ff88' },
        error: { bg: '#ff4444', border: '#ff6b6b' },
        warning: { bg: '#ff9800', border: '#ffb347' },
        info: { bg: '#00b4d8', border: '#48cae4' }
    };
    
    const color = colors[type] || colors.success;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(90deg, ${color.bg}, ${color.border});
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        z-index: 1000;
        animation: slideInRight 0.5s ease;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        max-width: 300px;
        font-family: 'Orbitron', sans-serif;
        border: 2px solid ${color.border};
    `;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ HTML
    if (typeof message === 'string' && message.includes('<')) {
        notification.innerHTML = message;
    } else {
        notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 5px;">
                ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                ${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ!' : type === 'error' ? '–û—à–∏–±–∫–∞!' : type === 'warning' ? '–í–Ω–∏–º–∞–Ω–∏–µ!' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}
            </div>
            <div style="font-size: 14px;">
                ${message}
            </div>
        `;
    }
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

async function getClientIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
}

// ==================== –í–ê–õ–ò–î–ê–¶–ò–Ø –§–û–†–ú –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò ====================

let checkTimeout;

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
async function validateRegistrationForm() {
    const nickname = document.getElementById('reg-nickname').value.trim();
    const password = document.getElementById('reg-password').value;
    const confirmPassword = document.getElementById('reg-confirm-password').value;
    const registerBtn = document.getElementById('register-btn');
    const errorMsg = document.getElementById('reg-error');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
    const reqNickLength = document.getElementById('req-nick-length');
    const reqNickFormat = document.getElementById('req-nick-format');
    const reqNickUnique = document.getElementById('req-nick-unique');
    const reqPasswordLength = document.getElementById('req-password-length');
    const reqPasswordMatch = document.getElementById('req-password-match');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    errorMsg.textContent = '';
    registerBtn.disabled = true;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –Ω–∏–∫–∞
    if (nickname.length >= 3 && nickname.length <= 16) {
        reqNickLength.className = 'valid';
    } else {
        reqNickLength.className = 'invalid';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∏–∫–∞
    if (isValidNickname(nickname)) {
        reqNickFormat.className = 'valid';
    } else {
        reqNickFormat.className = 'invalid';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è
    if (isValidPassword(password)) {
        reqPasswordLength.className = 'valid';
    } else {
        reqPasswordLength.className = 'invalid';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
    if (password === confirmPassword && password.length > 0) {
        reqPasswordMatch.className = 'valid';
    } else {
        reqPasswordMatch.className = 'invalid';
    }
    
    // –ï—Å–ª–∏ –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∏–∫–∞
    if (nickname.length >= 3 && nickname.length <= 16 && 
        isValidNickname(nickname) && 
        isValidPassword(password) && 
        password === confirmPassword) {
        
        reqNickUnique.textContent = '‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        
        clearTimeout(checkTimeout);
        checkTimeout = setTimeout(async () => {
            const isUnique = await isNicknameUnique(nickname);
            
            if (isUnique) {
                reqNickUnique.className = 'valid';
                reqNickUnique.textContent = '‚úì –ù–∏–∫ —Å–≤–æ–±–æ–¥–µ–Ω';
                registerBtn.disabled = false;
            } else {
                reqNickUnique.className = 'invalid';
                reqNickUnique.textContent = '‚úó –ù–∏–∫ –∑–∞–Ω—è—Ç';
                errorMsg.textContent = '–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
            }
        }, 500);
    } else {
        reqNickUnique.textContent = '‚úó –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è';
        reqNickUnique.className = 'invalid';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
        if (nickname.length > 0) {
            if (nickname.length < 3) {
                errorMsg.textContent = '–ù–∏–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
            } else if (nickname.length > 16) {
                errorMsg.textContent = '–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 16 —Å–∏–º–≤–æ–ª–æ–≤';
            } else if (!isValidNickname(nickname)) {
                errorMsg.textContent = '–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª _';
            } else if (!isValidPassword(password)) {
                errorMsg.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
            } else if (password !== confirmPassword) {
                errorMsg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
            }
        }
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –Ω–∏–∫–∞
function updateCharCount() {
    const input = document.getElementById('reg-nickname');
    const charCount = document.getElementById('reg-char-count');
    const length = input.value.length;
    charCount.textContent = `${length}/16`;
    
    if (length < 3) {
        charCount.style.color = '#ff4444';
    } else if (length > 16) {
        charCount.style.color = '#ff4444';
    } else {
        charCount.style.color = '#00cc66';
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
function setupPasswordToggles() {
    const toggles = document.querySelectorAll('.password-toggle');
    toggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const inputId = this.id.replace('toggle-', '');
            const input = document.getElementById(inputId);
            
            if (input.type === 'password') {
                input.type = 'text';
                this.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
            } else {
                input.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
function setupAuthTabs() {
    const tabs = document.querySelectorAll('.auth-tab');
    const forms = document.querySelectorAll('.form-container');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ–æ—Ä–º—É
            forms.forEach(form => {
                form.classList.remove('active');
                if (form.id === `${tabName}-form`) {
                    form.classList.add('active');
                }
            });
            
            // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏
            document.getElementById('login-error').textContent = '';
            document.getElementById('reg-error').textContent = '';
            document.getElementById('login-email-error').textContent = '';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            if (tabName === 'login') {
                document.getElementById('login-nickname').focus();
            } else if (tabName === 'register') {
                document.getElementById('reg-nickname').focus();
            }
        });
    });
    
    // –°—Å—ã–ª–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    document.getElementById('switch-to-register').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelector('[data-tab="register"]').click();
    });
    
    document.getElementById('switch-to-register2').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelector('[data-tab="register"]').click();
    });
    
    document.getElementById('switch-to-login').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelector('[data-tab="login"]').click();
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤—Ö–æ–¥–æ–º –ø–æ –Ω–∏–∫—É –∏ email
function setupLoginTypeSwitchers() {
    const toEmailBtn = document.getElementById('switch-to-email-login');
    const toNicknameBtn = document.getElementById('switch-to-nickname-login');
    
    toEmailBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –ø–æ –Ω–∏–∫—É
        document.getElementById('login-form').classList.remove('active');
        document.getElementById('login-form').style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –ø–æ email
        document.getElementById('login-email-form').classList.add('active');
        document.getElementById('login-email-form').style.display = 'block';
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('login-email').focus();
        document.getElementById('login-email-error').textContent = '';
        document.getElementById('login-code-section').style.display = 'none';
        document.getElementById('login-email-btn').textContent = 'üìß –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥';
    });
    
    toNicknameBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –ø–æ email
        document.getElementById('login-email-form').classList.remove('active');
        document.getElementById('login-email-form').style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ –ø–æ –Ω–∏–∫—É
        document.getElementById('login-form').classList.add('active');
        document.getElementById('login-form').style.display = 'block';
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        document.getElementById('login-nickname').focus();
        document.getElementById('login-error').textContent = '';
    });
}

// ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ –Ω–∏–∫—É
function setupLoginHandler() {
    const loginBtn = document.getElementById('login-btn');
    const nicknameInput = document.getElementById('login-nickname');
    const passwordInput = document.getElementById('login-password');
    
    loginBtn.addEventListener('click', async function() {
        const nickname = nicknameInput.value.trim();
        const password = passwordInput.value;
        const errorMsg = document.getElementById('login-error');
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!nickname) {
            errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º';
            nicknameInput.focus();
            return;
        }
        
        if (!password) {
            errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
            passwordInput.focus();
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loginBtn.disabled = true;
        loginBtn.textContent = '–í—Ö–æ–¥...';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏
        const result = await loginUser(nickname, password);
        
        if (result.success) {
            loginBtn.textContent = '‚úì –£—Å–ø–µ—à–Ω–æ!';
            loginBtn.style.background = 'linear-gradient(90deg, #00cc66, #00ff88)';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                document.getElementById('auth-modal').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-modal').style.display = 'none';
                    updateHeaderForLoggedInUser(nickname);
                    showWelcomeNotification(nickname, false);
                }, 300);
            }, 1000);
        } else {
            loginBtn.textContent = '–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç';
            loginBtn.disabled = false;
            errorMsg.textContent = result.error;
            loginBtn.style.background = 'linear-gradient(90deg, #6200ff, #ff00ff)';
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ñ–æ—Ä–º–µ –≤—Ö–æ–¥–∞
    nicknameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') passwordInput.focus();
    });
    
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loginBtn.click();
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ email
function setupEmailLoginHandler() {
    const emailLoginBtn = document.getElementById('login-email-btn');
    const emailInput = document.getElementById('login-email');
    const codeInput = document.getElementById('login-code');
    
    emailLoginBtn.addEventListener('click', async function() {
        const email = emailInput.value.trim();
        const code = codeInput ? codeInput.value.trim() : '';
        const errorMsg = document.getElementById('login-email-error');
        const codeSection = document.getElementById('login-code-section');
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è email
        if (!email) {
            errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å';
            emailInput.focus();
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
            emailInput.focus();
            return;
        }
        
        // –ï—Å–ª–∏ –∫–æ–¥ –µ—â–µ –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω
        if (codeSection.style.display === 'none') {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            emailLoginBtn.disabled = true;
            emailLoginBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –Ω–∞ email
            const result = await sendEmailLoginCode(email);
            
            if (result.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
                codeSection.style.display = 'block';
                if (codeInput) codeInput.focus();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                startLoginCodeTimer();
                
                emailLoginBtn.textContent = '‚úÖ –í–æ–π—Ç–∏';
                emailLoginBtn.disabled = false;
                
                if (result.testCode) {
                    // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥
                    codeInput.value = result.testCode;
                }
            } else {
                emailLoginBtn.textContent = 'üìß –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥';
                emailLoginBtn.disabled = false;
                errorMsg.textContent = result.error;
            }
        } else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
            if (!code || code.length !== 6) {
                errorMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥';
                codeInput.focus();
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            emailLoginBtn.disabled = true;
            emailLoginBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
            const result = await verifyEmailLoginCode(code);
            
            if (result.success) {
                emailLoginBtn.textContent = '‚úì –£—Å–ø–µ—à–Ω–æ!';
                emailLoginBtn.style.background = 'linear-gradient(90deg, #00cc66, #00ff88)';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    document.getElementById('auth-modal').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('auth-modal').style.display = 'none';
                        updateHeaderForLoggedInUser(result.userData.nickname);
                        showWelcomeNotification(result.userData.nickname, false);
                    }, 300);
                }, 1000);
            } else {
                emailLoginBtn.textContent = '‚úÖ –í–æ–π—Ç–∏';
                emailLoginBtn.disabled = false;
                errorMsg.textContent = result.error;
                emailLoginBtn.style.background = 'linear-gradient(90deg, #6200ff, #ff00ff)';
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ñ–æ—Ä–º–µ email
    emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') emailLoginBtn.click();
    });
    
    if (codeInput) {
        codeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') emailLoginBtn.click();
        });
    }
}

// –¢–∞–π–º–µ—Ä –¥–ª—è –∫–æ–¥–∞ –≤—Ö–æ–¥–∞
function startLoginCodeTimer() {
    const timerElement = document.getElementById('login-code-timer');
    const codeInput = document.getElementById('login-code');
    const loginBtn = document.getElementById('login-email-btn');
    
    if (!timerElement) return;
    
    let seconds = 300; // 5 –º–∏–Ω—É—Ç
    
    const timer = setInterval(() => {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        timerElement.textContent = `‚è≥ –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: ${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        timerElement.style.color = seconds < 60 ? '#ff4444' : '#ff9800';
        
        if (seconds <= 0) {
            clearInterval(timer);
            timerElement.textContent = '‚ùå –ö–æ–¥ –∏—Å—Ç–µ–∫';
            timerElement.style.color = '#ff4444';
            if (codeInput) codeInput.disabled = true;
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = '‚ùå –ö–æ–¥ –∏—Å—Ç–µ–∫';
            }
        }
        
        seconds--;
    }, 1000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
function setupRegisterHandler() {
    const registerBtn = document.getElementById('register-btn');
    const nicknameInput = document.getElementById('reg-nickname');
    const passwordInput = document.getElementById('reg-password');
    const confirmInput = document.getElementById('reg-confirm-password');
    
    registerBtn.addEventListener('click', async function() {
        const nickname = nicknameInput.value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmInput.value;
        const errorMsg = document.getElementById('reg-error');
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (!isValidNickname(nickname)) {
            errorMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–∏–∫–∞';
            return;
        }
        
        if (!isValidPassword(password)) {
            errorMsg.textContent = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π';
            return;
        }
        
        if (password !== confirmPassword) {
            errorMsg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        registerBtn.disabled = true;
        registerBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
        
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
        const result = await registerUser(nickname, password);
        
        if (result.success) {
            registerBtn.textContent = '‚úì –£—Å–ø–µ—à–Ω–æ!';
            registerBtn.style.background = 'linear-gradient(90deg, #00cc66, #00ff88)';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                document.getElementById('auth-modal').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-modal').style.display = 'none';
                    updateHeaderForLoggedInUser(nickname);
                }, 300);
            }, 1000);
        } else {
            registerBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            registerBtn.disabled = false;
            errorMsg.textContent = result.error;
            registerBtn.style.background = 'linear-gradient(90deg, #6200ff, #ff00ff)';
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–µ–¥–µ—Ä–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function updateHeaderForLoggedInUser(nickname) {
    const profileLink = document.getElementById('profile-link');
    const logoutBtn = document.getElementById('logout-btn-header');
    
    if (profileLink) {
        profileLink.style.display = 'flex';
    }
    
    if (logoutBtn) {
        logoutBtn.style.display = 'flex';
        logoutBtn.addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                localStorage.removeItem('jojoland_nickname');
                localStorage.removeItem('jojoland_userId');
                localStorage.removeItem('jojoland_loggedIn');
                localStorage.removeItem('pending_email_login');
                localStorage.removeItem('pending_user_id');
                window.location.reload();
            }
        });
    }
}

// –ü–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showWelcomeNotification(nickname, isNew = false) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(90deg, ${isNew ? '#00cc66' : '#6200ff'}, ${isNew ? '#00ff88' : '#ff00ff'});
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        z-index: 1000;
        animation: slideInRight 0.5s ease;
        box-shadow: 0 5px 20px rgba(98, 0, 255, 0.5);
        max-width: 300px;
        font-family: 'Orbitron', sans-serif;
    `;
    
    let message = isNew ? `üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!` : `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!`;
    let details = isNew ? `–ê–∫–∫–∞—É–Ω—Ç ${nickname} —Å–æ–∑–¥–∞–Ω!` : `–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞, ${nickname}!`;
    
    notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">
            ${message}
        </div>
        <div style="font-size: 12px; opacity: 0.9;">
            ${details}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
function checkAuth() {
    const isLoggedIn = localStorage.getItem('jojoland_loggedIn') === 'true';
    const nickname = localStorage.getItem('jojoland_nickname');
    
    if (isLoggedIn && nickname) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        updateHeaderForLoggedInUser(nickname);
        return false; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    }
    
    return true; // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ====================

window.onload = async function() {
    createParticles();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById("loader").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("content").style.opacity = "1";
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–æ—Ä–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (checkAuth()) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            document.getElementById('auth-modal').style.display = 'flex';
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—Å—ë
            setupAuthTabs();
            setupPasswordToggles();
            setupLoginTypeSwitchers();
            setupLoginHandler();
            setupEmailLoginHandler();
            setupRegisterHandler();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            const regNicknameInput = document.getElementById('reg-nickname');
            const regPasswordInput = document.getElementById('reg-password');
            const regConfirmInput = document.getElementById('reg-confirm-password');
            
            regNicknameInput.addEventListener('input', () => {
                updateCharCount();
                validateRegistrationForm();
            });
            
            regPasswordInput.addEventListener('input', validateRegistrationForm);
            regConfirmInput.addEventListener('input', validateRegistrationForm);
            
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∏–∫–∞ –≤ —Ñ–æ—Ä–º–µ –≤—Ö–æ–¥–∞
            setTimeout(() => {
                document.getElementById('login-nickname').focus();
            }, 300);
        }
    }, 400);
};

// –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(style);
</script>

</body>
</html>
