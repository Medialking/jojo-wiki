<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ | JojoLand</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body style="margin: 0; padding: 0; background: linear-gradient(135deg, #0a0a2a, #1a1a3a); color: white; font-family: 'Orbitron', sans-serif; min-height: 100vh;">

<div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
    <h1 style="text-align: center; color: #ffcc00; margin-bottom: 10px;">
        üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤
    </h1>
    <p style="text-align: center; color: #aaaaff; margin-bottom: 40px;">
        –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ –¥—Ä–æ–±–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤
    </p>
    
    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 2px solid rgba(255, 204, 0, 0.3);">
        <h2 style="color: #ffcc00; margin-top: 0;">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">
            <button id="quick-check" style="padding: 20px; background: linear-gradient(90deg, #0088ff, #00ccff); border: none; border-radius: 12px; color: white; font-family: 'Orbitron', sans-serif; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                üîç –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            </button>
            
            <button id="quick-fix" style="padding: 20px; background: linear-gradient(90deg, #00cc66, #00ff88); border: none; border-radius: 12px; color: white; font-family: 'Orbitron', sans-serif; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                ‚ö° –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </button>
        </div>
        
        <div id="quick-results" style="display: none; background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px; margin-top: 20px;">
            <div id="quick-results-content"></div>
        </div>
    </div>
    
    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 2px solid rgba(255, 0, 255, 0.3);">
        <h2 style="color: #ff00ff; margin-top: 0;">üéØ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç?</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="background: rgba(255, 68, 68, 0.1); border-radius: 12px; padding: 20px;">
                <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                <h3 style="color: #ff4444; margin: 0 0 10px;">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã</h3>
                <p style="color: #ff9999; font-size: 14px; margin: 0;">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç 50 –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤</p>
            </div>
            
            <div style="background: rgba(255, 153, 0, 0.1); border-radius: 12px; padding: 20px;">
                <div style="font-size: 24px; margin-bottom: 10px;">üìä</div>
                <h3 style="color: #ff9900; margin: 0 0 10px;">–î—Ä–æ–±–Ω—ã–µ —á–∏—Å–ª–∞</h3>
                <p style="color: #ffcc99; font-size: 14px; margin: 0;">–û–∫—Ä—É–≥–ª—è–µ—Ç –¥–æ —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª</p>
            </div>
            
            <div style="background: rgba(0, 204, 102, 0.1); border-radius: 12px; padding: 20px;">
                <div style="font-size: 24px; margin-bottom: 10px;">‚úÖ</div>
                <h3 style="color: #00cc66; margin: 0 0 10px;">–ë–µ–∑–æ–ø–∞—Å–Ω–æ</h3>
                <p style="color: #99ffcc; font-size: 14px; margin: 0;">–ù–µ —Ç—Ä–æ–≥–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã</p>
            </div>
        </div>
    </div>
    
    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 30px; border: 2px solid rgba(0, 255, 255, 0.3);">
        <h2 style="color: #00ffff; margin-top: 0;">üìã –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
        
        <div style="margin-top: 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="background: rgba(255, 68, 68, 0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">
                    ‚ùå
                </div>
                <div>
                    <strong style="color: #ff4444;">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</strong>
                    <div style="color: #aaaaff; font-size: 14px;">-10, -5, -100 ‚Üí 50 –æ—á–∫–æ–≤</div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="background: rgba(255, 153, 0, 0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">
                    üìä
                </div>
                <div>
                    <strong style="color: #ff9900;">–î—Ä–æ–±–Ω—ã–π –±–∞–ª–∞–Ω—Å</strong>
                    <div style="color: #aaaaff; font-size: 14px;">64.55, 128.33 ‚Üí 65, 128 –æ—á–∫–æ–≤</div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center;">
                <div style="background: rgba(0, 204, 102, 0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">
                    ‚úÖ
                </div>
                <div>
                    <strong style="color: #00cc66;">–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å</strong>
                    <div style="color: #aaaaff; font-size: 14px;">100, 250, 500 ‚Üí –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è</div>
                </div>
            </div>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 40px;">
        <button id="manual-run" style="padding: 15px 40px; background: linear-gradient(90deg, #6200ff, #ff00ff); border: none; border-radius: 10px; color: white; font-family: 'Orbitron', sans-serif; font-size: 16px; cursor: pointer; transition: all 0.3s;">
            üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        </button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script src="fix_points.js"></script>

<script>
document.getElementById('quick-check').addEventListener('click', async function() {
    const btn = this;
    const resultsDiv = document.getElementById('quick-results');
    const contentDiv = document.getElementById('quick-results-content');
    
    btn.disabled = true;
    btn.innerHTML = 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    resultsDiv.style.display = 'block';
    
    contentDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaaaff;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å—ã...</div>';
    
    try {
        const snapshot = await database.ref('holiday_points').once('value');
        
        if (!snapshot.exists()) {
            contentDiv.innerHTML = '<div style="text-align: center; color: #ff4444;">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–∞—Ö</div>';
            return;
        }
        
        const allPointsData = snapshot.val();
        let negativeCount = 0;
        let decimalCount = 0;
        
        for (const userId in allPointsData) {
            const userData = allPointsData[userId];
            
            if (userData.total_points !== undefined) {
                const points = userData.total_points;
                
                if (points < 0) {
                    negativeCount++;
                }
                else if (!Number.isInteger(points)) {
                    decimalCount++;
                }
            }
        }
        
        if (negativeCount === 0 && decimalCount === 0) {
            contentDiv.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 40px; color: #00ff00; margin: 10px 0;">‚úÖ</div>
                    <div style="color: #00ff00; font-size: 18px; margin-bottom: 10px;">–í—Å–µ –±–∞–ª–∞–Ω—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!</div>
                    <div style="color: #aaaaff; font-size: 14px;">–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤</div>
                </div>
            `;
        } else {
            contentDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="color: #ffcc00; font-size: 20px; margin-bottom: 15px;">‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã</div>
                    
                    ${negativeCount > 0 ? `
                        <div style="background: rgba(255, 68, 68, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="color: #ff4444; font-weight: bold; margin-bottom: 5px;">‚ùå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ: ${negativeCount}</div>
                            <div style="color: #ff9999; font-size: 14px;">–ü–æ–ª—É—á–∞—Ç 50 –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤</div>
                        </div>
                    ` : ''}
                    
                    ${decimalCount > 0 ? `
                        <div style="background: rgba(255, 153, 0, 0.1); border-radius: 8px; padding: 15px;">
                            <div style="color: #ff9900; font-weight: bold; margin-bottom: 5px;">üìä –î—Ä–æ–±–Ω—ã–µ: ${decimalCount}</div>
                            <div style="color: #ffcc99; font-size: 14px;">–ë—É–¥—É—Ç –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª</div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); color: #aaaaff;">
                        –í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤: <strong style="color: #ffcc00;">${negativeCount + decimalCount}</strong>
                    </div>
                </div>
            `;
        }
        
    } catch (error) {
        contentDiv.innerHTML = `
            <div style="text-align: center; color: #ff4444;">
                <div style="font-size: 40px; margin: 10px 0;">‚ùå</div>
                <div>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                <div style="font-size: 12px; margin-top: 10px; color: #ff9999;">${error.message}</div>
            </div>
        `;
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîç –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞';
    }
});

document.getElementById('quick-fix').addEventListener('click', async function() {
    const btn = this;
    const resultsDiv = document.getElementById('quick-results');
    const contentDiv = document.getElementById('quick-results-content');
    
    btn.disabled = true;
    btn.innerHTML = '‚ö° –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';
    resultsDiv.style.display = 'block';
    
    contentDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaaaff;">–ù–∞—á–∏–Ω–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</div>';
    
    try {
        await fixAllPointsBalancesUI();
    } finally {
        btn.disabled = false;
        btn.innerHTML = '‚ö° –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ';
    }
});

document.getElementById('manual-run').addEventListener('click', async function() {
    const btn = this;
    
    if (!confirm('‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –±–∞–ª–∞–Ω—Å–æ–≤?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = 'üöÄ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';
    
    try {
        await fixAllPointsBalances();
        alert('‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ';
    }
});

async function fixAllPointsBalancesUI() {
    const contentDiv = document.getElementById('quick-results-content');
    
    try {
        const snapshot = await database.ref('holiday_points').once('value');
        
        if (!snapshot.exists()) {
            contentDiv.innerHTML = '<div style="text-align: center; color: #ff4444;">‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        
        const allPointsData = snapshot.val();
        let fixedCount = 0;
        let negativeFixedCount = 0;
        let decimalFixedCount = 0;
        
        contentDiv.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 24px; color: #ffcc00; margin-bottom: 10px;">‚ö° –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</div>
                <div style="color: #aaaaff; font-size: 14px;">–ò–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                <div id="progress" style="margin-top: 10px; color: #00ff00; font-size: 12px;">0/${Object.keys(allPointsData).length}</div>
            </div>
            <div id="progress-details" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px;"></div>
        `;
        
        const progressDiv = document.getElementById('progress');
        const detailsDiv = document.getElementById('progress-details');
        const totalUsers = Object.keys(allPointsData).length;
        let processed = 0;
        
        for (const userId in allPointsData) {
            const userData = allPointsData[userId];
            const updates = {};
            let userNeedsFix = false;
            
            if (userData.total_points !== undefined) {
                const currentPoints = userData.total_points;
                let newPoints = Math.round(currentPoints);
                
                if (currentPoints < 0) {
                    newPoints = 50;
                    negativeFixedCount++;
                    userNeedsFix = true;
                }
                else if (!Number.isInteger(currentPoints)) {
                    decimalFixedCount++;
                    userNeedsFix = true;
                }
                
                if (userNeedsFix && newPoints !== currentPoints) {
                    updates.total_points = newPoints;
                }
            }
            
            if (Object.keys(updates).length > 0) {
                await database.ref('holiday_points/' + userId).update(updates);
                fixedCount++;
                
                const userKey = userId.substring(0, 8) + '...';
                detailsDiv.innerHTML += `<div style="font-size: 11px; color: #88ff88; margin-bottom: 3px; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    ‚úÖ ${userKey}: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
                </div>`;
                detailsDiv.scrollTop = detailsDiv.scrollHeight;
            }
            
            processed++;
            progressDiv.innerHTML = `${processed}/${totalUsers}`;
            
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        contentDiv.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 40px; color: #00ff00; margin: 10px 0;">üéâ</div>
                <div style="color: #00ff00; font-size: 24px; margin-bottom: 15px;">–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                    <div style="background: rgba(0, 204, 102, 0.1); border-radius: 10px; padding: 15px;">
                        <div style="color: #00ff00; font-size: 28px; font-weight: bold;">${fixedCount}</div>
                        <div style="color: #99ffcc; font-size: 12px;">–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤</div>
                    </div>
                    
                    <div style="background: rgba(255, 68, 68, 0.1); border-radius: 10px; padding: 15px;">
                        <div style="color: #ff4444; font-size: 28px; font-weight: bold;">${negativeFixedCount}</div>
                        <div style="color: #ff9999; font-size: 12px;">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö ‚Üí 50</div>
                    </div>
                    
                    <div style="background: rgba(255, 153, 0, 0.1); border-radius: 10px; padding: 15px;">
                        <div style="color: #ff9900; font-size: 28px; font-weight: bold;">${decimalFixedCount}</div>
                        <div style="color: #ffcc99; font-size: 12px;">–î—Ä–æ–±–Ω—ã—Ö ‚Üí —Ü–µ–ª—ã–µ</div>
                    </div>
                </div>
                
                <div style="color: #aaaaff; font-size: 14px; margin-top: 15px;">
                    –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                </div>
            </div>
        `;
        
    } catch (error) {
        contentDiv.innerHTML = `
            <div style="text-align: center; color: #ff4444;">
                <div style="font-size: 40px; margin: 10px 0;">‚ùå</div>
                <div>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏</div>
                <div style="font-size: 12px; margin-top: 10px; color: #ff9999;">${error.message}</div>
            </div>
        `;
    }
}
</script>

</body>
</html>
