<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–∑–∏–Ω–æ | JojoLand</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="casino.css">
    
    <!-- –ò–≥—Ä–æ–≤–æ–π —à—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- –ê–ù–ò–ú–ê–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<!-- –§–û–ù–û–í–´–ï –≠–§–§–ï–ö–¢–´ -->
<div class="background-effects" id="particles"></div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
<div id="content">
    <header>
        <div class="header-top">
            <a href="index.html" class="profile-btn">
                <span class="profile-icon">üè†</span>
                <span class="profile-text">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </a>
            <a href="points.html" class="profile-btn">
                <span class="profile-icon">üéÅ</span>
                <span class="profile-text">–ú–æ–∏ –æ—á–∫–∏</span>
            </a>
            <img src="images/logo.png" class="logo" alt="JojoLand Logo">
        </div>
        
        <h1>üé∞ –ö–∞–∑–∏–Ω–æ</h1>
        <p class="subtitle">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É –∏ –≤—ã–∏–≥—Ä–∞–π –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏!</p>
    </header>

    <div class="casino-container">
        <!-- –ë–ê–õ–ê–ù–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø -->
        <div class="balance-section">
            <div class="balance-card">
                <div class="balance-icon">üí∞</div>
                <div class="balance-info">
                    <h3>–í–∞—à –±–∞–ª–∞–Ω—Å</h3>
                    <div class="balance-amount" id="user-balance">0</div>
                    <p class="balance-label">–Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤</p>
                </div>
            </div>
            <div class="balance-actions">
                <button class="action-btn" id="refresh-balance">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="action-btn" id="withdraw-btn">üí∏ –í—ã–≤–µ—Å—Ç–∏</button>
            </div>
        </div>

        <!-- –ò–ì–†–´ -->
        <div class="games-section">
            <h2 class="section-title">üé≤ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä—ã</h2>
            <p class="section-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –∏ –∏—Å–ø—ã—Ç–∞–π—Ç–µ —É–¥–∞—á—É!</p>
            
            <div class="games-grid">
                <!-- –ò–ì–†–ê 1: –ö–†–ê–°–ù–û–ï –ò–õ–ò –ß–ï–†–ù–û–ï -->
                <div class="game-card" data-game="red-black">
                    <div class="game-icon">üéØ</div>
                    <div class="game-info">
                        <h3>–ö—Ä–∞—Å–Ω–æ–µ –∏–ª–∏ –ß–µ—Ä–Ω–æ–µ</h3>
                        <p>–£–≥–∞–¥–∞–π —Ü–≤–µ—Ç –∏ –≤—ã–∏–≥—Ä–∞–π —Ö2</p>
                    </div>
                    <div class="game-stats">
                        <div class="stat">
                            <span class="stat-label">–®–∞–Ω—Å:</span>
                            <span class="stat-value">50%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">–ö–æ—ç—Ñ:</span>
                            <span class="stat-value">x2</span>
                        </div>
                    </div>
                    <button class="play-btn" onclick="window.location.href='red-black.html'">–ò–≥—Ä–∞—Ç—å</button>
                </div>
                
                <!-- –ò–ì–†–ê 2: –î–£–≠–õ–¨ -->
                <div class="game-card" data-game="duel">
                    <div class="game-icon">‚öîÔ∏è</div>
                    <div class="game-info">
                        <h3>–î—É—ç–ª—å</h3>
                        <p>–°—Ä–∞–∑–∏—Ç–µ—Å—å —Å –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–æ–º 1 –Ω–∞ 1</p>
                    </div>
                    <div class="game-stats">
                        <div class="stat">
                            <span class="stat-label">–ò–≥—Ä–æ–∫–æ–≤:</span>
                            <span class="stat-value">2</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:</span>
                            <span class="stat-value">50%</span>
                        </div>
                    </div>
                    <button class="play-btn" onclick="window.location.href='duel.html'">–ò–≥—Ä–∞—Ç—å</button>
                </div>
                
                <!-- –ò–ì–†–ê 3: –ß–ò–°–õ–û -->
                <div class="game-card" data-game="number">
                    <div class="game-icon">üéØ</div>
                    <div class="game-info">
                        <h3>–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</h3>
                        <p>–£–≥–∞–¥–∞–π—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100</p>
                    </div>
                    <div class="game-stats">
                        <div class="stat">
                            <span class="stat-label">–®–∞–Ω—Å:</span>
                            <span class="stat-value">1%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">–ö–æ—ç—Ñ:</span>
                            <span class="stat-value">x5</span>
                        </div>
                    </div>
                    <button class="play-btn" onclick="window.location.href='number.html'">–ò–≥—Ä–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ê–ö–¢–ò–í–ù–´–ï –ò–ì–†–´ -->
        <div class="active-games-section">
            <h2 class="section-title">‚ö° –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã</h2>
            <p class="section-subtitle">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∏–≥—Ä–∞–º –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤</p>
            
            <div class="active-games-container">
                <div class="loading" id="games-loading">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä...</p>
                </div>
                <div class="active-games-list" id="active-games-list">
                    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
            
            <div class="refresh-btn-container">
                <button class="refresh-btn" id="refresh-games">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
        </div>

        <!-- –ò–°–¢–û–†–ò–Ø –ò–ì–† -->
        <div class="history-section">
            <h2 class="section-title">üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h2>
            
            <div class="history-tabs">
                <button class="history-tab active" data-type="all">–í—Å–µ –∏–≥—Ä—ã</button>
                <button class="history-tab" data-type="won">–í—ã–∏–≥—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="history-tab" data-type="lost">–ü—Ä–æ–∏–≥—Ä–∞–Ω–Ω—ã–µ</button>
                <button class="history-tab" data-type="duel">–î—É—ç–ª–∏</button>
            </div>
            
            <div class="history-list" id="history-list">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
                <div class="empty-history">
                    <div class="empty-icon">üì≠</div>
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä</p>
                    <small>–°—ã–≥—Ä–∞–π—Ç–µ –≤ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É!</small>
                </div>
            </div>
        </div>

        <!-- –ü–†–ê–í–ò–õ–ê –ö–ê–ó–ò–ù–û -->
        <div class="rules-section">
            <h2 class="section-title">üìã –ü—Ä–∞–≤–∏–ª–∞ –∫–∞–∑–∏–Ω–æ</h2>
            
            <div class="rules-grid">
                <div class="rule-card">
                    <div class="rule-icon">üí∞</div>
                    <h3>–°—Ç–∞–≤–∫–∏</h3>
                    <p>–°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç <strong>10 –¥–æ 1000</strong> –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤</p>
                </div>
                
                <div class="rule-card">
                    <div class="rule-icon">‚è∞</div>
                    <h3>–í—Ä–µ–º—è –∏–≥—Ä—ã</h3>
                    <p>–ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–∞–±–∏—Ä–∞–µ—Ç—Å—è –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤</p>
                </div>
                
                <div class="rule-card">
                    <div class="rule-icon">üë•</div>
                    <h3>–î—É—ç–ª–∏</h3>
                    <p>–í –¥—É—ç–ª—è—Ö –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –∑–∞–±–∏—Ä–∞–µ—Ç –≤—Å—é —Å—Ç–∞–≤–∫—É –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–≥–æ</p>
                </div>
                
                <div class="rule-card">
                    <div class="rule-icon">‚ö†Ô∏è</div>
                    <h3>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</h3>
                    <p>–ê–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å. –ò–≥—Ä–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ!</p>
                </div>
            </div>
        </div>

        <!-- –ö–ù–û–ü–ö–ò –ù–ê–í–ò–ì–ê–¶–ò–ò -->
        <div class="navigation-buttons">
            <a href="index.html" class="nav-btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="profile.html" class="nav-btn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="points.html" class="nav-btn">üéÅ –ú–æ–∏ –æ—á–∫–∏</a>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const database = firebase.database();

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let userId = null;
let userNickname = null;
let userBalance = 0;

// –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´
window.onload = async function() {
    createParticles();
    
    document.getElementById("loader").style.opacity = "0";
    setTimeout(async () => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("content").style.opacity = "1";
        
        if (await checkAuth()) {
            await loadUserBalance();
            await loadActiveGames();
            await loadGameHistory();
            setupEventListeners();
            setupRealtimeUpdates();
        }
    }, 400);
};

// –°–û–ó–î–ê–ù–ò–ï –§–û–ù–û–í–´–• –ß–ê–°–¢–ò–¶
function createParticles() {
    const particlesContainer = document.getElementById('particles');
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        
        const size = Math.random() * 2 + 1;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        particle.style.opacity = Math.random() * 0.5 + 0.2;
        
        const duration = Math.random() * 20 + 15;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${Math.random() * 10}s`;
        
        particlesContainer.appendChild(particle);
    }
}

// –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
async function checkAuth() {
    userId = localStorage.getItem('jojoland_userId');
    userNickname = localStorage.getItem('jojoland_nickname');
    
    if (!userId || !userNickname) {
        showError('–î–ª—è –∏–≥—Ä—ã –≤ –∫–∞–∑–∏–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç');
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 3000);
        return false;
    }
    
    return true;
}

// –ó–ê–ì–†–£–ó–ö–ê –ë–ê–õ–ê–ù–°–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
async function loadUserBalance() {
    try {
        const snapshot = await database.ref('holiday_points/' + userId).once('value');
        
        if (snapshot.exists()) {
            const pointsData = snapshot.val();
            userBalance = pointsData.available_points || 0;
            document.getElementById('user-balance').textContent = userBalance;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞');
    }
}

// –ó–ê–ì–†–£–ó–ö–ê –ê–ö–¢–ò–í–ù–´–• –ò–ì–†
async function loadActiveGames() {
    try {
        const loadingElement = document.getElementById('games-loading');
        const gamesList = document.getElementById('active-games-list');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadingElement.style.display = 'flex';
        gamesList.innerHTML = '';
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã
        const snapshot = await database.ref('casino_games').once('value');
        
        if (!snapshot.exists()) {
            gamesList.innerHTML = `
                <div class="empty-games">
                    <div class="empty-icon">üé≤</div>
                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä</p>
                    <small>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É!</small>
                </div>
            `;
            loadingElement.style.display = 'none';
            return;
        }
        
        const gamesData = snapshot.val();
        const activeGames = [];
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã
        for (const gameId in gamesData) {
            const game = gamesData[gameId];
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
            if (game.status === 'finished' || game.status === 'cancelled') {
                continue;
            }
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (game.created_by === userId) {
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const players = game.players || {};
            if (players[userId]) {
                continue;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫–Ω–µ–π–º —Å–æ–∑–¥–∞—Ç–µ–ª—è
            const creatorSnapshot = await database.ref('users/' + game.created_by).once('value');
            let creatorNickname = '–ò–≥—Ä–æ–∫';
            
            if (creatorSnapshot.exists()) {
                const creatorData = creatorSnapshot.val();
                creatorNickname = creatorData.nickname || '–ò–≥—Ä–æ–∫';
            }
            
            activeGames.push({
                id: gameId,
                gameType: game.game_type,
                bet: game.bet,
                creator: creatorNickname,
                creatorId: game.created_by,
                playersCount: Object.keys(players || {}).length,
                maxPlayers: game.max_players || 2,
                createdTime: game.created_at
            });
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
        activeGames.sort((a, b) => new Date(b.createdTime) - new Date(a.createdTime));
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–≥—Ä—ã
        if (activeGames.length === 0) {
            gamesList.innerHTML = `
                <div class="empty-games">
                    <div class="empty-icon">üé≤</div>
                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä</p>
                    <small>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É!</small>
                </div>
            `;
        } else {
            gamesList.innerHTML = activeGames.map(game => {
                let gameTypeText = '';
                let gameIcon = 'üé≤';
                
                if (game.gameType === 'red_black') {
                    gameTypeText = '–ö—Ä–∞—Å–Ω–æ–µ/–ß–µ—Ä–Ω–æ–µ';
                    gameIcon = 'üéØ';
                } else if (game.gameType === 'duel') {
                    gameTypeText = '–î—É—ç–ª—å';
                    gameIcon = '‚öîÔ∏è';
                } else if (game.gameType === 'number') {
                    gameTypeText = '–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ';
                    gameIcon = 'üéØ';
                }
                
                const timeAgo = getTimeAgo(new Date(game.createdTime));
                
                return `
                    <div class="active-game-card" data-game-id="${game.id}">
                        <div class="game-header">
                            <div class="game-type">
                                <span class="game-icon">${gameIcon}</span>
                                <span class="game-name">${gameTypeText}</span>
                            </div>
                            <div class="game-time">${timeAgo}</div>
                        </div>
                        <div class="game-info">
                            <div class="game-creator">
                                <span class="info-label">–°–æ–∑–¥–∞—Ç–µ–ª—å:</span>
                                <span class="info-value">${game.creator}</span>
                            </div>
                            <div class="game-bet">
                                <span class="info-label">–°—Ç–∞–≤–∫–∞:</span>
                                <span class="info-value">${game.bet} –æ—á–∫–æ–≤</span>
                            </div>
                            <div class="game-players">
                                <span class="info-label">–ò–≥—Ä–æ–∫–æ–≤:</span>
                                <span class="info-value">${game.playersCount}/${game.maxPlayers}</span>
                            </div>
                        </div>
                        <button class="join-btn" onclick="joinGame('${game.id}')">
                            –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        loadingElement.style.display = 'none';
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä:', error);
        document.getElementById('games-loading').innerHTML = `
            <div style="color: #ff4444; text-align: center;">
                <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä</p>
            </div>
        `;
    }
}

// –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–Ø –ö –ò–ì–†–ï
async function joinGame(gameId) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
        if (userBalance <= 0) {
            showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤ –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–≥—Ä–µ
        const gameSnapshot = await database.ref('casino_games/' + gameId).once('value');
        
        if (!gameSnapshot.exists()) {
            showError('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        const game = gameSnapshot.val();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
        if (game.status !== 'waiting') {
            showError('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
        const players = game.players || {};
        if (Object.keys(players).length >= game.max_players) {
            showError('–ò–≥—Ä–∞ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if (players[userId]) {
            showError('–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–π –∏–≥—Ä–µ');
            return;
        }
        
        // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
        const bet = game.bet;
        if (userBalance < bet) {
            showError(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤. –ù—É–∂–Ω–æ: ${bet}, —É –≤–∞—Å: ${userBalance}`);
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
        const pointsSnapshot = await database.ref('holiday_points/' + userId).once('value');
        if (pointsSnapshot.exists()) {
            const pointsData = pointsSnapshot.val();
            const newBalance = (pointsData.available_points || 0) - bet;
            
            await database.ref('holiday_points/' + userId).update({
                available_points: newBalance
            });
            
            userBalance = newBalance;
            document.getElementById('user-balance').textContent = userBalance;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –∏–≥—Ä—É
        players[userId] = {
            nickname: userNickname,
            joined_at: new Date().toISOString(),
            choice: null,
            result: null
        };
        
        await database.ref('casino_games/' + gameId).update({
            players: players
        });
        
        // –ï—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–µ
        if (Object.keys(players).length >= game.max_players) {
            await startGame(gameId, game.game_type);
        }
        
        showNotification(`–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ! –°—Ç–∞–≤–∫–∞: ${bet} –æ—á–∫–æ–≤`, 'success');
        
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä—ã
        if (game.game_type === 'red_black') {
            window.location.href = `red-black.html?game=${gameId}`;
        } else if (game.game_type === 'duel') {
            window.location.href = `duel.html?game=${gameId}`;
        } else if (game.game_type === 'number') {
            window.location.href = `number.html?game=${gameId}`;
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ');
    }
}

// –ó–ê–ü–£–°–ö –ò–ì–†–´
async function startGame(gameId, gameType) {
    try {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
        await database.ref('casino_games/' + gameId).update({
            status: 'in_progress',
            started_at: new Date().toISOString()
        });
        
        // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∏–≥—Ä—ã –∑–∞–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏–∫—É
        if (gameType === 'red_black') {
            await startRedBlackGame(gameId);
        } else if (gameType === 'duel') {
            await startDuelGame(gameId);
        } else if (gameType === 'number') {
            await startNumberGame(gameId);
        }
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã:', error);
    }
}

// –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò –ò–ì–†
async function loadGameHistory() {
    try {
        const historyList = document.getElementById('history-list');
        
        // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–≥—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const snapshot = await database.ref('casino_history/' + userId).once('value');
        
        if (!snapshot.exists()) {
            historyList.innerHTML = `
                <div class="empty-history">
                    <div class="empty-icon">üì≠</div>
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä</p>
                    <small>–°—ã–≥—Ä–∞–π—Ç–µ –≤ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É!</small>
                </div>
            `;
            return;
        }
        
        const historyData = snapshot.val();
        const historyItems = [];
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤
        for (const gameId in historyData) {
            historyItems.push({
                id: gameId,
                ...historyData[gameId]
            });
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
        historyItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        displayHistory(historyItems, 'all');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä');
    }
}

// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–°–¢–û–†–ò–ò
function displayHistory(historyItems, filterType) {
    const historyList = document.getElementById('history-list');
    
    if (historyItems.length === 0) {
        historyList.innerHTML = `
            <div class="empty-history">
                <div class="empty-icon">üì≠</div>
                <p>–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä</p>
                <small>–°—ã–≥—Ä–∞–π—Ç–µ –≤ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É!</small>
            </div>
        `;
        return;
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–∏–ø—É
    let filteredItems = historyItems;
    
    if (filterType === 'won') {
        filteredItems = historyItems.filter(item => item.result === 'win');
    } else if (filterType === 'lost') {
        filteredItems = historyItems.filter(item => item.result === 'lose');
    } else if (filterType === 'duel') {
        filteredItems = historyItems.filter(item => item.game_type === 'duel');
    }
    
    if (filteredItems.length === 0) {
        historyList.innerHTML = `
            <div class="empty-history">
                <div class="empty-icon">üîç</div>
                <p>–ù–µ—Ç –∏–≥—Ä –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É</p>
            </div>
        `;
        return;
    }
    
    historyList.innerHTML = filteredItems.slice(0, 10).map(item => {
        let gameTypeText = '';
        let gameIcon = 'üé≤';
        let resultClass = '';
        let resultText = '';
        let resultIcon = '';
        
        if (item.game_type === 'red_black') {
            gameTypeText = '–ö—Ä–∞—Å–Ω–æ–µ/–ß–µ—Ä–Ω–æ–µ';
            gameIcon = 'üéØ';
        } else if (item.game_type === 'duel') {
            gameTypeText = '–î—É—ç–ª—å';
            gameIcon = '‚öîÔ∏è';
        } else if (item.game_type === 'number') {
            gameTypeText = '–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ';
            gameIcon = 'üéØ';
        }
        
        if (item.result === 'win') {
            resultClass = 'win';
            resultText = '–í—ã–∏–≥—Ä—ã—à';
            resultIcon = 'üí∞';
        } else if (item.result === 'lose') {
            resultClass = 'lose';
            resultText = '–ü—Ä–æ–∏–≥—Ä—ã—à';
            resultIcon = 'üí∏';
        } else {
            resultClass = 'draw';
            resultText = '–ù–∏—á—å—è';
            resultIcon = 'ü§ù';
        }
        
        const date = new Date(item.timestamp);
        const formattedDate = date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        return `
            <div class="history-item ${resultClass}">
                <div class="history-game">
                    <div class="game-type-icon">${gameIcon}</div>
                    <div class="game-info">
                        <div class="game-name">${gameTypeText}</div>
                        <div class="game-time">${formattedDate}</div>
                    </div>
                </div>
                <div class="history-details">
                    <div class="history-bet">–°—Ç–∞–≤–∫–∞: <strong>${item.bet}</strong> –æ—á–∫–æ–≤</div>
                    ${item.choice ? `<div class="history-choice">–í—ã–±–æ—Ä: ${item.choice}</div>` : ''}
                </div>
                <div class="history-result">
                    <div class="result-icon">${resultIcon}</div>
                    <div class="result-text">
                        <div class="result-title">${resultText}</div>
                        <div class="result-amount">
                            ${item.result === 'win' ? '+' : '-'}${item.bet} –æ—á–∫–æ–≤
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// –ü–û–î–ü–ò–°–ö–ê –ù–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò
function setupRealtimeUpdates() {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
    database.ref('holiday_points/' + userId).on('value', (snapshot) => {
        if (snapshot.exists()) {
            const pointsData = snapshot.val();
            userBalance = pointsData.available_points || 0;
            document.getElementById('user-balance').textContent = userBalance;
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä
    database.ref('casino_games').on('value', () => {
        loadActiveGames();
    });
}

// –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô
function setupEventListeners() {
    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    document.getElementById('refresh-balance').addEventListener('click', loadUserBalance);
    
    // –ö–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞ –æ—á–∫–æ–≤
    document.getElementById('withdraw-btn').addEventListener('click', async function() {
        if (userBalance <= 0) {
            showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞');
            return;
        }
        
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–≤–æ–¥–∞
        showNotification('–§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    });
    
    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–≥—Ä
    document.getElementById('refresh-games').addEventListener('click', loadActiveGames);
    
    // –í–∫–ª–∞–¥–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
    const historyTabs = document.querySelectorAll('.history-tab');
    historyTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            historyTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
            const filterType = this.getAttribute('data-type');
            loadGameHistory().then(() => {
                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å
                const historyItems = Array.from(document.querySelectorAll('.history-item'));
                displayHistory(
                    historyItems.map(item => ({
                        game_type: item.getAttribute('data-type'),
                        result: item.classList.contains('win') ? 'win' : 
                                item.classList.contains('lose') ? 'lose' : 'draw',
                        bet: parseInt(item.querySelector('.history-bet strong').textContent),
                        timestamp: item.querySelector('.game-time').textContent,
                        choice: item.querySelector('.history-choice')?.textContent.replace('–í—ã–±–æ—Ä: ', '')
                    })),
                    filterType
                );
            });
        });
    });
}

// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
function getTimeAgo(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000); // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    
    if (diff < 60) {
        return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    } else if (diff < 3600) {
        const minutes = Math.floor(diff / 60);
        return `${minutes} ${getNoun(minutes, ['–º–∏–Ω—É—Ç—É', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç'])} –Ω–∞–∑–∞–¥`;
    } else if (diff < 86400) {
        const hours = Math.floor(diff / 3600);
        return `${hours} ${getNoun(hours, ['—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤'])} –Ω–∞–∑–∞–¥`;
    } else {
        const days = Math.floor(diff / 86400);
        return `${days} ${getNoun(days, ['–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π'])} –Ω–∞–∑–∞–¥`;
    }
}

function getNoun(number, titles) {
    const cases = [2, 0, 1, 1, 1, 2];
    return titles[
        (number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]
    ];
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(0, 204, 102, 0.9)' : 
                    type === 'error' ? 'rgba(255, 68, 68, 0.9)' : 'rgba(98, 0, 255, 0.9)'};
        border: 1px solid ${type === 'success' ? '#00cc66' : 
                    type === 'error' ? '#ff4444' : '#6200ff'};
        border-radius: 10px;
        padding: 15px 25px;
        color: white;
        font-family: 'Orbitron', sans-serif;
        z-index: 1000;
        animation: slideInRight 0.5s ease;
        max-width: 300px;
        font-size: 14px;
    `;
    notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">
            ${type === 'success' ? '‚úÖ –£—Å–ø–µ—à–Ω–æ!' : type === 'error' ? '‚ö†Ô∏è –û—à–∏–±–∫–∞' : '‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}
        </div>
        <div>${message}</div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function showError(message) {
    showNotification(message, 'error');
}

// –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(notificationStyle);
</script>

</body>
</html>
