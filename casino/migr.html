<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–∏–≥—Ä–∞—Ü–∏—è –æ—á–∫–æ–≤ | JojoLand</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body style="background: #0a0a0a; color: white; font-family: Arial; padding: 20px;">
    <h1>üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ—á–∫–æ–≤</h1>
    <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–∏–≥—Ä–∏—Ä—É–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å–∏—Å—Ç–µ–º—ã available_points –Ω–∞ total_points.</p>
    
    <button onclick="migrateAllUsers()" style="padding: 15px 30px; background: #6200ff; color: white; border: none; border-radius: 10px; font-size: 18px; cursor: pointer;">
        –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
    </button>
    
    <div id="status" style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;"></div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
            authDomain: "jojoland-chat.firebasestorage.app",
            databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
            projectId: "jojoland-chat",
            storageBucket: "jojoland-chat.firebasestorage.app",
            messagingSenderId: "602788305122",
            appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        async function migrateAllUsers() {
            const status = document.getElementById('status');
            status.innerHTML = '<div style="color: #ffcc00;">üîÑ –ù–∞—á–∏–Ω–∞—é –º–∏–≥—Ä–∞—Ü–∏—é...</div>';
            
            try {
                console.log('üîÑ –ù–∞—á–∏–Ω–∞—é –º–∏–≥—Ä–∞—Ü–∏—é –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const snapshot = await database.ref('holiday_points').once('value');
                
                if (!snapshot.exists()) {
                    status.innerHTML = '<div style="color: #ff4444;">‚ùå –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏</div>';
                    return;
                }
                
                const usersData = snapshot.val();
                let migratedCount = 0;
                let errorsCount = 0;
                
                status.innerHTML += '<div>üìä –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + Object.keys(usersData).length + '</div>';
                
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                for (const userId in usersData) {
                    try {
                        const userData = usersData[userId];
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ available_points
                        if (userData.available_points !== undefined && userData.available_points !== null) {
                            const available = userData.available_points || 0;
                            const total = userData.total_points || 0;
                            
                            // –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            const newTotal = Math.max(available, total);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            await database.ref('holiday_points/' + userId).update({
                                total_points: newTotal,
                                available_points: null // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                            });
                            
                            migratedCount++;
                            status.innerHTML += `<div style="color: #00ff00; margin: 5px 0;">‚úÖ ${userId}: ${available} ‚Üí ${newTotal}</div>`;
                            
                            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                            status.scrollTop = status.scrollHeight;
                        }
                    } catch (error) {
                        errorsCount++;
                        status.innerHTML += `<div style="color: #ff4444; margin: 5px 0;">‚ùå ${userId}: ${error.message}</div>`;
                    }
                }
                
                status.innerHTML += `<div style="margin-top: 20px; padding: 15px; background: rgba(0,255,0,0.1); border-radius: 10px;">
                    <h3>üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
                    <div>‚úÖ –£—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${migratedCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div>‚ùå –û—à–∏–±–æ–∫: ${errorsCount}</div>
                </div>`;
                
                console.log(`üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${migratedCount}, –û—à–∏–±–æ–∫: ${errorsCount}`);
                
            } catch (error) {
                status.innerHTML = `<div style="color: #ff4444;">‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}</div>`;
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:', error);
            }
        }
    </script>
</body>
</html>
