<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–æ–∫–∏ | JojoLand</title>
    <link rel="stylesheet" href="style.css">

    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç–∏–ª–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–ª –¥–∏–∑–∞–π–Ω) */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray: #64748b;
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--light);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* –õ–û–ê–î–ï–† */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.4s ease;
        }
        .spinner { width: 60px; height: 60px; border: 4px solid var(--card-border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        #loader p { color: var(--gray); font-size: 16px; font-weight: 500; }

        .players-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; min-height: 100vh; }

        .page-header { text-align: center; margin-bottom: 50px; }
        .page-title { font-size: 42px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; letter-spacing: -0.5px; }
        .page-subtitle { font-size: 18px; color: var(--gray); font-weight: 400; max-width: 600px; margin: 0 auto; line-height: 1.6; }

        .search-filters-section { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--card-border); border-radius: 20px; padding: 30px; margin-bottom: 40px; }
        .search-box { position: relative; margin-bottom: 25px; }
        #search-input { width: 100%; padding: 16px 24px; background: rgba(255,255,255,0.05); border:1px solid var(--card-border); border-radius:12px; color:var(--light); font-size:16px; padding-left:50px; }
        .search-icon { position:absolute; left:20px; top:50%; transform: translateY(-50%); color:var(--gray); font-size:20px; }

        .filters { display:flex; gap:12px; flex-wrap:wrap; }
        .filter-btn { padding:10px 20px; background: rgba(255,255,255,0.05); border:1px solid var(--card-border); border-radius:10px; color:var(--gray); cursor:pointer; font-size:14px; font-weight:500; display:flex; align-items:center; gap:8px; }
        .filter-btn:hover { background: rgba(255,255,255,0.08); color:var(--light); border-color:var(--primary); transform: translateY(-1px); }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(99,102,241,0.2); }

        .players-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:24px; margin-bottom:50px; }
        .player-card { background: var(--card-bg); backdrop-filter: blur(10px); border:1px solid var(--card-border); border-radius:16px; padding:24px; transition: all 0.3s; position: relative; overflow:hidden; }
        .player-card:hover { transform: translateY(-4px); border-color: var(--primary); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .player-header { display:flex; align-items:center; margin-bottom:20px; }
        .player-avatar { width:64px; height:64px; border-radius:50%; position:relative; margin-right:16px; flex-shrink:0; }
        .player-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; border:2px solid var(--card-border); }
        .avatar-fallback { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; font-size:24px; font-weight:600; border-radius:50%; }
        .online-indicator { position:absolute; bottom:4px; right:4px; width:12px; height:12px; border-radius:50%; border:2px solid var(--dark); background:var(--success); }
        .online-indicator.offline { background:var(--gray); }
        .online-indicator.ingame { background:var(--warning); animation: pulse 2s infinite; }

        .player-info { flex:1; min-width:0; }
        .player-name-row { display:flex; align-items:center; gap:8px; margin-bottom:4px; }
        .player-name { font-size:18px; font-weight:600; color:var(--light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .player-rank { font-size:12px; font-weight:600; padding:4px 10px; border-radius:20px; text-transform:uppercase; letter-spacing:0.5px; }

        .player-actions { display:flex; flex-direction:column; gap:10px; }
        .friend-btn { width:100%; padding:10px; border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; border:1px solid; }
        .friend-btn.add-friend { background: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.3); color:#a5b4fc; }
        .friend-btn.remove-friend { background: rgba(16,185,129,0.1); border-color: rgba(16,185,129,0.3); color:#6ee7b7; }
        .friend-btn.pending { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.3); color:#fcd34d; cursor:not-allowed; }
        .friend-btn.invitation { background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.3); color:#93c5fd; }

        .pagination { display:flex; justify-content:center; align-items:center; gap:12px; margin-top:50px; }
        .page-btn { width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:var(--card-bg); border:1px solid var(--card-border); border-radius:10px; color:var(--gray); cursor:pointer; }
        .page-btn:hover:not(.disabled) { background: rgba(255,255,255,0.08); color:var(--light); border-color:var(--primary); }
        .page-btn.active { background:var(--primary); color:white; border-color:var(--primary); box-shadow: 0 4px 12px rgba(99,102,241,0.2); }
        .page-btn.disabled { opacity:0.5; cursor:not-allowed; }

        .loading-state { text-align:center; padding:60px 20px; grid-column:1 / -1; }
        .loading-spinner-small { width:40px; height:40px; border:3px solid var(--card-border); border-top:3px solid var(--primary); border-radius:50%; animation: spin 1s linear infinite; margin:0 auto 20px; }
        .no-results { text-align:center; padding:60px 20px; grid-column:1 / -1; }

        @media (max-width:1200px) {
            .players-grid { grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); }
        }
        @media (max-width:768px) {
            .players-container { padding:30px 16px; }
            .page-title { font-size:32px; }
            .players-grid { grid-template-columns:1fr; gap:20px; }
            .filters { justify-content:center; }
        }
        @media (max-width:480px) {
            .players-container { padding:24px 12px; }
            .page-title { font-size:28px; }
            .player-stats { grid-template-columns: repeat(2,1fr); }
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%{opacity:1;} 50%{opacity:0.5;} 100%{opacity:1;} }
    </style>
</head>
<body>

<!-- –õ–û–ê–î–ï–† -->
<div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
</div>

<!-- –•–ï–î–ï–† -->
<header class="site-header">
    <div class="header-content">
        <a href="index.html" class="logo">JojoLand</a>
        <nav class="nav-links">
            <a href="index.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="profile.html" class="nav-link">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="players.html" class="nav-link active">üë• –ò–≥—Ä–æ–∫–∏</a>
            <a href="friends.html" class="nav-link">ü§ù –î—Ä—É–∑—å—è</a>
            <a href="messages.html" class="nav-link">‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏—è</a>
            <a href="points.html" class="nav-link">üéÑ –û—á–∫–∏</a>
        </nav>
    </div>
</header>

<!-- –ö–û–ù–¢–ï–ù–¢ -->
<div id="content">
    <div class="players-container">
        <div class="page-header">
            <h1 class="page-title">–°–æ–æ–±—â–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤</h1>
            <p class="page-subtitle">–ù–∞–π–¥–∏—Ç–µ –¥—Ä—É–∑–µ–π, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–π—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–∞</p>
        </div>

        <div class="search-filters-section">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...">
                <div class="search-icon">üîç</div>
            </div>

            <div class="filters">
                <button class="filter-btn active" data-filter="all">üë• –í—Å–µ –∏–≥—Ä–æ–∫–∏</button>
                <button class="filter-btn" data-filter="online">üü¢ –û–Ω–ª–∞–π–Ω</button>
                <button class="filter-btn" data-filter="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button class="filter-btn" data-filter="moderator">‚ö° –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</button>
                <button class="filter-btn" data-filter="friends">ü§ù –ú–æ–∏ –¥—Ä—É–∑—å—è</button>
            </div>
        </div>

        <div class="players-grid" id="players-grid">
            <div class="loading-state" id="loading-players">
                <div class="loading-spinner-small"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
            </div>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>
</div>

<!-- BACK TO TOP -->
<button class="back-to-top" id="back-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö">‚Üë</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
/* players.html ‚Äî –ª–æ–≥–∏–∫–∞ */
const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// pagination & state
let currentPage = 1;
const playersPerPage = 9;
let allPlayers = [];
let filteredPlayers = [];
let currentUserId = null;
let currentUserNickname = null;

// helper: online status
function getOnlineStatus(userData) {
    if (!userData || !userData.lastVisit) return 'offline';
    const lastVisit = new Date(userData.lastVisit);
    const now = new Date();
    const diffMinutes = (now - lastVisit) / (1000 * 60);
    if (diffMinutes < 5) return 'online';
    if (diffMinutes < 15) return 'ingame';
    return 'offline';
}

function escapeQuotes(s) {
    return String(s||'').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// --- –î–†–£–ó–¨–Ø: –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ –∫–∞—Ä—Ç–æ—á–∫–∏) ---
async function isUserFriend(userId) {
    if (!currentUserId) return false;
    try {
        const snap = await database.ref(`friends/${currentUserId}/${userId}`).once('value');
        if (!snap.exists()) return false;
        const v = snap.val();
        // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –∏ –æ–±—ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
        if (typeof v === 'string') return v === 'accepted';
        return (v.status === 'accepted') || (v === 'accepted');
    } catch (err) {
        console.error('isUserFriend error', err);
        return false;
    }
}

async function hasSentRequest(userId) {
    if (!currentUserId) return false;
    try {
        const snap = await database.ref(`sent_requests/${currentUserId}/${userId}`).once('value');
        if (!snap.exists()) return false;
        const v = snap.val();
        return !v || v.status === 'pending' || v.status === undefined;
    } catch (err) {
        console.error('hasSentRequest error', err);
        return false;
    }
}

async function hasInvitationFrom(userId) {
    if (!currentUserId) return false;
    try {
        const snap = await database.ref(`friend_requests/${currentUserId}/${userId}`).once('value');
        if (!snap.exists()) return false;
        const v = snap.val();
        return !v || v.status === 'pending' || v.status === undefined;
    } catch (err) {
        console.error('hasInvitationFrom error', err);
        return false;
    }
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π (id)
async function getFriendsList() {
    try {
        if (!currentUserId) return [];
        const snapshot = await database.ref(`friends/${currentUserId}`).once('value');
        if (!snapshot.exists()) return [];
        const data = snapshot.val();
        const list = [];
        for (const id in data) {
            const entry = data[id];
            const status = typeof entry === 'string' ? entry : (entry.status || (entry === 'accepted' ? 'accepted' : null));
            if (status === 'accepted') list.push(id);
        }
        return list;
    } catch (err) {
        console.error('getFriendsList error', err);
        return [];
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ HTML –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–≥—Ä–æ–∫–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –¥—Ä—É–∑–µ–π/–∑–∞—è–≤–æ–∫)
async function createPlayerCard(player) {
    const nickname = player.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    const userId = player.userId || player.id;
    const firstLetter = (nickname.charAt(0) || '?').toUpperCase();
    const avatarImg = (player.avatar && player.avatar.startsWith('data:image')) ? `<img src="${player.avatar}" alt="${nickname}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">` : '';
    const fallbackStyle = avatarImg ? 'style="display:none"' : '';
    const online = getOnlineStatus(player);
    const onlineClass = online === 'online' ? '' : online === 'ingame' ? 'ingame' : 'offline';
    const rankClass = player.rank || 'player';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–Ω–æ–ø–∫–∏ (–ø–æ–ª—É—á–∞–µ–º –∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    let btnHTML = `<button class="friend-btn add-friend" onclick="addFriend('${userId}', '${escapeQuotes(nickname)}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>`;
    try {
        if (currentUserId) {
            if (currentUserId === userId) {
                btnHTML = `<div style="text-align:center; color:var(--gray)">–≠—Ç–æ –≤—ã</div>`;
            } else {
                const [isFriend, sent, invitation] = await Promise.all([
                    isUserFriend(userId),
                    hasSentRequest(userId),
                    hasInvitationFrom(userId)
                ]);
                if (isFriend) {
                    btnHTML = `<button class="friend-btn remove-friend" onclick="removeFriend('${userId}')">üë• –í –¥—Ä—É–∑—å—è—Ö</button>`;
                } else if (invitation) {
                    btnHTML = `<button class="friend-btn invitation" onclick="acceptFriendRequest('${userId}')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É</button>`;
                } else if (sent) {
                    btnHTML = `<button class="friend-btn pending">‚è≥ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</button>`;
                } else {
                    btnHTML = `<button class="friend-btn add-friend" onclick="addFriend('${userId}', '${escapeQuotes(nickname)}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>`;
                }
            }
        }
    } catch (err) {
        console.error('createPlayerCard status error', err);
    }

    const html = `
        <div class="player-card" data-user-id="${userId}">
            <div class="player-header">
                <div class="player-avatar">
                    ${avatarImg}
                    <div class="avatar-fallback" ${fallbackStyle}>${firstLetter}</div>
                    <div class="online-indicator ${onlineClass}"></div>
                </div>
                <div class="player-info">
                    <div class="player-name-row">
                        <div class="player-name">${nickname}</div>
                        <div class="player-rank ${rankClass}">${player.rank ? player.rank.toUpperCase() : 'PLAYER'}</div>
                    </div>
                    <div class="player-id">ID: ${String(userId).substring(0, 12)}</div>
                    <div class="player-status">${online === 'online' ? '–û–Ω–ª–∞–π–Ω' : online === 'ingame' ? '–í –∏–≥—Ä–µ' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
                </div>
            </div>

            <div class="player-actions">
                <button class="view-profile-btn" onclick="window.location.href='profile.html?user=${encodeURIComponent(userId)}'">üîç –ü—Ä–æ—Ñ–∏–ª—å</button>
                <div>${btnHTML}</div>
            </div>
        </div>
    `;
    return html;
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ /users
async function loadAllPlayers() {
    try {
        const usersSnapshot = await database.ref('users').once('value');
        if (!usersSnapshot.exists()) {
            console.warn('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î');
            return [];
        }
        const users = usersSnapshot.val();
        const players = [];
        for (const id in users) {
            const u = users[id];
            players.push({
                userId: id,
                nickname: u.nickname || u.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                avatar: u.avatar || '',
                lastVisit: u.lastVisit || u.last_online || null,
                rank: u.rank || (u.isAdmin ? 'admin' : (u.isMod ? 'moderator' : 'player')),
                visitsCount: u.visitsCount || u.visits || 0
            });
        }

        // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ‚Äî –æ–Ω–ª–∞–π–Ω/ingame -> —Ä–∞–Ω–≥–∏ -> –≤–∏–∑–∏—Ç—ã
        players.sort((a,b) => {
            const aOnline = getOnlineStatus(a) === 'online' ? 2 : getOnlineStatus(a) === 'ingame' ? 1 : 0;
            const bOnline = getOnlineStatus(b) === 'online' ? 2 : getOnlineStatus(b) === 'ingame' ? 1 : 0;
            if (aOnline !== bOnline) return bOnline - aOnline;
            const rankOrder = { 'admin': 4, 'moderator': 3, 'vip': 2, 'player': 1 };
            const ra = rankOrder[a.rank] || 1;
            const rb = rankOrder[b.rank] || 1;
            if (ra !== rb) return rb - ra;
            const aVisits = a.visitsCount || 0;
            const bVisits = b.visitsCount || 0;
            return bVisits - aVisits;
        });

        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${players.length} –∏–≥—Ä–æ–∫–æ–≤`);
        return players;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤:', error);
        showNoResults('players-grid', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        return [];
    }
}

// –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∏–≥—Ä–æ–∫–æ–≤ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
async function displayPlayers(players, containerId) {
    const container = document.getElementById(containerId);
    if (!players || players.length === 0) {
        showNoResults(containerId, '–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
    }

    container.innerHTML = '';
    const totalPages = Math.ceil(players.length / playersPerPage);
    const startIndex = (currentPage - 1) * playersPerPage;
    const endIndex = startIndex + playersPerPage;
    const pagePlayers = players.slice(startIndex, endIndex);

    // placeholder loaders
    for (let i = 0; i < Math.min(pagePlayers.length, playersPerPage); i++) {
        container.innerHTML += `
            <div class="player-card">
                <div class="loading-spinner-small"></div>
            </div>
        `;
    }

    const cardsHTML = await Promise.all(pagePlayers.map(p => createPlayerCard(p)));
    container.innerHTML = cardsHTML.join('');
    updatePagination(totalPages);
}

// –û–±–Ω–æ–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é
function updatePagination(totalPages) {
    const pagination = document.getElementById('pagination');
    if (totalPages <= 1) { pagination.innerHTML = ''; return; }
    let html = '';
    html += `<button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" onclick="changePage(${Math.max(1, currentPage - 1)})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê</button>`;
    for (let i = 1; i <= totalPages; i++) {
        html += `<button class="page-btn ${currentPage === i ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
    }
    html += `<button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" onclick="changePage(${Math.min(totalPages, currentPage + 1)})" ${currentPage === totalPages ? 'disabled' : ''}>‚Üí</button>`;
    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    displayPlayers(filteredPlayers, 'players-grid');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
async function filterPlayers(filter, buttonElement) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    if (buttonElement) buttonElement.classList.add('active');

    let filtered = [];
    switch (filter) {
        case 'online':
            filtered = allPlayers.filter(p => getOnlineStatus(p) === 'online');
            break;
        case 'admin':
            filtered = allPlayers.filter(p => p.rank === 'admin');
            break;
        case 'moderator':
            filtered = allPlayers.filter(p => p.rank === 'moderator');
            break;
        case 'friends':
            if (!currentUserId) {
                alert('–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥—Ä—É–∑–µ–π –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç');
                filtered = allPlayers;
                break;
            }
            const friendsList = await getFriendsList();
            filtered = allPlayers.filter(p => friendsList.includes(p.userId));
            break;
        case 'all':
        default:
            filtered = allPlayers;
            break;
    }
    filteredPlayers = filtered;
    currentPage = 1;
    displayPlayers(filteredPlayers, 'players-grid');
}

// –ü–æ–∏—Å–∫
function setupSearch() {
    const searchInput = document.getElementById('search-input');
    const searchTimeout = 300;
    let timeoutId;
    searchInput.addEventListener('input', function(e) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            const searchTerm = this.value.toLowerCase().trim();
            if (searchTerm.length === 0) {
                filteredPlayers = allPlayers;
                currentPage = 1;
                displayPlayers(filteredPlayers, 'players-grid');
                return;
            }
            const searchResults = allPlayers.filter(player =>
                player.nickname && player.nickname.toLowerCase().includes(searchTerm)
            );
            filteredPlayers = searchResults;
            currentPage = 1;
            displayPlayers(filteredPlayers, 'players-grid');
        }, searchTimeout);
    });
}

// UI —É—Ç–∏–ª–∏—Ç—ã
function showLoading(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `<div class="loading-state"><div class="loading-spinner-small"></div><p>${message}</p></div>`;
    }
}
function showNoResults(containerId, message) {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `<div class="no-results"><div class="no-results-icon">üë§</div><h3>${message}</h3><p style="color:var(--gray)">${message.toLowerCase().includes('–æ—à–∏–±–∫–∞') ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.' : '–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º –∏–≥—Ä–æ–∫–æ–º!'}</p></div>`;
    }
}

// –ö–Ω–æ–ø–∫–∏ –¥—Ä—É–∑–µ–π ‚Äî –æ–ø–µ—Ä–∞—Ü–∏–∏: add, accept, reject, cancel, remove
async function addFriend(userId, nickname) {
    if (!currentUserId) { alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞—è–≤–∫–∏'); return; }
    if (currentUserId === userId) { alert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è'); return; }
    if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å ${nickname} –≤ –¥—Ä—É–∑—å—è?`)) return;
    try {
        const ts = Date.now();
        await database.ref(`friend_requests/${userId}/${currentUserId}`).set({
            fromNickname: currentUserNickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            timestamp: ts,
            status: 'pending'
        });
        await database.ref(`sent_requests/${currentUserId}/${userId}`).set({
            toNickname: nickname,
            timestamp: ts,
            status: 'pending'
        });
        alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
        // –æ–±–Ω–æ–≤–∏–º UI: –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        displayPlayers(filteredPlayers, 'players-grid');
    } catch (err) {
        console.error('addFriend error', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏');
    }
}

async function acceptFriendRequest(userId) {
    if (!currentUserId) return;
    try {
        const ts = Date.now();
        const fromUserSnapshot = await database.ref(`users/${userId}`).once('value');
        const fromUserData = fromUserSnapshot.exists() ? fromUserSnapshot.val() : {nickname:'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'};
        await database.ref(`friends/${currentUserId}/${userId}`).set({ nickname: fromUserData.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', status: 'accepted', since: ts });
        await database.ref(`friends/${userId}/${currentUserId}`).set({ nickname: currentUserNickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', status: 'accepted', since: ts });
        await database.ref(`friend_requests/${currentUserId}/${userId}`).remove();
        await database.ref(`sent_requests/${userId}/${currentUserId}`).remove();
        alert('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è');
        // –æ–±–Ω–æ–≤–∏—Ç—å UI
        allPlayers = await loadAllPlayers();
        filteredPlayers = allPlayers;
        displayPlayers(filteredPlayers, 'players-grid');
    } catch (err) {
        console.error('acceptFriendRequest error', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞—è–≤–∫–∏');
    }
}

async function rejectFriendRequest(userId) {
    if (!currentUserId) return;
    if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
    try {
        await database.ref(`friend_requests/${currentUserId}/${userId}`).remove();
        await database.ref(`sent_requests/${userId}/${currentUserId}`).remove();
        alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
        // –æ–±–Ω–æ–≤–∏–º UI
        allPlayers = await loadAllPlayers();
        filteredPlayers = allPlayers;
        displayPlayers(filteredPlayers, 'players-grid');
    } catch (err) {
        console.error('rejectFriendRequest error', err);
    }
}

async function cancelSentRequest(userId) {
    if (!currentUserId) return;
    if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –∑–∞—è–≤–∫—É?')) return;
    try {
        await database.ref(`sent_requests/${currentUserId}/${userId}`).remove();
        await database.ref(`friend_requests/${userId}/${currentUserId}`).remove();
        alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
        // –æ–±–Ω–æ–≤–∏–º UI
        allPlayers = await loadAllPlayers();
        filteredPlayers = allPlayers;
        displayPlayers(filteredPlayers, 'players-grid');
    } catch (err) {
        console.error('cancelSentRequest error', err);
    }
}

async function removeFriend(userId) {
    if (!currentUserId) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π?')) return;
    try {
        await database.ref(`friends/${currentUserId}/${userId}`).remove();
        await database.ref(`friends/${userId}/${currentUserId}`).remove();
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω –∏–∑ –¥—Ä—É–∑–µ–π');
        // –æ–±–Ω–æ–≤–∏–º UI
        allPlayers = await loadAllPlayers();
        filteredPlayers = allPlayers;
        displayPlayers(filteredPlayers, 'players-grid');
    } catch (err) {
        console.error('removeFriend error', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
}

// Back to top
function setupBackToTop() {
    const backToTopBtn = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) backToTopBtn.classList.add('visible'); else backToTopBtn.classList.remove('visible');
    });
    backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
}

// Auth check (localStorage)
function checkAuth() {
    const isLoggedIn = localStorage.getItem('jojoland_loggedIn') === 'true';
    const nickname = localStorage.getItem('jojoland_nickname');
    const userId = localStorage.getItem('jojoland_userId');
    if (isLoggedIn && nickname && userId) {
        currentUserId = userId;
        currentUserNickname = nickname;
        return true;
    }
    return false;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
async function initPlayersPage() {
    try {
        checkAuth(); // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç currentUserId –µ—Å–ª–∏ –µ—Å—Ç—å
        allPlayers = await loadAllPlayers();
        filteredPlayers = allPlayers;
        await displayPlayers(filteredPlayers, 'players-grid');
        setupSearch();
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => filterPlayers(btn.dataset.filter, btn));
        });
        setupBackToTop();
    } catch (err) {
        console.error('initPlayersPage error', err);
        showNoResults('players-grid', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    }
}

// window.onload
window.onload = async function() {
    // —Å–∫—Ä—ã—Ç—å –ª–æ–∞–¥–µ—Ä
    const loader = document.getElementById("loader");
    if (loader) { loader.style.opacity = "0"; setTimeout(()=>{ loader.style.display = "none"; document.getElementById('content').style.opacity = '1'; }, 400); }
    await initPlayersPage();
};
</script>

</body>
</html>
