<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–æ–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ | JojoLand</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- –ò–≥—Ä–æ–≤–æ–π —à—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* –°–¢–ò–õ–ò –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –ò–ì–†–û–ö–û–í */
        .players-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-title {
            color: #ffcc00;
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }
        
        .page-subtitle {
            color: #aaaaff;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        /* –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ */
        .search-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(98, 0, 255, 0.3);
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        #search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid #6200ff;
            border-radius: 12px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        #search-input:focus {
            outline: none;
            border-color: #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
        }
        
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaaaff;
            font-size: 20px;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #aaaaff;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: rgba(98, 0, 255, 0.3);
            color: white;
            border-color: #6200ff;
        }
        
        /* –ö–ê–¢–ï–ì–û–†–ò–ò –ò–ì–†–û–ö–û–í */
        .players-category {
            margin-bottom: 40px;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffcc00;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 204, 0, 0.3);
        }
        
        .category-badge {
            background: linear-gradient(90deg, #ff4444, #ff9900);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* –°–ï–¢–ö–ê –ò–ì–†–û–ö–û–í */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* –ö–ê–†–¢–û–ß–ö–ê –ò–ì–†–û–ö–ê */
        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            border-color: #6200ff;
            box-shadow: 0 10px 30px rgba(98, 0, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .player-card.admin {
            border: 2px solid #ff4444;
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), rgba(255, 153, 0, 0.1));
        }
        
        .player-card.moderator {
            border: 2px solid #00ccff;
            background: linear-gradient(135deg, rgba(0, 204, 255, 0.1), rgba(0, 102, 255, 0.1));
        }
        
        .player-card.vip {
            border: 2px solid #ffcc00;
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.1), rgba(255, 153, 0, 0.1));
        }
        
        .player-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 15px;
            border: 2px solid #ffcc00;
            position: relative;
            overflow: hidden;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .player-avatar .avatar-initial {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            color: white;
            font-size: 18px;
            margin: 0 0 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .player-rank {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .player-rank.admin {
            background: linear-gradient(90deg, #ff4444, #ff9900);
            color: white;
        }
        
        .player-rank.moderator {
            background: linear-gradient(90deg, #00ccff, #0066ff);
            color: white;
        }
        
        .player-rank.vip {
            background: linear-gradient(90deg, #ffcc00, #ff9900);
            color: black;
        }
        
        .player-rank.player {
            background: rgba(255, 255, 255, 0.1);
            color: #aaaaff;
        }
        
        .player-id {
            color: #aaaaff;
            font-size: 12px;
            margin: 0;
        }
        
        /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ì–†–û–ö–ê */
        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 8px;
        }
        
        .stat-value {
            color: #ffcc00;
            font-size: 16px;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            color: #aaaaff;
            font-size: 10px;
            display: block;
            margin-top: 2px;
        }
        
        /* –ö–ù–û–ü–ö–ê –ü–†–û–°–ú–û–¢–†–ê –ü–†–û–§–ò–õ–Ø */
        .view-profile-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: rgba(98, 0, 255, 0.2);
            border: 1px solid #6200ff;
            border-radius: 10px;
            color: white;
            text-decoration: none;
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
        }
        
        .view-profile-btn:hover {
            background: rgba(98, 0, 255, 0.4);
            transform: translateY(-2px);
        }
        
        /* –û–ù–õ–ê–ô–ù –°–¢–ê–¢–£–° */
        .online-status {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .status-dot.offline {
            background: #ff4444;
        }
        
        .status-dot.ingame {
            background: #ffcc00;
            box-shadow: 0 0 10px #ffcc00;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* –ü–ê–ì–ò–ù–ê–¶–ò–Ø */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 40px;
        }
        
        .page-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #aaaaff;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            border: none;
        }
        
        .page-btn:hover,
        .page-btn.active {
            background: rgba(98, 0, 255, 0.3);
            color: white;
        }
        
        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* –ó–ê–ì–†–£–ó–ö–ê */
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaaaff;
            font-size: 18px;
            grid-column: 1 / -1;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #6200ff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –ù–ò–ß–ï–ì–û –ù–ï –ù–ê–ô–î–ï–ù–û */
        .no-results {
            text-align: center;
            padding: 40px;
            color: #aaaaff;
            font-size: 18px;
            grid-column: 1 / -1;
        }
        
        /* –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –ò–ì–†–û–ö–ï –ü–†–ò –ù–ê–í–ï–î–ï–ù–ò–ò */
        .player-tooltip {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            pointer-events: none;
            z-index: 10;
            border: 1px solid #6200ff;
        }
        
        .player-card:hover .player-tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .player-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-btn {
                width: 100%;
                text-align: center;
            }
            
            .category-title {
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .player-header {
                flex-direction: column;
                text-align: center;
            }
            
            .player-avatar {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .page-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

<!-- –ê–ù–ò–ú–ê–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loader">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
</div>

<!-- –§–û–ù–û–í–´–ï –≠–§–§–ï–ö–¢–´ -->
<div class="background-effects" id="particles"></div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
<div id="content">
    <header>
        <div class="header-top">
            <a href="index.html" class="profile-btn">
                <span class="profile-icon">üè†</span>
                <span class="profile-text">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </a>
            <img src="images/logo.png" class="logo" alt="JojoLand Logo">
        </div>
        
        <h1>–ò–≥—Ä–æ–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞</h1>
        <p class="subtitle">–í—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ JojoLand</p>
        
        <nav>
            <a href="index.html" class="nav-btn">üè† –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="profile.html" class="nav-btn">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
            <a href="points.html" class="nav-btn">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –æ—á–∫–∏</a>
            <a href="tgk.html" class="nav-btn">üìò TGK —á–∞—Ç</a>
        </nav>
    </header>

    <div class="players-container">
        <!-- –ó–ê–ì–û–õ–û–í–û–ö –°–¢–†–ê–ù–ò–¶–´ -->
        <div class="page-header">
            <h2 class="page-title">üë• –°–æ–æ–±—â–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–µ—Ä–∞</h2>
            <p class="page-subtitle">–ù–∞–π–¥–∏—Ç–µ –¥—Ä—É–∑–µ–π, –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤</p>
        </div>

        <!-- –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ -->
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...">
                <div class="search-icon">üîç</div>
            </div>
            
            <div class="filters">
                <button class="filter-btn active" data-filter="all">–í—Å–µ –∏–≥—Ä–æ–∫–∏</button>
                <button class="filter-btn" data-filter="online">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</button>
                <button class="filter-btn" data-filter="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button class="filter-btn" data-filter="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</button>
                <button class="filter-btn" data-filter="vip">VIP –∏–≥—Ä–æ–∫–∏</button>
                <button class="filter-btn" data-filter="new">–ù–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏</button>
                <button class="filter-btn" data-filter="players">–¢–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∏</button>
            </div>
        </div>

        <!-- –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–Ø -->
        <div class="players-category">
            <h3 class="category-title">
                <span>üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                <span class="category-badge" id="admins-count">0</span>
            </h3>
            <div class="players-grid" id="admins-container">
                <!-- –ê–¥–º–∏–Ω—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                <div class="loading" id="loading-admins">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏...</p>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ï–†–ê–¢–û–†–´ -->
        <div class="players-category">
            <h3 class="category-title">
                <span>‚ö° –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</span>
                <span class="category-badge" id="moderators-count">0</span>
            </h3>
            <div class="players-grid" id="moderators-container">
                <!-- –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                <div class="loading" id="loading-moderators">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤...</p>
                </div>
            </div>
        </div>

        <!-- VIP –ò–ì–†–û–ö–ò -->
        <div class="players-category">
            <h3 class="category-title">
                <span>‚≠ê VIP –∏–≥—Ä–æ–∫–∏</span>
                <span class="category-badge" id="vip-count">0</span>
            </h3>
            <div class="players-grid" id="vip-container">
                <!-- VIP –∏–≥—Ä–æ–∫–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                <div class="loading" id="loading-vip">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ VIP –∏–≥—Ä–æ–∫–æ–≤...</p>
                </div>
            </div>
        </div>

        <!-- –í–°–ï –ò–ì–†–û–ö–ò (–ë–ï–ó –ê–î–ú–ò–ù–û–í, –ú–û–î–ï–†–ê–¢–û–†–û–í –ò VIP) -->
        <div class="players-category">
            <h3 class="category-title">
                <span>üéÆ –í—Å–µ –∏–≥—Ä–æ–∫–∏</span>
                <span class="category-badge" id="players-count">0</span>
            </h3>
            <div class="players-grid" id="players-container">
                <!-- –ò–≥—Ä–æ–∫–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                <div class="loading" id="loading-players">
                    <div class="loading-spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
                </div>
            </div>
        </div>

        <!-- –ü–ê–ì–ò–ù–ê–¶–ò–Ø -->
        <div class="pagination" id="pagination">
            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>

        <!-- –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î -->
        <div style="text-align: center; margin-top: 40px;">
            <a href="index.html" class="action-btn" style="display: inline-block; width: auto; padding: 12px 30px;">
                üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
    authDomain: "jojoland-chat.firebasestorage.app",
    databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
    projectId: "jojoland-chat",
    storageBucket: "jojoland-chat.firebasestorage.app",
    messagingSenderId: "602788305122",
    appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ü–ê–ì–ò–ù–ê–¶–ò–ò
let currentPage = 1;
const playersPerPage = 12;
let allPlayers = [];
let regularPlayers = []; // –¢–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ –∏–≥—Ä–æ–∫–∏ (–±–µ–∑ –∞–¥–º–∏–Ω–æ–≤/–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤/VIP)
let filteredPlayers = [];

// ==================== –°–û–ó–î–ê–ù–ò–ï –ß–ê–°–¢–ò–¶ ====================
function createParticles() {
    const particlesContainer = document.getElementById('particles');
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        
        const size = Math.random() * 2 + 1;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        particle.style.opacity = Math.random() * 0.5 + 0.2;
        
        const duration = Math.random() * 20 + 15;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${Math.random() * 10}s`;
        
        particlesContainer.appendChild(particle);
    }
}

// ==================== –ü–û–õ–£–ß–ï–ù–ò–ï –†–ê–ù–ì–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ====================
async function getUserRank(userData, userId) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –≤–µ—Ç–∫–µ admins
        const adminSnapshot = await database.ref('admins/' + userId).once('value');
        if (adminSnapshot.exists() && adminSnapshot.val() === true) {
            return 'admin';
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ rank —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (userData.rank === 'admin') {
            return 'admin';
        } else if (userData.rank === 'moderator') {
            return 'moderator';
        } else if (userData.rank === 'vip') {
            return 'vip';
        }
        
        return 'player';
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–Ω–≥–∞:', error);
        return 'player';
    }
}

// ==================== –ü–û–õ–£–ß–ï–ù–ò–ï –û–ß–ö–û–í –ò–ì–†–û–ö–ê ====================
async function getUserPoints(userId) {
    try {
        const snapshot = await database.ref('holiday_points/' + userId).once('value');
        if (snapshot.exists()) {
            const pointsData = snapshot.val();
            return pointsData.total_points || pointsData.totalPoints || 0;
        }
        return 0;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–∫–æ–≤:', error);
        return 0;
    }
}

// ==================== –ü–û–õ–£–ß–ï–ù–ò–ï –ê–í–ê–¢–ê–†–ê –ò–ì–†–û–ö–ê ====================
async function getUserAvatar(userId) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –≤ localStorage
        const cachedAvatar = localStorage.getItem(`jojoland_avatar_${userId}`);
        if (cachedAvatar) {
            return cachedAvatar;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        const snapshot = await database.ref('users/' + userId).once('value');
        if (snapshot.exists()) {
            const userData = snapshot.val();
            if (userData.avatar && userData.avatar.startsWith('data:image')) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                localStorage.setItem(`jojoland_avatar_${userId}`, userData.avatar);
                return userData.avatar;
            }
        }
        return 'default';
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', error);
        return 'default';
    }
}

// ==================== –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –û–ù–õ–ê–ô–ù ====================
function getOnlineStatus(userData) {
    if (!userData.lastVisit) return 'offline';
    
    const lastVisit = new Date(userData.lastVisit);
    const now = new Date();
    const diffMinutes = (now - lastVisit) / (1000 * 60);
    
    if (diffMinutes < 5) return 'online'; // –ë—ã–ª –æ–Ω–ª–∞–π–Ω –º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
    if (diffMinutes < 15) return 'ingame'; // –ë—ã–ª –æ–Ω–ª–∞–π–Ω –º–µ–Ω–µ–µ 15 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
    return 'offline';
}

// ==================== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–¢–´ ====================
function formatDate(dateString) {
    if (!dateString) return '--.--.----';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU');
    } catch (error) {
        return '--.--.----';
    }
}

// ==================== –°–û–ó–î–ê–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò –ò–ì–†–û–ö–ê ====================
function createPlayerCard(player, points = 0, avatar = null) {
    const rank = player.rank || 'player';
    const onlineStatus = getOnlineStatus(player);
    const createdAt = formatDate(player.createdAt || player.registeredAt);
    const visits = player.visitsCount || 1;
    
    const statusText = {
        'online': '–û–Ω–ª–∞–π–Ω',
        'ingame': '–í –∏–≥—Ä–µ',
        'offline': '–ù–µ –≤ —Å–µ—Ç–∏'
    };
    
    const rankText = {
        'admin': '–ê–¥–º–∏–Ω',
        'moderator': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
        'vip': 'VIP',
        'player': '–ò–≥—Ä–æ–∫'
    };
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º userId –∏–ª–∏ id
    const userId = player.userId || player.id;
    if (!userId) {
        console.error('–£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç ID:', player);
        return '';
    }
    
    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
    let avatarHTML = '';
    if (avatar && avatar !== 'default') {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∞–≤–∞—Ç–∞—Ä
        avatarHTML = `
            <img src="${avatar}" alt="${player.nickname}" 
                 onerror="this.style.display='none'; 
                          document.querySelector('#avatar-fallback-${userId}').style.display='flex';">
            <div id="avatar-fallback-${userId}" class="avatar-initial" style="display: none;">
                ${player.nickname?.charAt(0).toUpperCase() || 'üë§'}
            </div>
        `;
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –Ω–∏–∫–∞
        avatarHTML = `
            <div class="avatar-initial">
                ${player.nickname?.charAt(0).toUpperCase() || 'üë§'}
            </div>
        `;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ –ø–æ —Ä–∞–Ω–≥—É
    const avatarBorderColor = {
        'admin': '#ff4444',
        'moderator': '#00ccff',
        'vip': '#ffcc00',
        'player': '#6200ff'
    };
    
    return `
        <div class="player-card ${rank}" data-user-id="${userId}" data-rank="${rank}">
            <div class="player-header">
                <div class="player-avatar" style="border-color: ${avatarBorderColor[rank]};">
                    ${avatarHTML}
                </div>
                <div class="player-info">
                    <h4 class="player-name">
                        ${player.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                        <span class="player-rank ${rank}">${rankText[rank]}</span>
                    </h4>
                    <p class="player-id">ID: ${userId}</p>
                </div>
                <div class="online-status">
                    <div class="status-dot ${onlineStatus}"></div>
                    <span>${statusText[onlineStatus]}</span>
                </div>
            </div>
            
            <div class="player-stats">
                <div class="stat-item">
                    <span class="stat-value">${points}</span>
                    <span class="stat-label">üéÑ –û—á–∫–æ–≤</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${visits}</span>
                    <span class="stat-label">üìÖ –í–∏–∑–∏—Ç–æ–≤</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${createdAt}</span>
                    <span class="stat-label">üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                </div>
            </div>
            
            <button class="view-profile-btn" onclick="viewPlayerProfile('${userId}')">
                üëÅÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            
            <div class="player-tooltip">
                <p><strong>–ù–∏–∫:</strong> ${player.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                <p><strong>–†–∞–Ω–≥:</strong> ${rankText[rank]}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusText[onlineStatus]}</p>
                <p><strong>–ù–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –æ—á–∫–æ–≤:</strong> ${points}</p>
                <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${createdAt}</p>
            </div>
        </div>
    `;
}

// ==================== –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø –ò–ì–†–û–ö–ê ====================
function viewPlayerProfile(userId) {
    console.log('–ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é –∏–≥—Ä–æ–∫–∞:', userId);
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
    window.location.href = `profile.html?view=${userId}`;
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–• –ò–ì–†–û–ö–û–í ====================
async function loadAllPlayers() {
    try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        showLoading('players-container', '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...');
        showLoading('admins-container', '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏...');
        showLoading('moderators-container', '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤...');
        showLoading('vip-container', '–ó–∞–≥—Ä—É–∑–∫–∞ VIP –∏–≥—Ä–æ–∫–æ–≤...');
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const usersSnapshot = await database.ref('users').once('value');
        
        if (!usersSnapshot.exists()) {
            showNoResults('players-container', '–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤.');
            showNoResults('admins-container', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
            showNoResults('moderators-container', '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
            showNoResults('vip-container', 'VIP –∏–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
            return [[], [], [], [], []];
        }
        
        const admins = [];
        const moderators = [];
        const vipPlayers = [];
        const regularPlayersList = [];
        const allPlayersList = [];
        
        const users = usersSnapshot.val();
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞–Ω–≥–∞–º
        for (const userId in users) {
            const userData = users[userId];
            if (userData.nickname) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–Ω–≥ –∏–≥—Ä–æ–∫–∞
                const rank = await getUserRank(userData, userId);
                const playerWithRank = {
                    ...userData,
                    userId: userId,
                    id: userId,
                    rank: rank // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–Ω–≥ –≤ –æ–±—ä–µ–∫—Ç –∏–≥—Ä–æ–∫–∞
                };
                
                allPlayersList.push(playerWithRank);
                
                // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                if (rank === 'admin') {
                    admins.push(playerWithRank);
                } else if (rank === 'moderator') {
                    moderators.push(playerWithRank);
                } else if (rank === 'vip') {
                    vipPlayers.push(playerWithRank);
                } else {
                    regularPlayersList.push(playerWithRank);
                }
            }
        }
        
        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤:`, {
            total: allPlayersList.length,
            admins: admins.length,
            moderators: moderators.length,
            vip: vipPlayers.length,
            regular: regularPlayersList.length
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        document.getElementById('admins-count').textContent = admins.length;
        document.getElementById('moderators-count').textContent = moderators.length;
        document.getElementById('vip-count').textContent = vipPlayers.length;
        document.getElementById('players-count').textContent = regularPlayersList.length;
        
        return [admins, moderators, vipPlayers, regularPlayersList, allPlayersList];
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤:', error);
        showNoResults('players-container', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤.');
        showNoResults('admins-container', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
        showNoResults('moderators-container', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤.');
        showNoResults('vip-container', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ VIP –∏–≥—Ä–æ–∫–æ–≤.');
        return [[], [], [], [], []];
    }
}

// ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ò–ì–†–û–ö–û–í ====================
async function displayPlayers(players, containerId, showPagination = true) {
    const container = document.getElementById(containerId);
    
    if (!players || players.length === 0) {
        if (containerId === 'players-container') {
            showNoResults(containerId, '–ù–µ—Ç –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤.');
        } else if (containerId === 'admins-container') {
            showNoResults(containerId, '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
        } else if (containerId === 'moderators-container') {
            showNoResults(containerId, '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
        } else if (containerId === 'vip-container') {
            showNoResults(containerId, 'VIP –∏–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
        } else {
            showNoResults(containerId, '–ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
        }
        return;
    }
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.innerHTML = '';
    
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤)
    if (showPagination && containerId === 'players-container') {
        const totalPages = Math.ceil(players.length / playersPerPage);
        const startIndex = (currentPage - 1) * playersPerPage;
        const endIndex = startIndex + playersPerPage;
        const pagePlayers = players.slice(startIndex, endIndex);
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        for (const player of pagePlayers) {
            const [points, avatar] = await Promise.all([
                getUserPoints(player.userId || player.id),
                getUserAvatar(player.userId || player.id)
            ]);
            container.innerHTML += createPlayerCard(player, points, avatar);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        updatePagination(totalPages);
        
    } else {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤/–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤/VIP)
        for (const player of players) {
            const [points, avatar] = await Promise.all([
                getUserPoints(player.userId || player.id),
                getUserAvatar(player.userId || player.id)
            ]);
            container.innerHTML += createPlayerCard(player, points, avatar);
        }
    }
}

// ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–ê–ì–ò–ù–ê–¶–ò–ò ====================
function updatePagination(totalPages) {
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    html += `
        <button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                onclick="changePage(${currentPage - 1})" 
                ${currentPage === 1 ? 'disabled' : ''}>
            ‚Üê
        </button>
    `;
    
    // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
    const maxPagesToShow = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
    
    if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                    onclick="changePage(${i})">
                ${i}
            </button>
        `;
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
    html += `
        <button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                onclick="changePage(${currentPage + 1})" 
                ${currentPage === totalPages ? 'disabled' : ''}>
            ‚Üí
        </button>
    `;
    
    pagination.innerHTML = html;
}

// ==================== –°–ú–ï–ù–ê –°–¢–†–ê–ù–ò–¶–´ ====================
function changePage(page) {
    currentPage = page;
    displayPlayers(filteredPlayers, 'players-container', true);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ==================== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò–ì–†–û–ö–û–í ====================
function filterPlayers(filter) {
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    let filtered = [];
    
    switch (filter) {
        case 'online':
            // –§–∏–ª—å—Ç—Ä—É–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –æ–Ω–ª–∞–π–Ω
            const allOnlinePlayers = allPlayers.filter(player => getOnlineStatus(player) === 'online');
            displayAllPlayersByFilter(allOnlinePlayers, '–û–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–∏');
            return;
            
        case 'admin':
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–æ–≤
            displayAllPlayersByFilter(adminsList, '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è');
            return;
            
        case 'moderator':
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
            displayAllPlayersByFilter(moderatorsList, '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã');
            return;
            
        case 'vip':
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ VIP
            displayAllPlayersByFilter(vipList, 'VIP –∏–≥—Ä–æ–∫–∏');
            return;
            
        case 'new':
            // –ù–æ–≤—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const newPlayers = allPlayers.filter(player => {
                const created = new Date(player.createdAt || player.registeredAt);
                return created > weekAgo;
            });
            displayAllPlayersByFilter(newPlayers, '–ù–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)');
            return;
            
        case 'players':
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
            filtered = [...regularPlayers];
            break;
            
        case 'all':
        default:
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ (–≤–∫–ª—é—á–∞—è –≤—Å–µ —Ä–∞–Ω–≥–∏)
            filtered = [...allPlayers];
            break;
    }
    
    filteredPlayers = filtered;
    currentPage = 1;
    displayPlayers(filteredPlayers, 'players-container', true);
}

// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–ü–ò–°–ö–û–í
let adminsList = [];
let moderatorsList = [];
let vipList = [];

// ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –í–°–ï–• –ò–ì–†–û–ö–û–í –ü–û –§–ò–õ–¨–¢–†–£ ====================
async function displayAllPlayersByFilter(players, title) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.querySelectorAll('.players-category').forEach(cat => {
        cat.style.display = 'none';
    });
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const playersContainer = document.querySelector('.players-container');
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const oldFilterCategory = document.getElementById('filtered-results');
    if (oldFilterCategory) {
        oldFilterCategory.remove();
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    const filterCategory = document.createElement('div');
    filterCategory.className = 'players-category';
    filterCategory.id = 'filtered-results';
    
    filterCategory.innerHTML = `
        <h3 class="category-title">
            <span>üîç ${title}</span>
            <span class="category-badge">${players.length} –∏–≥—Ä–æ–∫–æ–≤</span>
        </h3>
        <div class="players-grid" id="filtered-players-container">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="action-btn" onclick="showAllCategories()" style="width: auto;">
                ‚Üê –ù–∞–∑–∞–¥ –∫–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            </button>
        </div>
    `;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ search-section
    const searchSection = document.querySelector('.search-section');
    searchSection.parentNode.insertBefore(filterCategory, searchSection.nextSibling);
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤
    const container = document.getElementById('filtered-players-container');
    container.innerHTML = '';
    
    if (!players || players.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
            </div>
        `;
        return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä—ã –∏ –æ—á–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
    for (const player of players) {
        const [points, avatar] = await Promise.all([
            getUserPoints(player.userId || player.id),
            getUserAvatar(player.userId || player.id)
        ]);
        container.innerHTML += createPlayerCard(player, points, avatar);
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    document.getElementById('pagination').style.display = 'none';
}

// ==================== –ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ö–ê–¢–ï–ì–û–†–ò–ò ====================
function showAllCategories() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.querySelectorAll('.players-category').forEach(cat => {
        cat.style.display = 'block';
    });
    
    // –£–¥–∞–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const filterCategory = document.getElementById('filtered-results');
    if (filterCategory) {
        filterCategory.remove();
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
    document.getElementById('pagination').style.display = 'flex';
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–í—Å–µ –∏–≥—Ä–æ–∫–∏"
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === 'all') {
            btn.classList.add('active');
        }
    });
}

// ==================== –ü–û–ò–°–ö –ò–ì–†–û–ö–û–í ====================
function setupSearch() {
    const searchInput = document.getElementById('search-input');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm.length === 0) {
            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            showAllCategories();
            return;
        }
        
        // –ò—â–µ–º –≤–æ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–∞—Ö
        const searchResults = allPlayers.filter(player => 
            player.nickname && player.nickname.toLowerCase().includes(searchTerm)
        );
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        displayAllPlayersByFilter(searchResults, `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "${searchTerm}"`);
    });
}

// ==================== –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ====================
function showLoading(containerId, message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>${message}</p>
            </div>
        `;
    }
}

function showNoResults(containerId, message = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.') {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="no-results">
                <p>${message}</p>
            </div>
        `;
    }
}

// ==================== –û–ß–ò–°–¢–ö–ê –ö–≠–®–ê –ê–í–ê–¢–ê–†–û–í ====================
function clearAvatarCache() {
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('jojoland_avatar_')) {
            keysToRemove.push(key);
        }
    }
    
    keysToRemove.forEach(key => {
        localStorage.removeItem(key);
    });
    
    console.log(`–û—á–∏—â–µ–Ω –∫—ç—à ${keysToRemove.length} –∞–≤–∞—Ç–∞—Ä–æ–≤`);
}

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ ====================
async function initPlayersPage() {
    try {
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à –∞–≤–∞—Ç–∞—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        // clearAvatarCache();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ —Ä–∞–∑–¥–µ–ª—è–µ–º –ø–æ —Ä–∞–Ω–≥–∞–º
        const [admins, moderators, vip, regular, all] = await loadAllPlayers();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        adminsList = admins;
        moderatorsList = moderators;
        vipList = vip;
        regularPlayers = regular;
        allPlayers = all;
        filteredPlayers = [...regular]; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        await displayPlayers(admins, 'admins-container', false);
        await displayPlayers(moderators, 'moderators-container', false);
        await displayPlayers(vip, 'vip-container', false);
        await displayPlayers(regular, 'players-container', true);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
        setupSearch();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => filterPlayers(btn.dataset.filter));
        });
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
        showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö.');
    }
}

// ==================== –ü–û–ö–ê–ó–ê–¢–¨ –û–®–ò–ë–ö–£ ====================
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.style.cssText = `
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid #ff4444;
        border-radius: 10px;
        padding: 15px;
        margin: 20px 0;
        text-align: center;
        color: #ffaaaa;
    `;
    errorDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è –û—à–∏–±–∫–∞</div>
        <div>${message}</div>
    `;
    
    const container = document.querySelector('.players-container');
    if (container.firstChild) {
        container.insertBefore(errorDiv, container.firstChild);
    }
}

// ==================== –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ====================
window.onload = async function() {
    createParticles();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById("loader").style.opacity = "0";
    setTimeout(() => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("content").style.opacity = "1";
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä–æ–∫–æ–≤
        initPlayersPage();
    }, 400);
};
</script>

</body>
</html>
