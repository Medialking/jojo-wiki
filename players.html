<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Игроки сервера | JojoLand</title>
    <!-- Игровой шрифт -->
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ГЛОБАЛЬНЫЕ СТИЛИ ИЗ ВАШЕГО style.css (адаптировано) */
        body {
            background-color: #111122;
            color: #eeeeee;
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* КОНТЕЙНЕР СТРАНИЦЫ */
        .players-container {
            width: 100%;
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        /* ЗАГОЛОВОК СТРАНИЦЫ */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-title {
            color: #ffcc00;
            font-size: clamp(24px, 5vw, 38px);
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .page-subtitle {
            color: #aaaaff;
            font-size: clamp(14px, 3vw, 18px);
            margin-bottom: 30px;
        }
        
        /* ПОИСК И ФИЛЬТРЫ */
        .search-section {
            background: rgba(30, 30, 50, 0.6);
            border: 1px solid #333366;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .search-input-container {
            position: relative;
        }
        
        #playerSearch {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #555599;
            background: #222244;
            color: #ffffff;
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }
        
        #playerSearch:focus {
            border-color: #ffcc00;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background: #444466;
            color: #ffffff;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px #222244;
        }
        
        .filter-btn:hover {
            background: #555588;
            transform: translateY(-2px);
            box-shadow: 0 6px #222244;
        }
        
        .filter-btn.active {
            background: #ffaa00;
            color: #111122;
            font-weight: bold;
            box-shadow: 0 4px #cc8800;
            transform: translateY(0);
        }
        
        /* СПИСОК ИГРОКОВ */
        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .player-card {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid #444477;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            text-decoration: none;
            color: inherit;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4), 0 0 15px rgba(255, 204, 0, 0.2);
            border-color: #ffcc00;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            min-width: 60px;
            border-radius: 50%;
            border: 3px solid #77aaff;
            object-fit: cover;
            box-shadow: 0 0 8px rgba(119, 170, 255, 0.5);
        }

        .player-info {
            flex-grow: 1;
        }

        .player-nickname {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .player-group {
            font-size: 14px;
            color: #ccffcc;
            background: rgba(60, 150, 60, 0.3);
            padding: 2px 8px;
            border-radius: 5px;
            display: inline-block;
        }

        .player-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #111122;
        }

        .status-online {
            background-color: #33ff77; /* Зеленый */
            box-shadow: 0 0 8px #33ff77;
        }

        .status-offline {
            background-color: #ff4444; /* Красный */
            box-shadow: 0 0 8px #ff4444;
        }

        /* ЛОАДЕР */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111122;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s ease;
            z-index: 100;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #ffcc00;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* СООБЩЕНИЯ */
        .message-box {
            background: rgba(255, 204, 0, 0.1);
            border: 1px solid #ffcc00;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #ffdd88;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ffaaaa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* ПАРТЫКЛЫ - Фон */
        #particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
    </style>
</head>
<body>

    <!-- ПАРТЫКЛЫ (Задний фон) -->
    <canvas id="particles"></canvas>
    
    <!-- АНИМАЦИЯ ЗАГРУЗКИ -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <!-- ОСНОВНОЕ СОДЕРЖИМОЕ -->
    <div id="content" style="opacity: 0;">
        <div class="players-container">
            <header class="page-header">
                <h1 class="page-title">Игроки сервера</h1>
                <p class="page-subtitle">Наш список лучших игроков, ранжированных по уровню.</p>
            </header>
            
            <!-- СЕКЦИЯ ПОИСКА И ФИЛЬТРОВ -->
            <section class="search-section">
                <div class="search-input-container">
                    <input type="text" id="playerSearch" placeholder="Найти игрока по нику...">
                </div>
                
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Все (Уровень)</button>
                    <button class="filter-btn" data-filter="VIP">VIP</button>
                    <button class="filter-btn" data-filter="Moderator">Модераторы</button>
                    <button class="filter-btn" data-filter="Admin">Админы</button>
                    <button class="filter-btn" data-filter="online">Онлайн</button>
                </div>
            </section>
            
            <div id="errorMessageContainer"></div>

            <!-- СООБЩЕНИЕ О ЗАГРУЗКЕ (Перемещено за пределы playersList) -->
            <div id="loadingMessage" class="message-box" style="display: block;">Загрузка данных об игроках...</div>

            <!-- СПИСОК ИГРОКОВ -->
            <div id="playersList" class="players-list">
                <!-- Карточки игроков будут вставляться сюда -->
            </div>
            
        </div>
    </div>

    <!-- ==================== СКРИПТЫ ==================== -->
    <script type="module">
        // Импорты Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, where, setLogLevel, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==================== КОНФИГУРАЦИЯ FIREBASE ====================
        setLogLevel('Debug');

        // Глобальные переменные из среды Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Путь к публичной коллекции игроков
        const PLAYERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/players`;

        let allPlayers = []; // Глобальный массив для хранения всех данных игроков
        let currentFilter = 'all';

        // ==================== СТАРТ АВТОРИЗАЦИИ ====================
        function setupAuthAndDataFetching() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log('Пользователь авторизован:', user.uid);
                    // Запускаем слушатель данных только после успешной авторизации
                    fetchPlayers();
                } else {
                    // Если пользователь не авторизован, пытаемся войти
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log('Авторизация выполнена с помощью токена.');
                        } else {
                            await signInAnonymously(auth);
                            console.log('Авторизация выполнена анонимно.');
                        }
                    } catch (error) {
                        console.error('Ошибка Firebase Auth:', error);
                        showError('Не удалось авторизоваться для загрузки данных об игроках.');
                    }
                }
            });
        }
        
        // ==================== ПОЛУЧЕНИЕ ДАННЫХ ИГРОКОВ (В РЕАЛЬНОМ ВРЕМЕНИ) ====================
        async function fetchPlayers() {
            const playersRef = collection(db, PLAYERS_COLLECTION_PATH);
            
            // Создаем запрос: сортируем по уровню (rankLevel) по убыванию
            const q = query(
                playersRef
                // ВАЖНО: orderBy требует индекс, но для простоты демо-примера мы сортируем локально
                // Если нужна серверная сортировка, добавьте ее сюда, но будьте готовы создать индекс.
            );

            // Слушатель в реальном времени
            onSnapshot(q, (snapshot) => {
                const fetchedPlayers = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Добавляем ID документа как userId
                    fetchedPlayers.push({ id: doc.id, ...data });
                });
                
                // Сортировка по rankLevel (уровень), по убыванию, локально
                fetchedPlayers.sort((a, b) => (b.rankLevel || 0) - (a.rankLevel || 0));

                allPlayers = fetchedPlayers;
                console.log('Данные игроков обновлены:', allPlayers.length, 'игроков.');
                
                // Отображаем список с текущим фильтром
                filterAndRenderPlayers();
                
                // Скрываем сообщение о загрузке после получения данных
                const loadingMessageEl = document.getElementById('loadingMessage');
                if (loadingMessageEl) { // Защитная проверка
                    loadingMessageEl.style.display = 'none';
                }

            }, (error) => {
                console.error('Ошибка получения данных об игроках:', error);
                showError('Не удалось загрузить список игроков. Проверьте подключение.');
            });
        }

        // ==================== СОЗДАНИЕ КАРТОЧКИ ИГРОКА ====================
        function createPlayerCard(player) {
            const card = document.createElement('a');
            // Переход на страницу профиля, используя userId
            card.href = `profile.html?view=${player.id}`;
            card.className = 'player-card';

            // Проверка и установка значений по умолчанию
            const nickname = player.nickname || 'Неизвестный игрок';
            const group = player.group || 'Игрок';
            const rankLevel = player.rankLevel !== undefined ? player.rankLevel : 1;
            const avatarUrl = player.avatarUrl && player.avatarUrl.startsWith('http') 
                              ? player.avatarUrl 
                              : `https://placehold.co/60x60/444477/cccccc?text=LVL${rankLevel}`;
            const isOnline = player.isOnline === true;
            
            card.innerHTML = `
                <img src="${avatarUrl}" alt="Аватар ${nickname}" class="player-avatar" 
                     onerror="this.onerror=null;this.src='https://placehold.co/60x60/444477/cccccc?text=LVL${rankLevel}';"
                >
                <div class="player-info">
                    <div class="player-nickname">${nickname}</div>
                    <div class="player-group">${group} (Ур. ${rankLevel})</div>
                </div>
                <div class="player-status ${isOnline ? 'status-online' : 'status-offline'}" title="${isOnline ? 'Онлайн' : 'Офлайн'}"></div>
            `;
            return card;
        }

        // ==================== ФИЛЬТРАЦИЯ И ОТОБРАЖЕНИЕ ====================
        function filterAndRenderPlayers() {
            const listContainer = document.getElementById('playersList');
            const searchInput = document.getElementById('playerSearch').value.toLowerCase().trim();
            listContainer.innerHTML = ''; // Очистка перед рендерингом

            let filteredPlayers = allPlayers;

            // 1. Фильтрация по поиску (никнейм)
            if (searchInput) {
                filteredPlayers = filteredPlayers.filter(p => 
                    (p.nickname || '').toLowerCase().includes(searchInput)
                );
            }

            // 2. Фильтрация по кнопке
            if (currentFilter !== 'all') {
                if (currentFilter === 'online') {
                    filteredPlayers = filteredPlayers.filter(p => p.isOnline === true);
                } else {
                    // Фильтр по группе (VIP, Moderator, Admin)
                    filteredPlayers = filteredPlayers.filter(p => 
                        (p.group || '').toLowerCase() === currentFilter.toLowerCase()
                    );
                }
            }

            // 3. Рендеринг
            if (filteredPlayers.length === 0) {
                listContainer.innerHTML = `<div class="message-box">Игроки по вашему запросу не найдены.</div>`;
            } else {
                filteredPlayers.forEach(player => {
                    listContainer.appendChild(createPlayerCard(player));
                });
            }
        }
        
        // ==================== ОБРАБОТЧИКИ СОБЫТИЙ ====================
        function initializeEvents() {
            // Поиск по нику
            document.getElementById('playerSearch').addEventListener('input', filterAndRenderPlayers);
            
            // Фильтрация по кнопкам
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Обновление активного класса
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Установка нового фильтра и перерисовка
                    currentFilter = btn.dataset.filter;
                    filterAndRenderPlayers();
                });
            });
        }

        // ==================== СООБЩЕНИЯ/ОШИБКИ ====================
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">⚠️ Ошибка</div>
                <div>${message}</div>
            `;
            const container = document.getElementById('errorMessageContainer');
            if (container) {
                container.innerHTML = '';
                container.appendChild(errorDiv);
            }
        }

        // ==================== ФОНОВЫЕ ПАРТЫКЛЫ (ПРОСТАЯ РЕАЛИЗАЦИЯ) ====================
        function createParticles() {
            const canvas = document.getElementById('particles');
            const ctx = canvas.getContext('2d');
            let particles = [];
            const particleCount = 50;

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2 + 1;
                    this.speedX = Math.random() * 0.5 - 0.25;
                    this.speedY = Math.random() * 0.5 - 0.25;
                    this.color = 'rgba(170, 170, 255, 0.5)';
                }
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    if (this.size > 0.2) this.size -= 0.01;
                    
                    if (this.x > canvas.width || this.x < 0) this.speedX = -this.speedX;
                    if (this.y > canvas.height || this.y < 0) this.speedY = -this.speedY;
                }
                draw() {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function init() {
                particles = [];
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle());
                }
            }

            function animate() {
                requestAnimationFrame(animate);
                ctx.fillStyle = 'rgba(17, 17, 34, 0.05)'; // Trail effect
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                for (let i = 0; i < particles.length; i++) {
                    particles[i].update();
                    particles[i].draw();
                }
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            init();
            animate();
        }

        // ==================== ЗАГРУЗКА СТРАНИЦЫ ====================
        window.onload = async function() {
            // Инициализация фоновых партиклов
            createParticles();
            
            // Настраиваем авторизацию и загрузку данных
            setupAuthAndDataFetching();
            
            // Настраиваем обработчики поиска/фильтрации
            initializeEvents();
            
            // Анимация загрузки
            const loaderEl = document.getElementById("loader");
            const contentEl = document.getElementById("content");

            if (loaderEl) loaderEl.style.opacity = "0";
            setTimeout(() => {
                if (loaderEl) loaderEl.style.display = "none";
                if (contentEl) contentEl.style.opacity = "1";
            }, 400);
        };
    </script>
</body>
</html>
