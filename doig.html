<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ö–æ–ª–µ—Å–∞</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { 
            background: #f5f5f5; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #45a049; }
        #debug-output { 
            background: #333; 
            color: #0f0; 
            padding: 15px; 
            border-radius: 5px; 
            margin-top: 15px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            max-height: 400px; 
            overflow-y: auto; 
        }
    </style>
</head>
<body>
    <h1>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ö–æ–ª–µ—Å–∞ –§–æ—Ä—Ç—É–Ω—ã</h1>
    
    <div class="debug-section">
        <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞</h2>
        <button onclick="checkUserData()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="checkFirebaseConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Firebase</button>
        <button onclick="checkTimeManager()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å TimeManager</button>
        <button onclick="checkWheelState()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–ª–µ—Å–∞</button>
        <button onclick="fixUserData()">–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
    
    <div id="debug-output"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
            authDomain: "jojoland-chat.firebasestorage.app",
            databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
            projectId: "jojoland-chat",
            storageBucket: "jojoland-chat.firebasestorage.app",
            messagingSenderId: "602788305122",
            appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        let currentUserId = null;

        function log(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'white';
            output.innerHTML += `<span style="color: ${color}">[${time}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-output').innerHTML = '';
        }

        // –ü–æ–ª—É—á–∏—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getCurrentUserId() {
            const userId = localStorage.getItem('jojoland_userId');
            if (!userId) {
                log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'error');
                return null;
            }
            currentUserId = userId;
            log(`‚úÖ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}`, 'success');
            return userId;
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function checkUserData() {
            clearLog();
            const userId = getCurrentUserId();
            if (!userId) return;

            try {
                log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                const snapshot = await database.ref('holiday_points/' + userId).once('value');
                
                if (!snapshot.exists()) {
                    log('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ holiday_points', 'error');
                    log('‚ö†Ô∏è –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö...', 'warning');
                    return;
                }

                const data = snapshot.val();
                log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', 'success');
                log(JSON.stringify(data, null, 2));
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                const checks = [
                    { field: 'total_points', type: 'number', optional: false },
                    { field: 'wheel_spins', type: 'object', optional: true },
                    { field: 'last_actions', type: 'object', optional: false },
                    { field: 'current_streak', type: 'number', optional: true },
                    { field: 'max_streak', type: 'number', optional: true },
                    { field: 'max_win', type: 'number', optional: true }
                ];

                checks.forEach(check => {
                    if (!check.optional && !data.hasOwnProperty(check.field)) {
                        log(`‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: ${check.field}`, 'error');
                    } else if (data[check.field] && typeof data[check.field] !== check.type) {
                        log(`‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –¥–ª—è ${check.field}: –æ–∂–∏–¥–∞–µ—Ç—Å—è ${check.type}, –ø–æ–ª—É—á–µ–Ω ${typeof data[check.field]}`, 'warning');
                    } else if (data[check.field]) {
                        log(`‚úì ${check.field}: OK (${JSON.stringify(data[check.field])})`, 'success');
                    }
                });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ä–∞—â–µ–Ω–∏—è
                const lastSpin = data.last_actions?.wheel_spin;
                if (lastSpin) {
                    log(`üìÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–∞—â–µ–Ω–∏–µ: ${lastSpin}`, 'info');
                    const lastDate = new Date(lastSpin);
                    const now = new Date();
                    const hoursDiff = (now - lastDate) / (1000 * 60 * 60);
                    log(`‚è∞ –ü—Ä–æ—à–ª–æ —á–∞—Å–æ–≤: ${hoursDiff.toFixed(2)}`, 'info');
                    log(`üîÑ –ú–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å: ${hoursDiff >= 24 ? '–î–ê' : '–ù–ï–¢'}`, hoursDiff >= 24 ? 'success' : 'warning');
                } else {
                    log('‚úÖ –ü–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ –±—ã–ª–æ - –º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å!', 'success');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–∞—â–µ–Ω–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                const today = new Date().toISOString().split('T')[0];
                const todaySpin = data.wheel_spins?.[today];
                if (todaySpin) {
                    log(`üé° –°–µ–≥–æ–¥–Ω—è —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏: ${JSON.stringify(todaySpin)}`, 'warning');
                } else {
                    log('‚úÖ –°–µ–≥–æ–¥–Ω—è –µ—â–µ –Ω–µ –∫—Ä—É—Ç–∏–ª–∏', 'success');
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Firebase
        async function checkFirebaseConnection() {
            clearLog();
            log('üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase...');
            
            try {
                const ref = database.ref('.info/connected');
                ref.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Firebase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                    } else {
                        log('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase', 'error');
                    }
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                const testRef = database.ref('.info/serverTimeOffset');
                const timeSnapshot = await testRef.once('value');
                const offset = timeSnapshot.val();
                log(`‚è∞ –°–º–µ—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Ä–≤–µ—Ä–∞: ${offset} –º—Å`, 'info');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TimeManager
        async function checkTimeManager() {
            clearLog();
            log('‚è∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ TimeManager...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ TimeManager
                if (typeof TimeManager === 'undefined') {
                    log('‚ùå TimeManager –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                    return;
                }
                
                log('‚úÖ TimeManager –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º—è
                const serverTime = await TimeManager.syncWithServer();
                log(`‚è∞ –°–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${new Date(serverTime).toLocaleString()}`, 'info');
                log(`üìÖ –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –∫–ª—é—á: ${TimeManager.getTodayKey()}`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π
                const testDate = new Date(TimeManager.getCurrentTime() - 25 * 60 * 60 * 1000).toISOString();
                log(`üîÑ canPerformAction (25 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥): ${TimeManager.canPerformAction(testDate)}`, 'info');
                log(`‚è±Ô∏è getTimeToNextAction (25 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥): ${TimeManager.formatTime(TimeManager.getTimeToNextAction(testDate))}`, 'info');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ TimeManager: ${error.message}`, 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–ª–µ—Å–∞
        async function checkWheelState() {
            clearLog();
            const userId = getCurrentUserId();
            if (!userId) return;

            log('üé° –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–ª–µ—Å–∞...');
            
            try {
                const snapshot = await database.ref('holiday_points/' + userId).once('value');
                if (!snapshot.exists()) {
                    log('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                    return;
                }

                const data = snapshot.val();
                
                // –≠–º—É–ª–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ wheel.js
                function canSpinWheel(wheelData) {
                    const lastSpinTime = wheelData?.last_actions?.wheel_spin;
                    const todayKey = new Date().toISOString().split('T')[0];
                    const hasToday = wheelData?.wheel_spins && wheelData.wheel_spins[todayKey];
                    
                    let canByTime = true;
                    if (lastSpinTime) {
                        const lastTime = new Date(lastSpinTime).getTime();
                        const now = Date.now();
                        const hoursSinceLast = (now - lastTime) / (1000 * 60 * 60);
                        canByTime = hoursSinceLast >= 24;
                        log(`‚è∞ –ß–∞—Å–æ–≤ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ä–∞—â–µ–Ω–∏—è: ${hoursSinceLast.toFixed(2)}`, 'info');
                    }
                    
                    log(`üìÖ –í—Ä–∞—â–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è: ${hasToday ? '–î–ê' : '–ù–ï–¢'}`, hasToday ? 'warning' : 'success');
                    log(`üîÑ –ú–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏: ${canByTime ? '–î–ê' : '–ù–ï–¢'}`, canByTime ? 'success' : 'warning');
                    
                    return canByTime && !hasToday;
                }

                const canSpin = canSpinWheel(data);
                log(`üé° –ò—Ç–æ–≥: ${canSpin ? '–ú–û–ñ–ù–û –∫—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ' : '–ù–ï–õ–¨–ó–Ø –∫—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ'}`, 
                    canSpin ? 'success' : 'error');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function fixUserData() {
            clearLog();
            const userId = getCurrentUserId();
            if (!userId) return;

            log('üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...', 'warning');
            
            const confirmFix = confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?');
            if (!confirmFix) {
                log('‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'error');
                return;
            }

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                const snapshot = await database.ref('holiday_points/' + userId).once('value');
                const currentData = snapshot.exists() ? snapshot.val() : {};
                
                // –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                const fixedData = {
                    total_points: currentData.total_points || 0,
                    available_points: currentData.available_points || 0,
                    spent_points: currentData.spent_points || 0,
                    daily_gifts: currentData.daily_gifts || {},
                    wheel_spins: currentData.wheel_spins || {},
                    rewards_history: currentData.rewards_history || [],
                    last_actions: {
                        daily_gift: currentData.last_actions?.daily_gift || null,
                        wheel_spin: currentData.last_actions?.wheel_spin || null
                    },
                    current_streak: currentData.current_streak || 0,
                    max_streak: currentData.max_streak || 0,
                    max_win: currentData.max_win || 0
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                await database.ref('holiday_points/' + userId).set(fixedData);
                
                log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!', 'success');
                log(JSON.stringify(fixedData, null, 2));
                
                // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    if (confirm('–î–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–ª–µ—Å–∞?')) {
                        window.location.href = 'wheel.html';
                    }
                }, 1000);

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('üöÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.', 'info');
            getCurrentUserId();
        };
    </script>
</body>
</html>
