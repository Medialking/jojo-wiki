<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ JojoLand</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <script src="admin_auth.js"></script>
    <script src="admin_common.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a2a, #1a1a4a, #0a0a2a);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è (–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ —á–µ—Ä–µ–∑ admin_nav.html) */
        .admin-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,0,255,0.3);
        }
        
        .admin-nav a {
            padding: 10px 20px;
            background: rgba(0,100,255,0.2);
            color: #6ab7ff;
            text-decoration: none;
            border-radius: 25px;
            border: 1px solid rgba(0,100,255,0.4);
            transition: 0.3s;
            font-weight: bold;
        }
        
        .admin-nav a:hover {
            background: rgba(0,100,255,0.4);
            transform: translateY(-2px);
        }
        
        /* –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
        .admin-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
        }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            background: rgba(0,0,0,0.6);
            border-radius: 25px;
            padding: 25px;
            border: 2px solid #0066ff;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .admin-info {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .admin-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #0066ff;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #0066ff, #00ccff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #00ccff;
        }
        
        /* –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ */
        .filter-panel {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            border: 1px solid #333;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(0,100,255,0.2);
            color: #6ab7ff;
            cursor: pointer;
            transition: 0.3s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: #0066ff;
            color: white;
        }
        
        .filter-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .search-box button {
            padding: 12px 20px;
            background: #ff00ff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .search-box button:hover {
            background: #cc00cc;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤) */
        .main-content {
            /* flex-grow: 1; */
        }
        
        .ticket-item {
            background: rgba(0,0,0,0.6);
            border-left: 5px solid #00ccff;
            transition: 0.3s;
            cursor: pointer;
        }
        
        .ticket-item:hover {
            background: rgba(0,0,0,0.8);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        
        .status-new { border-left-color: #ff00ff; }
        .status-read { border-left-color: #ff9900; }
        .status-answered { border-left-color: #00ff99; }
        .status-closed { border-left-color: #666; }

        .admin-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .status-new { background: rgba(255,0,255,0.2); color: #ff00ff; }
        .status-read { background: rgba(255,153,0,0.2); color: #ff9900; }
        .status-answered { background: rgba(0,255,153,0.2); color: #00ff99; }
        .status-closed { background: rgba(100,100,100,0.2); color: #aaa; }

        /* –î–µ—Ç–∞–ª–∏ —Ç–∏–∫–µ—Ç–∞ */
        .ticket-detail {
            position: fixed;
            top: 0;
            right: -500px; /* –°–∫—Ä—ã—Ç–æ —Å–ø—Ä–∞–≤–∞ */
            width: 480px;
            height: 100%;
            background: #1a1a4a;
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            z-index: 100;
            transition: right 0.4s ease-out;
            padding: 25px;
            overflow-y: auto;
            border-left: 3px solid #00ccff;
        }
        
        .ticket-detail.show {
            right: 0;
        }
        
        .detail-header h2 {
            color: #ffcc00;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        
        .detail-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .detail-item strong {
            color: #6ab7ff;
            display: block;
            margin-bottom: 5px;
        }
        
        .message-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .message-item {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sender-name {
            font-weight: bold;
            color: #00ff99;
        }
        
        .sender-name.admin {
            color: #ffcc00;
        }
        
        .message-text {
            color: white;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ */
        .response-form {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .response-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #0066ff;
            border-radius: 8px;
            color: white;
            resize: vertical;
        }
        
        .response-form button {
            padding: 10px 20px;
            background: #00ff99;
            color: #1a1a4a;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .response-form button:hover {
            background: #00cc66;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
        .close-btn {
            position: sticky;
            top: 0;
            right: 0;
            background: #ff3333;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 0 0 0 15px;
            cursor: pointer;
            font-weight: bold;
            float: right;
            z-index: 101;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.5);
        }
        
        .ticket-timer {
            font-size: 10px;
            background: #ffcc00;
            color: black;
            padding: 2px 6px;
            border-radius: 5px;
            margin-left: 10px;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loader {
            text-align: center;
            padding: 50px;
            color: #00ccff;
        }
        
        .loader i {
            font-size: 30px;
            animation: spin 1s linear infinite;
        }
        
        .error-message { color: #ff3333; margin-top: 10px; font-size: 14px; min-height: 20px; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes modalAppear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-nav" id="admin-nav">
             <p style="color: red;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏ admin_nav.html –∏ admin_common.js!</p>
        </div>
        
        <h1 style="color: #00ccff; margin-bottom: 20px;">üõ°Ô∏è –ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h1>
        
        <div class="admin-container">
            <div class="sidebar">
                <div class="admin-info">
                    <div class="admin-avatar">A</div>
                    <h3 id="adminNameDisplay">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h3>
                </div>
                
                <h4 style="color: #6ab7ff; margin-bottom: 10px;">–§–∏–ª—å—Ç—Ä—ã</h4>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterTickets('all')">
                        üåç –í—Å–µ <span class="filter-count" id="countAll">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('new')">
                        üÜï –ù–æ–≤—ã–µ <span class="filter-count" id="countNew">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('answered')">
                        üì® –° –æ—Ç–≤–µ—Ç–æ–º <span class="filter-count" id="countAnswered">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('complaint')">
                        ‚ö†Ô∏è –ñ–∞–ª–æ–±—ã <span class="filter-count" id="countComplaints">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('appeal')">
                        ‚öñÔ∏è –ê–ø–µ–ª–ª—è—Ü–∏–∏ <span class="filter-count" id="countAppeals">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTickets('support')">
                        üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ <span class="filter-count" id="countSupport">0</span>
                    </button>
                </div>
                
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID, –Ω–∏–∫–Ω–µ–π–º—É –∏–ª–∏ —Ç–µ–∫—Å—Ç—É">
                    <button onclick="searchTickets()">üîç</button>
                </div>
            </div>
            
            <div class="main-content">
                <div id="ticketsList">
                    <div class="loader" id="initialLoader">
                        <i class="fas fa-spinner"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="ticket-detail" id="ticketDetail">
        <button class="close-btn" onclick="closeTicketDetail()">X</button>
        <div class="detail-header">
            <h2 id="detailTitle">–û–±—Ä–∞—â–µ–Ω–∏–µ #ID</h2>
            <span class="admin-badge" id="detailStatus">–°—Ç–∞—Ç—É—Å</span>
        </div>
        
        <div id="detailContent">
            </div>

        <div class="response-form">
            <h3 style="color: #00ccff; margin-bottom: 15px;">–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h3>
            <textarea id="responseMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..."></textarea>
            <div style="display: flex; justify-content: space-between; gap: 10px;">
                <button onclick="submitResponse()" style="flex: 1; background: #00ff99;">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                <button onclick="closeTicket()" style="flex: 1; background: #ff9900;">‚úÖ –ó–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
            </div>
            <p class="error-message" id="responseError"></p>
        </div>
        
        <div class="message-container" id="messageContainer">
            </div>
    </div>

    
    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let allTickets = [];
        let filteredTickets = [];
        let currentFilter = 'all';
        let currentAdmin = {};
        let selectedTicketId = null;
        let selectedTicketData = null;
        const AUTO_DELETE_DELAY = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (–¥–ª—è —Ç–∞–π–º–µ—Ä–∞)

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
        async function checkAuth() {
            initFirebase();
            const auth = await checkAdminAuth();
            
            if (!auth.success) {
                // redirectToLogin(); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç admin_auth.js
                return;
            }
            
            currentAdmin = auth;
            document.getElementById('adminNameDisplay').textContent = auth.adminName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            
            loadTickets();
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –û–ë–†–ê–©–ï–ù–ò–ô ====================
        async function loadTickets() {
            try {
                document.getElementById('initialLoader').style.display = 'block';
                const snapshot = await database.ref('support_tickets').once('value');
                const data = snapshot.val();
                
                allTickets = [];
                if (data) {
                    allTickets = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤
                allTickets.forEach(ticket => checkAndDeleteOldTicket(ticket));
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É) –∏ –≤—Ä–µ–º–µ–Ω–∏
                allTickets.sort((a, b) => {
                    if (a.status === 'new' && b.status !== 'new') return -1;
                    if (a.status !== 'new' && b.status === 'new') return 1;
                    return b.timestamp - a.timestamp;
                });
                
                filterTickets(currentFilter);
                document.getElementById('initialLoader').style.display = 'none';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–∫–µ—Ç—ã, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
                const newTicket = allTickets.find(t => t.status === 'new');
                if (newTicket) {
                    selectTicket(newTicket.id);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π:', error);
                showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è', 'error');
            }
        }
        
        async function checkAndDeleteOldTicket(ticket) {
             // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è ...
        }

        // ==================== –§–ò–õ–¨–¢–†–´ –ò –ü–û–ò–°–ö ====================
        function filterTickets(filterType) {
            currentFilter = filterType;
            
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (filterType !== 'all') {
                const btn = document.querySelector(`.filter-btn[onclick="filterTickets('${filterType}')"]`);
                if (btn) btn.classList.add('active');
            } else {
                document.querySelector('.filter-btn[onclick="filterTickets(\'all\')"]').classList.add('active');
            }

            if (filterType === 'all') {
                filteredTickets = allTickets;
            } else if (['new', 'read', 'answered', 'closed'].includes(filterType)) {
                filteredTickets = allTickets.filter(t => t.status === filterType);
            } else if (['complaint', 'appeal', 'support'].includes(filterType)) {
                filteredTickets = allTickets.filter(t => t.type === filterType);
            } else {
                filteredTickets = allTickets;
            }
            
            updateTicketsList();
        }
        
        function updateFilterCounts() {
            const counts = {
                all: allTickets.length,
                new: allTickets.filter(t => t.status === 'new').length,
                read: allTickets.filter(t => t.status === 'read').length,
                answered: allTickets.filter(t => t.status === 'answered').length,
                complaint: allTickets.filter(t => t.type === 'complaint').length,
                appeal: allTickets.filter(t => t.type === 'appeal').length,
                support: allTickets.filter(t => t.type === 'support').length
            };
            
            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countNew').textContent = counts.new;
            document.getElementById('countAnswered').textContent = counts.answered;
            document.getElementById('countComplaints').textContent = counts.complaint;
            document.getElementById('countAppeals').textContent = counts.appeal;
            document.getElementById('countSupport').textContent = counts.support;
        }

        // ==================== –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –°–ü–ò–°–ö–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) ====================
        function updateTicketsList() {
            updateFilterCounts();
            
            const ticketsList = document.getElementById('ticketsList');
            if (filteredTickets.length === 0) {
                 ticketsList.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #aaa;">
                        üîç –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞.
                    </div>
                `;
                return;
            }
            
            const html = filteredTickets.map(ticket => {
                const typeText = ticket.type === 'complaint' ? '‚ö†Ô∏è –ñ–∞–ª–æ–±–∞' : 
                                 ticket.type === 'appeal' ? '‚öñÔ∏è –ê–ø–µ–ª–ª—è—Ü–∏—è' : 
                                 'üí¨ –í–æ–ø—Ä–æ—Å';
                
                const statusText = ticket.status === 'new' ? 'üÜï –ù–æ–≤–æ–µ' : 
                                   ticket.status === 'read' ? 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ' : 
                                   ticket.status === 'answered' ? 'üì® –° –æ—Ç–≤–µ—Ç–æ–º' : 
                                   '‚úÖ –ó–∞–∫—Ä—ã—Ç–æ';
                                   
                const statusClass = ticket.status === 'new' ? 'status-new' : 
                                    ticket.status === 'read' ? 'status-read' : 
                                    ticket.status === 'answered' ? 'status-answered' : 
                                    'status-closed';

                // --- –ù–û–í–´–ï –ü–û–õ–Ø ---
                const targetNickname = ticket.targetNickname || 'N/A';
                const submitterName = ticket.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ (ID: ' + ticket.userId.substr(0, 8) + ')';
                // ------------------

                let timerHtml = '';
                if (ticket.status === 'answered' && ticket.answerTime) {
                    const answerTime = new Date(ticket.answerTime).getTime();
                    const timeLeft = AUTO_DELETE_DELAY - (Date.now() - answerTime);
                    if (timeLeft > 0) {
                        const minutes = Math.floor(timeLeft / 60000);
                        const seconds = Math.floor((timeLeft % 60000) / 1000);
                        timerHtml = `<span class="ticket-timer">üóëÔ∏è ${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
                    }
                }
                
                return `
                    <div class="admin-card ticket-item ${statusClass}" data-id="${ticket.id}" onclick="selectTicket('${ticket.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #6ab7ff;">${typeText} #${ticket.id.substr(0, 8)}</h3>
                            <span class="admin-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        <p style="margin-bottom: 10px; color: #ccc; font-size: 14px;">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: <a href="admin_users.html?search=${ticket.userId}" style="color: #6ab7ff; font-weight: bold;">${submitterName}</a>
                        </p>
                        
                        ${ticket.type !== 'support' ? 
                            `<p style="color: #ff9900; font-size: 14px; margin-bottom: 15px;">
                                **–¶–µ–ª—å:** <span style="color: #ffcc99; font-weight: bold;">${targetNickname}</span>
                            </p>` 
                        : ''}
                        
                        <h4 style="color: #ccccff; margin-bottom: 8px;">–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                        <p style="font-size: 14px; margin-bottom: 10px; white-space: pre-wrap;">
                            ${truncateText(ticket.description, 150)}
                        </p>
                        
                        <div style="text-align: right; margin-top: 15px; font-size: 12px; color: #aaa;">
                            ${formatDate(ticket.timestamp)} ${timerHtml}
                        </div>
                    </div>
                `;
            }).join('');

            ticketsList.innerHTML = html;
        }

        // ==================== –î–ï–¢–ê–õ–ò –¢–ò–ö–ï–¢–ê ====================
        async function selectTicket(ticketId) {
            selectedTicketId = ticketId;
            selectedTicketData = allTickets.find(t => t.id === ticketId);
            
            if (!selectedTicketData) return;
            
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "new", –º–µ–Ω—è–µ–º –Ω–∞ "read"
            if (selectedTicketData.status === 'new') {
                await database.ref(`support_tickets/${ticketId}/status`).set('read');
                selectedTicketData.status = 'read';
                loadTickets(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å
            document.getElementById('detailTitle').textContent = `${selectedTicketData.type === 'complaint' ? '–ñ–∞–ª–æ–±–∞' : selectedTicketData.type === 'appeal' ? '–ê–ø–µ–ª–ª—è—Ü–∏—è' : '–í–æ–ø—Ä–æ—Å'} #${ticketId.substr(0, 8)}`;
            
            const statusText = selectedTicketData.status === 'new' ? 'üÜï –ù–æ–≤–æ–µ' : 
                               selectedTicketData.status === 'read' ? 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ' : 
                               selectedTicketData.status === 'answered' ? 'üì® –° –æ—Ç–≤–µ—Ç–æ–º' : 
                               '‚úÖ –ó–∞–∫—Ä—ã—Ç–æ';
            document.getElementById('detailStatus').textContent = statusText;
            document.getElementById('detailStatus').className = `admin-badge status-${selectedTicketData.status}`;

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏
            let detailHtml = `
                <div class="detail-item">
                    <strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> 
                    <a href="admin_users.html?search=${selectedTicketData.userId}" style="color: #00ccff; font-weight: bold;">
                        ${selectedTicketData.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} (ID: ${selectedTicketData.userId.substr(0, 8)})
                    </a>
                </div>
                ${selectedTicketData.type !== 'support' ? `
                    <div class="detail-item" style="border-left: 3px solid #ff9900;">
                        <strong>–¶–µ–ª—å:</strong> <span style="color: #ffcc99; font-weight: bold;">${selectedTicketData.targetNickname || 'N/A'}</span>
                    </div>` : ''}
                <div class="detail-item">
                    <strong>–¢–∏–ø:</strong> ${selectedTicketData.type}
                </div>
                <div class="detail-item">
                    <strong>–î–∞—Ç–∞:</strong> ${formatDate(selectedTicketData.timestamp)}
                </div>
                <div class="detail-item">
                    <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <div style="white-space: pre-wrap;">${selectedTicketData.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                </div>
                <div class="detail-item">
                    <strong>–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞/–ü—Ä–∏—á–∏–Ω–∞:</strong> 
                    <div style="font-size: 14px; color: #b3b3ff; white-space: pre-wrap;">
                        ${formatLinks(selectedTicketData.reason)}
                    </div>
                </div>
            `;
            document.getElementById('detailContent').innerHTML = detailHtml;
            
            loadMessages(selectedTicketData.answers || {});
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
            document.getElementById('ticketDetail').classList.add('show');
        }

        function closeTicketDetail() {
            document.getElementById('ticketDetail').classList.remove('show');
            selectedTicketId = null;
            selectedTicketData = null;
        }

        // ==================== –°–û–û–ë–©–ï–ù–ò–Ø ====================
        function loadMessages(answers) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = '<h4>–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–æ–≤:</h4>';
            
            if (!answers || Object.keys(answers).length === 0) {
                messageContainer.innerHTML += '<p style="color: #aaa;">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç–∞.</p>';
                return;
            }
            
            const messages = Object.keys(answers).map(key => ({
                id: key,
                ...answers[key]
            }));
            
            messages.sort((a, b) => a.timestamp - b.timestamp);
            
            messages.forEach(msg => {
                const isSystem = msg.senderId !== selectedTicketData.userId; // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ —Å–∏—Å—Ç–µ–º–∞
                const senderName = isSystem ? (msg.adminName || '–ê–¥–º–∏–Ω') : (selectedTicketData.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
                const nameClass = isSystem ? 'admin' : '';
                
                const html = `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="sender-name ${nameClass}">${senderName}</span>
                            <small style="color: #aaa;">${formatDate(msg.timestamp)}</small>
                        </div>
                        <p class="message-text">${escapeHtml(msg.text)}</p>
                    </div>
                `;
                messageContainer.innerHTML += html;
            });
        }
        
        async function submitResponse() {
            const message = document.getElementById('responseMessage').value.trim();
            const errorElement = document.getElementById('responseError');
            errorElement.textContent = '';
            
            if (!message) {
                errorElement.textContent = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.';
                return;
            }
            if (!selectedTicketId) return;
            
            try {
                const adminName = currentAdmin.adminName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                const adminId = localStorage.getItem('jojoland_userId');

                const responseData = {
                    text: message,
                    senderId: adminId, // ID –∞–¥–º–∏–Ω–∞
                    adminName: adminName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                await database.ref(`support_tickets/${selectedTicketId}/answers`).push(responseData);
                await database.ref(`support_tickets/${selectedTicketId}/status`).set('answered');
                await database.ref(`support_tickets/${selectedTicketId}/answerTime`).set(Date.now());

                document.getElementById('responseMessage').value = '';
                
                showMessage('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
                // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                await logAction('answer', `–û—Ç–≤–µ—Ç–∏–ª –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ ${selectedTicketId.substr(0, 8)}`);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Ç–∏–∫–µ—Ç–∞ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                loadTickets();
                selectTicket(selectedTicketId); 
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                errorElement.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∞–≤–∞.';
            }
        }
        
        async function closeTicket() {
            if (!selectedTicketId) return;

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ #${selectedTicketId.substr(0, 8)}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–≤–µ–¥–æ–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.`)) {
                return;
            }
            
            try {
                await database.ref(`support_tickets/${selectedTicketId}/status`).set('closed');
                await database.ref(`support_tickets/${selectedTicketId}/closedBy`).set(currentAdmin.name || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
                await database.ref(`support_tickets/${selectedTicketId}/closedTime`).set(Date.now());
                
                await logAction('close', `–ó–∞–∫—Ä—ã–ª –æ–±—Ä–∞—â–µ–Ω–∏–µ ${selectedTicketId.substr(0, 8)}`);
                
                showMessage('–û–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'success');
                loadTickets();
                closeTicketDetail();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–∏–∫–µ—Ç–∞:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–∏–∫–µ—Ç–∞', 'error');
            }
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function logAction(action, description) {
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ admin_common.js
            try {
                const adminId = localStorage.getItem('jojoland_userId');
                database.ref('admin_actions').push({
                    action: action,
                    description: description,
                    adminName: currentAdmin.adminName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    timestamp: Date.now(),
                    adminId: adminId
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            }
        }

        function searchTickets() {
            const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchText) {
                filterTickets(currentFilter);
                return;
            }
            
            filteredTickets = allTickets.filter(ticket => {
                return (
                    (ticket.id && ticket.id.toLowerCase().includes(searchText)) ||
                    (ticket.userId && ticket.userId.toLowerCase().includes(searchText)) ||
                    (ticket.username && ticket.username.toLowerCase().includes(searchText)) || // –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                    (ticket.targetNickname && ticket.targetNickname.toLowerCase().includes(searchText)) || // –ü–æ–∏—Å–∫ –ø–æ —Ü–µ–ª–∏
                    (ticket.description && ticket.description.toLowerCase().includes(searchText)) ||
                    (ticket.reason && ticket.reason.toLowerCase().includes(searchText))
                );
            });
            
            const ticketsList = document.getElementById('ticketsList');
            
            if (filteredTickets.length === 0) {
                ticketsList.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #aaa;">
                        üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${searchText}"
                    </div>
                `;
                return;
            }
            
            updateTicketsList();
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength) + '...';
        }
        
        function formatLinks(text) {
            if (!text) return '–ù–µ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => {
                return `<a href="${url}" target="_blank" style="color: #6ab7ff;">${url}</a>`;
            }).replace(/\n/g, '<br>');
        }
        
        function showMessage(message, type = 'info') {
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ createNotification –∏–∑ admin_common.js
            alert(`[${type.toUpperCase()}] ${message}`);
        }
        
        function escapeHtml(text) {
             // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤ admin_common.js
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, (m) => map[m]);
        }

        // ==================== –ó–ê–ü–£–°–ö ====================
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
