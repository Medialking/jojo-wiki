<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ JojoLand</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- –ï–¥–∏–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <script src="admin_auth.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a2a, #1a1a4a, #0a0a2a);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .admin-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,0,255,0.3);
        }
        
        .admin-nav a {
            padding: 10px 20px;
            background: rgba(0,100,255,0.2);
            color: #6ab7ff;
            text-decoration: none;
            border-radius: 25px;
            border: 1px solid rgba(0,100,255,0.4);
            transition: 0.3s;
            font-weight: bold;
        }
        
        .admin-nav a:hover {
            background: rgba(0,100,255,0.4);
            transform: translateY(-2px);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.6);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #0066ff;
            transition: 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,100,255,0.3);
        }
        
        .stat-card h3 {
            color: #6ab7ff;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #aaa;
            font-size: 14px;
        }
        
        .stat-trend {
            font-size: 14px;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .trend-up { background: rgba(0,255,0,0.1); color: #00ff00; }
        .trend-down { background: rgba(255,0,0,0.1); color: #ff0000; }
        .trend-neutral { background: rgba(255,255,0,0.1); color: #ffff00; }
        
        /* –ì—Ä–∞—Ñ–∏–∫–∏ */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(0,0,0,0.6);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #0066ff;
        }
        
        .chart-card h3 {
            color: #6ab7ff;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .tables-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }
        
        .table-card {
            background: rgba(0,0,0,0.6);
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #0066ff;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-card h3 {
            color: #6ab7ff;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: sticky;
            top: 0;
            background: rgba(0,0,0,0.9);
            padding-bottom: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: rgba(0,100,255,0.2);
            color: #6ab7ff;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 50px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #ccccff;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: 0.3s;
            font-weight: bold;
        }
        
        .filter-btn.active {
            background: rgba(0,100,255,0.4);
            border: 1px solid #0066ff;
        }
        
        .filter-btn:hover {
            background: rgba(0,100,255,0.3);
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ */
        .loading {
            text-align: center;
            padding: 50px;
            color: #aaa;
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stat-card, .chart-card, .table-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="admin-nav">
            <a href="admin_main.html">üè† –ì–ª–∞–≤–Ω–∞—è –∞–¥–º–∏–Ω–∫–∏</a>
            <a href="admin_support.html">üõ°Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
            <a href="admin_users.html">üë• –ò–≥—Ä–æ–∫–∏</a>
            <a href="admin_stats.html" style="background: rgba(0,100,255,0.4);">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="admin_logs.html">üìã –õ–æ–≥–∏</a>
            <button onclick="logout()" style="margin-left: auto; padding: 10px 20px; background: rgba(255,0,0,0.2); color: #ff6666; border: 1px solid #ff6666; border-radius: 25px; cursor: pointer;">
                üö™ –í—ã–π—Ç–∏
            </button>
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="filters">
            <button class="filter-btn active" onclick="filterStats('today')">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="filter-btn" onclick="filterStats('week')">–ù–µ–¥–µ–ª—è</button>
            <button class="filter-btn" onclick="filterStats('month')">–ú–µ—Å—è—Ü</button>
            <button class="filter-btn" onclick="filterStats('all')">–í—Å—ë –≤—Ä–µ–º—è</button>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-container">
            <div class="stat-card">
                <h3>üìà –í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π</h3>
                <div class="stat-number" id="totalRequests">0</div>
                <div class="stat-label">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
                <div class="stat-trend" id="totalTrend">+0%</div>
            </div>
            
            <div class="stat-card">
                <h3>‚ö†Ô∏è –ñ–∞–ª–æ–±—ã</h3>
                <div class="stat-number" id="complaintsCount">0</div>
                <div class="stat-label">–ù–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è</div>
                <div class="stat-trend" id="complaintsTrend">+0%</div>
            </div>
            
            <div class="stat-card">
                <h3>‚öñÔ∏è –ê–ø–µ–ª–ª—è—Ü–∏–∏</h3>
                <div class="stat-number" id="appealsCount">0</div>
                <div class="stat-label">–ù–∞ –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–π</div>
                <div class="stat-trend" id="appealsTrend">+0%</div>
            </div>
            
            <div class="stat-card">
                <h3>üí¨ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
                <div class="stat-number" id="supportCount">0</div>
                <div class="stat-label">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã</div>
                <div class="stat-trend" id="supportTrend">+0%</div>
            </div>
            
            <div class="stat-card">
                <h3>‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</h3>
                <div class="stat-number" id="avgResponseTime">0—á</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è</div>
                <div class="stat-trend" id="responseTrend">+0%</div>
            </div>
            
            <div class="stat-card">
                <h3>‚úÖ –ü—Ä–æ—Ü–µ–Ω—Ç —Ä–µ—à—ë–Ω–Ω—ã—Ö</h3>
                <div class="stat-number" id="solvedPercent">0%</div>
                <div class="stat-label">–û–±—Ä–∞—â–µ–Ω–∏–π —Å –æ—Ç–≤–µ—Ç–æ–º</div>
                <div class="stat-trend" id="solvedTrend">+0%</div>
            </div>
        </div>
        
        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>üìä –û–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º</h3>
                <canvas id="requestsChart"></canvas>
            </div>
            
            <div class="chart-card">
                <h3>üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</h3>
                <canvas id="typesChart"></canvas>
            </div>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü—ã -->
        <div class="tables-container">
            <div class="table-card">
                <h3>üë• –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä–æ–∫–∏</h3>
                <table id="activeUsers">
                    <thead>
                        <tr>
                            <th>–ò–≥—Ä–æ–∫</th>
                            <th>–û–±—Ä–∞—â–µ–Ω–∏–π</th>
                            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="table-card">
                <h3>üëë –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–¥–º–∏–Ω–æ–≤</h3>
                <table id="adminActivity">
                    <thead>
                        <tr>
                            <th>–ê–¥–º–∏–Ω</th>
                            <th>–û—Ç–≤–µ—Ç–æ–≤</th>
                            <th>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="table-card">
                <h3>üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
                <table id="recentTickets">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–¢–∏–ø</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–í—Ä–µ–º—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE –ö–û–ù–§–ò–ì ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBwhNixWO8dF_drN2hHVYzfTAbMCiT91Gw",
            authDomain: "jojoland-chat.firebaseapp.com",
            databaseURL: "https://jojoland-chat-default-rtdb.firebaseio.com",
            projectId: "jojoland-chat",
            storageBucket: "jojoland-chat.firebasestorage.app",
            messagingSenderId: "602788305122",
            appId: "1:602788305122:web:c03f5b5ef59c85fc9fe6bb"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentFilter = 'today';
        let allTickets = [];
        let charts = {};
        
        // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
        async function checkAuth() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É
                const auth = await checkAdminAuth();
                
                if (!auth.success) {
                    // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∞–¥–º–∏–Ω–∫–∏
                    window.location.href = 'admin_main.html';
                    return;
                }
                
                // –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                initStats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                window.location.href = 'admin_main.html';
            }
        }
        
        function logout() {
            adminLogout();
            window.location.href = '../index.html';
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====================
        async function initStats() {
            try {
                await loadAllTickets();
                updateStats();
                createCharts();
                updateTables();
                
                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                setInterval(async () => {
                    await loadAllTickets();
                    updateStats();
                    updateCharts();
                    updateTables();
                }, 30000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            }
        }
        
        async function loadAllTickets() {
            try {
                const snapshot = await database.ref('support_tickets')
                    .orderByChild('timestamp')
                    .once('value');
                
                allTickets = [];
                
                if (!snapshot.exists()) {
                    return;
                }
                
                snapshot.forEach(childSnapshot => {
                    const ticket = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    allTickets.push(ticket);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤:', error);
            }
        }
        
        // ==================== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø ====================
        function filterStats(filter) {
            currentFilter = filter;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateStats();
            updateCharts();
            updateTables();
        }
        
        function getFilteredTickets() {
            const now = Date.now();
            let startTime = 0;
            
            switch (currentFilter) {
                case 'today':
                    startTime = now - (24 * 60 * 60 * 1000);
                    break;
                case 'week':
                    startTime = now - (7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startTime = now - (30 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                    startTime = 0;
                    break;
            }
            
            return allTickets.filter(ticket => ticket.timestamp >= startTime);
        }
        
        // ==================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
        function updateStats() {
            const tickets = getFilteredTickets();
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const total = tickets.length;
            const complaints = tickets.filter(t => t.type === 'complaint').length;
            const appeals = tickets.filter(t => t.type === 'appeal').length;
            const support = tickets.filter(t => t.type === 'support').length;
            
            // –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
            const answeredTickets = tickets.filter(t => t.answerTime);
            let totalResponseTime = 0;
            answeredTickets.forEach(t => {
                totalResponseTime += (t.answerTime - t.timestamp);
            });
            const avgResponseTime = answeredTickets.length > 0 
                ? Math.floor(totalResponseTime / answeredTickets.length / (1000 * 60 * 60)) + '—á'
                : '0—á';
            
            // –ü—Ä–æ—Ü–µ–Ω—Ç —Ä–µ—à—ë–Ω–Ω—ã—Ö
            const solvedPercent = total > 0 
                ? Math.round((answeredTickets.length / total) * 100) + '%'
                : '0%';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('totalRequests').textContent = total;
            document.getElementById('complaintsCount').textContent = complaints;
            document.getElementById('appealsCount').textContent = appeals;
            document.getElementById('supportCount').textContent = support;
            document.getElementById('avgResponseTime').textContent = avgResponseTime;
            document.getElementById('solvedPercent').textContent = solvedPercent;
            
            // –¢—Ä–µ–Ω–¥—ã (–ø—Ä–æ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
            document.getElementById('totalTrend').textContent = '+12%';
            document.getElementById('totalTrend').className = 'stat-trend trend-up';
            
            document.getElementById('complaintsTrend').textContent = '+5%';
            document.getElementById('complaintsTrend').className = 'stat-trend trend-up';
            
            document.getElementById('appealsTrend').textContent = '-3%';
            document.getElementById('appealsTrend').className = 'stat-trend trend-down';
            
            document.getElementById('supportTrend').textContent = '+8%';
            document.getElementById('supportTrend').className = 'stat-trend trend-up';
            
            document.getElementById('responseTrend').textContent = '-15%';
            document.getElementById('responseTrend').className = 'stat-trend trend-up';
            
            document.getElementById('solvedTrend').textContent = '+7%';
            document.getElementById('solvedTrend').className = 'stat-trend trend-up';
        }
        
        // ==================== –ì–†–ê–§–ò–ö–ò ====================
        function createCharts() {
            // –ì—Ä–∞—Ñ–∏–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º
            const requestsCtx = document.getElementById('requestsChart').getContext('2d');
            charts.requests = new Chart(requestsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–û–±—Ä–∞—â–µ–Ω–∏–π',
                        data: [],
                        borderColor: '#0066ff',
                        backgroundColor: 'rgba(0, 100, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#ccccff' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#ccccff' }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º
            const typesCtx = document.getElementById('typesChart').getContext('2d');
            charts.types = new Chart(typesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['–ñ–∞–ª–æ–±—ã', '–ê–ø–µ–ª–ª—è—Ü–∏–∏', '–ü–æ–¥–¥–µ—Ä–∂–∫–∞'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(255, 153, 0, 0.8)',
                            'rgba(0, 153, 255, 0.8)',
                            'rgba(0, 204, 153, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 153, 0, 1)',
                            'rgba(0, 153, 255, 1)',
                            'rgba(0, 204, 153, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#ffffff', font: { size: 14 } }
                        }
                    }
                }
            });
        }
        
        function updateCharts() {
            const tickets = getFilteredTickets();
            
            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –¥–Ω—è–º
            const last7Days = [];
            const dailyCounts = {};
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                last7Days.push(dateStr);
                dailyCounts[dateStr] = 0;
            }
            
            tickets.forEach(ticket => {
                const date = new Date(ticket.timestamp);
                const dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                if (dailyCounts[dateStr] !== undefined) {
                    dailyCounts[dateStr]++;
                }
            });
            
            const dailyData = last7Days.map(day => dailyCounts[day] || 0);
            
            charts.requests.data.labels = last7Days;
            charts.requests.data.datasets[0].data = dailyData;
            charts.requests.update();
            
            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º
            const complaints = tickets.filter(t => t.type === 'complaint').length;
            const appeals = tickets.filter(t => t.type === 'appeal').length;
            const support = tickets.filter(t => t.type === 'support').length;
            
            charts.types.data.datasets[0].data = [complaints, appeals, support];
            charts.types.update();
        }
        
        // ==================== –¢–ê–ë–õ–ò–¶–´ ====================
        function updateTables() {
            const tickets = getFilteredTickets();
            
            // –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä–æ–∫–∏
            const userActivity = {};
            tickets.forEach(ticket => {
                const user = ticket.userNickname || ticket.username;
                if (!userActivity[user]) {
                    userActivity[user] = {
                        count: 0,
                        lastTime: 0
                    };
                }
                userActivity[user].count++;
                if (ticket.timestamp > userActivity[user].lastTime) {
                    userActivity[user].lastTime = ticket.timestamp;
                }
            });
            
            const activeUsers = Object.entries(userActivity)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);
            
            const activeUsersTable = document.querySelector('#activeUsers tbody');
            activeUsersTable.innerHTML = '';
            
            activeUsers.forEach(([user, data]) => {
                const lastDate = new Date(data.lastTime);
                const lastTimeStr = lastDate.toLocaleDateString('ru-RU');
                
                const row = `
                    <tr>
                        <td>${user}</td>
                        <td>${data.count}</td>
                        <td>${lastTimeStr}</td>
                    </tr>
                `;
                activeUsersTable.innerHTML += row;
            });
            
            // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–¥–º–∏–Ω–æ–≤
            const adminStats = {};
            tickets.forEach(ticket => {
                if (ticket.adminName) {
                    if (!adminStats[ticket.adminName]) {
                        adminStats[ticket.adminName] = {
                            count: 0,
                            totalTime: 0
                        };
                    }
                    adminStats[ticket.adminName].count++;
                    if (ticket.answerTime) {
                        adminStats[ticket.adminName].totalTime += (ticket.answerTime - ticket.timestamp);
                    }
                }
            });
            
            const adminActivity = Object.entries(adminStats)
                .sort((a, b) => b[1].count - a[1].count);
            
            const adminTable = document.querySelector('#adminActivity tbody');
            adminTable.innerHTML = '';
            
            adminActivity.forEach(([admin, data]) => {
                const avgTime = data.count > 0 
                    ? Math.floor(data.totalTime / data.count / (1000 * 60)) + '–º'
                    : '0–º';
                
                const row = `
                    <tr>
                        <td>${admin}</td>
                        <td>${data.count}</td>
                        <td>${avgTime}</td>
                    </tr>
                `;
                adminTable.innerHTML += row;
            });
            
            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
            const recentTickets = [...tickets]
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 10);
            
            const recentTable = document.querySelector('#recentTickets tbody');
            recentTable.innerHTML = '';
            
            recentTickets.forEach(ticket => {
                const date = new Date(ticket.timestamp);
                const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                
                const typeText = ticket.type === 'complaint' ? '‚ö†Ô∏è' : 
                                ticket.type === 'appeal' ? '‚öñÔ∏è' : 'üí¨';
                const statusText = ticket.status === 'new' ? 'üÜï' : 
                                 ticket.status === 'answered' ? '‚úÖ' : 'üì®';
                
                const row = `
                    <tr>
                        <td>${ticket.ticketId?.substr(0, 8) || ticket.id.substr(0, 8)}</td>
                        <td>${typeText}</td>
                        <td>${statusText}</td>
                        <td>${timeStr}</td>
                    </tr>
                `;
                recentTable.innerHTML += row;
            });
        }
        
        // ==================== –ó–ê–ü–£–°–ö ====================
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
