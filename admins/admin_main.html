<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë –ì–ª–∞–≤–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å JojoLand</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="admin_common.js"></script> 
    <script src="admin_auth.js"></script>
    <link rel="stylesheet" href="admin_common.css">
    
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞ */
        .login-box {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            border: 2px solid var(--color-accent);
            box-shadow: var(--shadow-deep);
        }
        .login-box h1 {
            color: var(--color-accent);
            margin-bottom: 30px;
        }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #2a2a4d;
            color: white;
            font-size: 16px;
            outline: none;
        }
        .login-box button {
            width: 100%;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <div id="notification-container"></div>
    
    <div id="loginForm" class="login-box" style="display: none;">
        <h1><i class="fas fa-crown"></i> –í—Ö–æ–¥ –≤ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <p style="color: #aaa; margin-bottom: 20px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Firebase Auth.</p>
        <input type="email" id="adminEmail" placeholder="Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" required>
        <input type="password" id="adminPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
        <button id="loginBtn" class="admin-btn admin-btn-primary"><i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏</button>
        <div id="loginMessage" style="color: var(--color-danger); margin-top: 15px;"></div>
    </div>

    <div id="adminContent" class="admin-container" style="display: none;">
        <div id="adminNavPlaceholder"></div>
        
        <div class="page-header">
            <h2 class="admin-section-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="admin-name-main-display" style="color: var(--color-primary);">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>!</h2>
            <p style="margin-bottom: 30px;">–¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è JojoLand. –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            
            <div class="admin-card">
                <h3><i class="fas fa-headset"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
                <p id="support-count" style="font-size: 32px; font-weight: bold; color: var(--color-warning);">0 –æ–±—Ä–∞—â–µ–Ω–∏–π</p>
                <a href="admin_support.html" class="admin-btn admin-btn-primary" style="margin-top: 15px;"><i class="fas fa-external-link-alt"></i> –ü–µ—Ä–µ–π—Ç–∏</a>
            </div>
            
            <div class="admin-card">
                <h3><i class="fas fa-users"></i> –ò–≥—Ä–æ–∫–∏</h3>
                <p id="users-count" style="font-size: 32px; font-weight: bold; color: var(--color-success);">0 –∏–≥—Ä–æ–∫–æ–≤</p>
                <a href="admin_users.html" class="admin-btn admin-btn-primary" style="margin-top: 15px;"><i class="fas fa-external-link-alt"></i> –ü–µ—Ä–µ–π—Ç–∏</a>
            </div>
            
            <div class="admin-card">
                <h3><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <p id="stats-placeholder" style="font-size: 16px; color: #aaa;">–ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç—Ä–µ–Ω–¥—ã</p>
                <a href="admin_stats.html" class="admin-btn admin-btn-primary" style="margin-top: 15px;"><i class="fas fa-external-link-alt"></i> –ü–µ—Ä–µ–π—Ç–∏</a>
            </div>
            
        </div>
        
        <div class="admin-card">
            <h3 class="admin-section-title"><i class="fas fa-clipboard-list"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h3>
            <div id="actions-list" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
                <div style="text-align: center; color: #aaa;">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
            </div>
        </div>
    </div>

    <script>
        function loadNav() {
             fetch('admin_nav.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('adminNavPlaceholder').innerHTML = html;
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:', error));
        }

        async function checkAuthAndLoad() {
            const authStatus = await checkAdminAuth();
            const loginForm = document.getElementById('loginForm');
            const adminContent = document.getElementById('adminContent');
            
            if (authStatus.success) {
                loginForm.style.display = 'none';
                adminContent.style.display = 'block';
                document.getElementById('admin-name-main-display').textContent = authStatus.adminName;
                loadNav();
                loadMainData();
            } else {
                loginForm.style.display = 'block';
                adminContent.style.display = 'none';
            }
        }

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const messageEl = document.getElementById('loginMessage');
            messageEl.textContent = '';

            const result = await adminLogin(email, password);

            if (result.success) {
                createNotification('success', '–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥', result.message);
                checkAuthAndLoad();
            } else {
                messageEl.textContent = result.message;
            }
        });
        
        function loadMainData() {
            database.ref('admin_stats').once('value', snapshot => {
                const stats = snapshot.val();
                if (stats) {
                    document.getElementById('support-count').textContent = `${stats.totalTickets || 0} –æ–±—Ä–∞—â–µ–Ω–∏–π`;
                    document.getElementById('users-count').textContent = `${stats.totalUsers || 0} –∏–≥—Ä–æ–∫–æ–≤`;
                }
            });

            database.ref('admin_actions').limitToLast(10).once('value', snapshot => {
                const actions = [];
                snapshot.forEach(child => actions.push(child.val()));
                actions.reverse();

                const actionsList = document.getElementById('actions-list');
                if (actions.length === 0) {
                    actionsList.innerHTML = `<div style="text-align: center; color: #aaa;">–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π.</div>`;
                    return;
                }

                actionsList.innerHTML = actions.map(action => {
                    const timeStr = formatDate(action.timestamp);
                    return `<div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border-left: 3px solid var(--color-accent);"><div style="display: flex; justify-content: space-between; margin-bottom: 5px; flex-wrap: wrap;"><strong style="color: var(--color-primary);">${action.adminName || '–°–∏—Å—Ç–µ–º–∞'}</strong><small style="color: #aaa; font-size: 12px;">${timeStr}</small></div><div style="color: #ccccff; font-size: 14px;">${action.description || action.action}</div></div>`;
                }).join('');
            });
        }

        document.addEventListener('DOMContentLoaded', checkAuthAndLoad);
    </script>
</body>
</html>
